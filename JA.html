<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalaram Academy | v131 Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #008069; --bg: #e5ddd5; --text: #111b21;
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:#f0f2f5; color:var(--text); height:100vh; display:flex; flex-direction:column; }

        /* HEADER */
        .app-bar { background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        .brand { font-size:18px; font-weight:800; }

        /* SUB NAV */
        .sub-nav { background:white; white-space:nowrap; overflow-x:auto; border-bottom:1px solid #ddd; padding:0 10px; display:none; }
        .sub-tab { display:inline-block; padding:12px 15px; font-size:13px; font-weight:600; color:#54656f; border-bottom:3px solid transparent; cursor:pointer; }
        .sub-tab.active { color:var(--primary); border-color:var(--primary); }

        /* CONTENT */
        .main { flex:1; overflow-y:auto; padding:15px; padding-bottom:80px; }
        .pane { display:none; } .pane.active { display:block; }

        /* CARDS & UI */
        .card { background:white; padding:15px; border-radius:10px; box-shadow:0 1px 2px rgba(0,0,0,0.1); margin-bottom:10px; }
        .row { display:flex; justify-content:space-between; align-items:center; }
        .label { font-size:11px; color:#54656f; font-weight:700; margin-bottom:5px; display:block; text-transform:uppercase; }

        /* INPUTS */
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; font-size:14px; background:white; }
        input:focus { border-color:var(--primary); outline:none; }

        /* BUTTONS */
        .btn { padding:10px; border:none; border-radius:8px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:5px; }
        .btn-main { background:var(--primary); color:white; }
        .btn-sec { background:#e2e8f0; color:#1e293b; }
        .btn-red { background:#fee2e2; color:var(--danger); }
        .btn-sm { width:auto; padding:6px 12px; font-size:12px; }

        /* BOTTOM NAV */
        .bot-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:10px; border-top:1px solid #ddd; }
        .nav-item { text-align:center; font-size:10px; color:#54656f; font-weight:600; width:20%; cursor:pointer; }
        .nav-item.active { color:var(--primary); }

        /* MODALS */
        .modal-ol { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; }
        .modal { background:white; width:90%; max-width:400px; padding:20px; border-radius:12px; max-height:90vh; overflow-y:auto; }
        
        /* EXTRAS */
        #sim-exit { position: fixed; bottom: 85px; right: 20px; background: var(--danger); color: white; padding: 10px 20px; border-radius: 30px; font-weight: 700; z-index: 9999; display: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="sim-exit" onclick="exitSim()">EXIT GOD MODE ‚úï</div>

    <div id="auth" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f0f2f5; z-index:3000; display:flex; align-items:center; justify-content:center;">
        <div class="card" style="width:320px; text-align:center; padding:30px;">
            <div style="font-size:50px;">üéì</div>
            <h2>Jalaram Academy</h2>
            <p style="color:#666; margin-bottom:20px;">Step to Success</p>
            
            <div id="l-form">
                <span class="label" style="text-align:left;">Select Role</span>
                <select id="l-role"><option>Admin</option><option>Teacher</option><option>Student</option></select>
                
                <span class="label" style="text-align:left;">Login ID</span>
                <input id="l-id" placeholder="Enter ID here...">
                
                <span class="label" style="text-align:left;">Password</span>
                <input type="password" id="l-pass" placeholder="Enter Password here...">
                
                <button class="btn btn-main" onclick="login()">Login</button>
                <p style="margin-top:15px; font-size:12px; color:var(--primary); cursor:pointer;" onclick="toggleReg(true)">Create New Account</p>
            </div>

            <div id="r-form" style="display:none; text-align:left;">
                <h3>Register</h3>
                <span class="label">I am a...</span>
                <select id="r-role" onchange="regUI()"><option>Student</option><option>Teacher</option></select>
                
                <span class="label">Full Name</span>
                <input id="r-name" placeholder="Enter Full Name here...">
                
                <div id="r-stu">
                    <span class="label">Student Phone Number</span>
                    <input id="r-sm" type="number" placeholder="Enter Student Mobile...">
                    <span class="label">Parent Phone Number</span>
                    <input id="r-pm" type="number" placeholder="Enter Parent Mobile...">
                </div>
                
                <div id="r-tch" style="display:none;">
                    <span class="label">Phone Number</span>
                    <input id="r-tm" type="number" placeholder="Enter Teacher Mobile...">
                </div>
                
                <span class="label">Set PIN</span>
                <input type="password" id="r-pass" placeholder="Create a 4-digit PIN...">
                
                <button class="btn btn-main" onclick="reg()">Submit Request</button>
                <button class="btn btn-sec" onclick="toggleReg(false)">Back to Login</button>
            </div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div class="app-bar">
            <div class="brand"><span>üéì</span> Jalaram Academy</div>
            <div id="u-chip" style="font-size:10px; background:rgba(255,255,255,0.2); padding:4px 8px; border-radius:10px;">User</div>
        </div>
        
        <div class="sub-nav" id="sub-nav"></div>

        <div class="main">
            
            <div id="pane-admin" class="pane">
                <div id="tab-users" style="display:none;">
                    <input placeholder="üîç Search Users..." onkeyup="renderUsers(this.value)">
                    <span class="label">Students List</span>
                    <div id="list-s"></div>
                    <span class="label" style="margin-top:20px;">Teachers List</span>
                    <div id="list-t"></div>
                </div>
                <div id="tab-appr" style="display:none;">
                    <span class="label">Pending Students</span>
                    <button class="btn btn-sm btn-main" style="float:right; width:auto;" onclick="approveAll('students')">Approve All Students</button>
                    <div style="clear:both; margin-bottom:10px;"></div>
                    <div id="req-s"></div>
                    
                    <span class="label" style="margin-top:20px;">Pending Teachers</span>
                    <button class="btn btn-sm btn-main" style="float:right; width:auto;" onclick="approveAll('teachers')">Approve All Teachers</button>
                    <div style="clear:both; margin-bottom:10px;"></div>
                    <div id="req-t"></div>
                </div>
            </div>

            <div id="pane-batches" class="pane">
                <div id="batch-list"></div>
                <div id="batch-detail" style="display:none;">
                    <button class="btn btn-sm btn-sec" onclick="closeBatch()">‚Üê Back</button>
                    <h2 id="bd-title" style="margin:10px 0;">Batch</h2>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button class="btn btn-sm btn-sec" onclick="tabB('stu')">Students</button>
                        <button class="btn btn-sm btn-sec" onclick="tabB('marks')">Marks</button>
                        <button class="btn btn-sm btn-sec" onclick="tabB('att')">Attendance</button>
                    </div>
                    <div id="bd-content"></div>
                </div>
            </div>

            <div id="pane-profile" class="pane">
                
                <div id="admin-tools" class="card" style="border-left:4px solid var(--warning); display:none;">
                    <h3>‚ö° God Mode (Sim)</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">View app as another user.</p>
                    <div class="row" style="gap:10px;">
                        <button class="btn btn-sec" onclick="sim('Teacher')">Sim Teacher</button>
                        <button class="btn btn-sec" onclick="sim('Student')">Sim Student</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Edit Profile</h3>
                    <span class="label">Your Name</span>
                    <input id="self-n" placeholder="Enter Name here...">
                    <span class="label">Your Mobile / ID</span>
                    <input id="self-m" placeholder="Enter Mobile here...">
                    <span class="label">Change Password</span>
                    <input id="self-p" placeholder="Enter New Password here...">
                    <button class="btn btn-main" onclick="updateSelf()">Update Profile</button>
                </div>

                <button class="btn btn-red" onclick="location.reload()">Logout</button>
            </div>

            <div id="pane-home" class="pane"><div class="card"><h2>Welcome!</h2><div id="home-feed"></div></div></div>
            <div id="pane-store" class="pane"><div class="card"><h3>Upload Material</h3><button class="btn btn-main" onclick="alert('File Upload')">Select File</button></div></div>

        </div>
        <div class="bot-nav" id="bot-nav"></div>
    </div>

    <div id="edit-modal" class="modal-ol"><div class="modal">
        <h3>Edit User Details</h3>
        <input type="hidden" id="ed-key"><input type="hidden" id="ed-type">
        
        <span class="label">Name</span>
        <input id="ed-name">
        
        <div id="ed-stu-fs">
            <span class="label">Student Mobile (S)</span><input id="ed-sm">
            <span class="label">Parent Mobile (P)</span><input id="ed-pm">
            <span class="label">Batch</span><select id="ed-batch"></select>
        </div>
        
        <div id="ed-tch-fs" style="display:none;">
            <span class="label">Mobile Number</span><input id="ed-tm">
        </div>

        <button class="btn btn-main" onclick="saveEdit()">Save Changes</button>
        <button class="btn btn-sec" onclick="document.getElementById('edit-modal').style.display='none'">Cancel</button>
    </div></div>

    <script>
        const LS = localStorage; const KEY = 'v131_final';
        let user = null, realUser = null;
        const BATCHES = ['Class 10 A', 'Class 10 B'];

        if(!LS.getItem(KEY)) {
            LS.setItem(KEY,'true');
            LS.setItem('students', JSON.stringify([{name:'Rohan', s_mob:'1111', p_mob:'', password:'1234', batch:'Class 10 A', status:'Active'}]));
            LS.setItem('teachers', JSON.stringify([{name:'Mr. Sir', mobile:'9999', password:'1234', batches:['Class 10 A'], status:'Active'}]));
        }

        // --- AUTH ---
        function toggleReg(s){ document.getElementById('l-form').style.display=s?'none':'block'; document.getElementById('r-form').style.display=s?'block':'none'; }
        function regUI(){ const isT=document.getElementById('r-role').value==='Teacher'; document.getElementById('r-stu').style.display=isT?'none':'block'; document.getElementById('r-tch').style.display=isT?'block':'none'; }
        
        function reg(){
            const r=document.getElementById('r-role').value; const k=r==='Teacher'?'teachers':'students';
            let l=JSON.parse(LS.getItem(k));
            let o={name:document.getElementById('r-name').value, password:document.getElementById('r-pass').value, status:'Pending'};
            if(r==='Student'){o.s_mob=document.getElementById('r-sm').value; o.p_mob=document.getElementById('r-pm').value; o.batch='Unassigned';}
            else{o.mobile=document.getElementById('r-tm').value;}
            l.push(o); LS.setItem(k,JSON.stringify(l)); alert("Request Sent"); toggleReg(false);
        }

        function login(){
            const id=document.getElementById('l-id').value, p=document.getElementById('l-pass').value, r=document.getElementById('l-role').value;
            if(id==='admin'&&p==='1234'){ user={role:'Admin',name:'Admin'}; init(); return; }
            const k=r==='Teacher'?'teachers':'students';
            let list=JSON.parse(LS.getItem(k));
            let u=list.find(x=>(x.mobile===id||x.s_mob===id||x.p_mob===id)&&x.password===p);
            if(!u) return alert("Invalid");
            user=u; user.role=r; user.key=k; realUser=user; init();
        }

        function init(){
            document.getElementById('auth').style.display='none'; document.getElementById('app').style.display='block';
            document.getElementById('u-chip').innerText=user.name;
            setupNav();
        }

        function setupNav(){
            const nav=document.getElementById('bot-nav'); nav.innerHTML='';
            let items = user.role==='Admin' ? [{i:'pane-admin',l:'Admin'},{i:'pane-batches',l:'Batches'},{i:'pane-profile',l:'Menu'}] :
                        user.role==='Teacher' ? [{i:'pane-home',l:'Home'},{i:'pane-batches',l:'Classes'},{i:'pane-profile',l:'Menu'}] :
                        [{i:'pane-home',l:'Home'},{i:'pane-store',l:'Store'},{i:'pane-profile',l:'Menu'}];
            
            items.forEach(x=>nav.innerHTML+=`<div class="nav-item" onclick="openPane('${x.i}')">${x.l}</div>`);
            
            // Fill Selects
            const bOpts = BATCHES.map(b=>`<option>${b}</option>`).join('');
            if(document.getElementById('ed-batch')) document.getElementById('ed-batch').innerHTML=bOpts;

            openPane(items[0].i);
        }

        function openPane(id){
            document.querySelectorAll('.pane').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active');
            const sn=document.getElementById('sub-nav');
            
            if(id==='pane-admin') {
                sn.style.display='block';
                sn.innerHTML=`<div class="sub-tab active" onclick="admTab('users',this)">Users</div><div class="sub-tab" onclick="admTab('appr',this)">Approvals</div>`;
                admTab('users',sn.firstChild);
            } else if(id==='pane-profile') {
                sn.style.display='none';
                loadProfile();
            } else {
                sn.style.display='none';
            }
            if(id==='pane-batches') loadBatches();
        }

        function admTab(t,el){
            document.querySelectorAll('.sub-tab').forEach(x=>x.classList.remove('active')); el.classList.add('active');
            document.getElementById('tab-users').style.display=t==='users'?'block':'none';
            document.getElementById('tab-appr').style.display=t==='appr'?'block':'none';
            if(t==='users') renderUsers(''); if(t==='appr') renderAppr();
        }

        function renderUsers(q){
            const s=JSON.parse(LS.getItem('students')).filter(u=>u.status==='Active');
            const t=JSON.parse(LS.getItem('teachers')).filter(u=>u.status==='Active');
            document.getElementById('list-s').innerHTML=s.map(u=>`<div class="card row"><b>${u.name}</b> <button class="btn btn-sm btn-sec" onclick="editUser('${u.name}','students')">Edit</button></div>`).join('');
            document.getElementById('list-t').innerHTML=t.map(u=>`<div class="card row"><b>${u.name}</b> <button class="btn btn-sm btn-sec" onclick="editUser('${u.name}','teachers')">Edit</button></div>`).join('');
        }

        function renderAppr(){
            const s=JSON.parse(LS.getItem('students')).filter(u=>u.status==='Pending');
            const t=JSON.parse(LS.getItem('teachers')).filter(u=>u.status==='Pending');
            document.getElementById('req-s').innerHTML=s.length?s.map(u=>`<div class="card row"><b>${u.name}</b> <button class="btn btn-sm btn-sec" onclick="editUser('${u.name}','students')">Review</button></div>`).join(''):'<p>No Students</p>';
            document.getElementById('req-t').innerHTML=t.length?t.map(u=>`<div class="card row"><b>${u.name}</b> <button class="btn btn-sm btn-sec" onclick="editUser('${u.name}','teachers')">Review</button></div>`).join(''):'<p>No Teachers</p>';
        }

        function editUser(n,t){
            const u=JSON.parse(LS.getItem(t)).find(x=>x.name===n);
            document.getElementById('ed-key').value=n; document.getElementById('ed-type').value=t;
            document.getElementById('ed-name').value=u.name;
            document.getElementById('ed-stu-fs').style.display=t==='students'?'block':'none';
            document.getElementById('ed-tch-fs').style.display=t==='teachers'?'block':'none';
            if(t==='students'){document.getElementById('ed-sm').value=u.s_mob;document.getElementById('ed-pm').value=u.p_mob;document.getElementById('ed-batch').value=u.batch;}
            else{document.getElementById('ed-tm').value=u.mobile;}
            document.getElementById('edit-modal').style.display='flex';
        }

        function saveEdit(){
            const t=document.getElementById('ed-type').value, k=document.getElementById('ed-key').value;
            let l=JSON.parse(LS.getItem(t)); let u=l.find(x=>x.name===k);
            u.name=document.getElementById('ed-name').value; u.status='Active';
            if(t==='students'){u.s_mob=document.getElementById('ed-sm').value;u.p_mob=document.getElementById('ed-pm').value;u.batch=document.getElementById('ed-batch').value;}
            else{u.mobile=document.getElementById('ed-tm').value;}
            l[l.indexOf(u)]=u; LS.setItem(t,JSON.stringify(l)); document.getElementById('edit-modal').style.display='none'; renderUsers(''); renderAppr();
        }

        function approveAll(t){ let l=JSON.parse(LS.getItem(t)); l.forEach(u=>u.status='Active'); LS.setItem(t,JSON.stringify(l)); renderAppr(); }

        // PROFILE & SIM
        function loadProfile(){
            document.getElementById('admin-tools').style.display = user.role==='Admin' ? 'block' : 'none';
            document.getElementById('self-n').value = user.name;
            document.getElementById('self-m').value = user.s_mob || user.mobile || '';
            document.getElementById('self-p').value = user.password;
        }
        function updateSelf(){ alert("Profile Updated Successfully"); }
        function sim(r){ document.getElementById('sim-exit').style.display='block'; user={role:r, name:'Sim User', batch:'Class 10 A'}; setupNav(); }
        function exitSim(){ user=realUser; document.getElementById('sim-exit').style.display='none'; location.reload(); }

        // BATCHES STUB
        function loadBatches(){ document.getElementById('batch-list').innerHTML=BATCHES.map(b=>`<div class="card" onclick="openBatch('${b}')"><b>${b}</b></div>`).join(''); document.getElementById('batch-list').style.display='block';document.getElementById('batch-detail').style.display='none';}
        function openBatch(b){ document.getElementById('batch-list').style.display='none';document.getElementById('batch-detail').style.display='block'; document.getElementById('bd-title').innerText=b; document.getElementById('bd-content').innerHTML="<p>Select a tab above</p>"; }
        function closeBatch(){loadBatches();}
        function tabB(m){document.getElementById('bd-content').innerHTML=`<div class="card">Feature: ${m}</div>`;}
    </script>
</body>
</html>

    <div id="auth-portal">
        <div class="auth-card">
            <span class="scholar-cap">üéì</span>
            <h2 style="letter-spacing:-1px;">Jalaram Academy</h2>
            <span class="motto">Step to Success</span>
            <select id="l-role">
                <option value="Admin">Administrator</option>
                <option value="Teacher">Faculty</option>
                <option value="Student">Student / Parent</option>
            </select>
            <input type="text" id="l-id" placeholder="Access ID">
            <input type="password" id="l-pass" placeholder="PIN">
            <button class="btn-auth" onclick="handleLogin()">Authorize</button>
            <p style="margin-top:20px; font-size:12px; cursor:pointer;" onclick="swapAuth('reg')">Request Enrollment</p>
        </div>
        <div class="auth-card" id="reg-box" style="display:none; position:absolute;">
            <h2>Register</h2>
            <select id="r-role" onchange="toggleReg()"><option value="Student">Student</option><option value="Teacher">Teacher</option></select>
            <input type="text" id="r-name" placeholder="Full Name">
            <input type="text" id="r-mob" placeholder="Mobile">
            <input type="password" id="r-pass" placeholder="Set PIN">
            <div id="reg-s-opts"><select id="r-batch"></select></div>
            <div id="reg-t-opts" style="display:none;"><input type="text" id="r-sub" placeholder="Subject"></div>
            <button class="btn-auth" onclick="handleRegister()">Apply</button>
            <p onclick="swapAuth('login')" style="margin-top:20px; cursor:pointer;">‚Üê Back</p>
        </div>
    </div>

    <div id="master-app" class="app-frame">
        <aside class="sidebar">
            <div class="sidebar-brand">Jalaram Academy</div>
            <nav id="nav-links"></nav>
            <div style="margin-top:auto;"><button class="btn-ui btn-danger" style="width:100%" onclick="location.reload()">Terminate</button></div>
        </aside>

        <main class="main-content">
            <div class="user-chip" onclick="openSelfProfile()">
                <div class="avatar" id="avatar-char">?</div>
                <div><div id="display-name" style="font-weight: 800;">User</div><div id="display-role" style="font-size: 0.7rem;">Role</div></div>
            </div>

            <h1 id="page-h1" style="margin-bottom:30px;">Dashboard</h1>

            <div id="adm-approvals" class="pane">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px;">
                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>üéì Students</h3><button class="btn-ui btn-primary" onclick="bulkAppr('students')">Approve All</button>
                        </div>
                        <div class="grid-wrap"><table id="appr-s-table"><thead><tr><th>Name</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>üë©‚Äçüè´ Teachers</h3><button class="btn-ui btn-primary" onclick="bulkAppr('teachers')">Approve All</button>
                        </div>
                        <div class="grid-wrap"><table id="appr-t-table"><thead><tr><th>Name</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="adm-batches" class="pane">
                <div class="glass-card">
                    <h3>Batch Master</h3>
                    <div style="display:flex; gap:10px; margin-top:15px;"><input type="text" id="new-bn" placeholder="Batch Name" style="flex:1;"><button class="btn-ui btn-primary" onclick="addBatch()">Add</button></div>
                    <div style="display:grid; grid-template-columns: 1fr 1.8fr; gap:20px; margin-top:20px;">
                        <div class="grid-wrap"><table id="bn-table"><thead><tr><th>Batch</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                        <div class="glass-card">
                            <h3 id="dict-title">Dictionary</h3>
                            <div class="grid-wrap"><table id="dict-table"><thead><tr><th>Name (Tap for History)</th><th>Attendance</th></tr></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="teacher-sch" class="pane">
                <div class="glass-card">
                    <h3>Quantum Scheduler</h3>
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; margin-top:15px;">
                        <select id="sch-batch"></select><select id="sch-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select><select id="sch-type"><option value="Class">Class (No Buffer)</option><option value="Test">Test (10m Buffer)</option></select>
                        <input type="time" id="sch-start"><input type="number" id="sch-dur" placeholder="Mins" value="60"><input type="text" id="sch-topic" placeholder="Topic">
                    </div>
                    <button class="btn-ui btn-primary" style="width:100%; margin-top:20px;" onclick="validateQuantum()">Secure Slot</button>
                </div>
                <div class="grid-wrap"><table id="t-sch-table"><thead><tr><th>Batch</th><th>Window</th><th>Activity</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="chat-hub" class="pane">
                <div id="chat-list" class="chat-card-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
                <div id="chat-room" class="chat-room" style="display:none;">
                    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><button class="btn-ui btn-primary" onclick="closeChat()">‚Üê Back</button><h3 id="chat-title">Room</h3></div>
                    <div class="chat-scroll" id="main-chat"></div>
                    <div style="padding:20px; border-top:1px solid #eee; display:flex; gap:10px;">
                        <input type="file" id="msg-file" style="display:none;" onchange="alert('Attached')"><button class="btn-ui" onclick="document.getElementById('msg-file').click()">üìé</button>
                        <input type="text" id="msg-in" placeholder="Doubt/Message..." style="flex:1;"><button class="btn-ui btn-primary" onclick="sendMsg()">Send</button>
                    </div>
                </div>
            </div>

            <div id="adm-spy" class="pane">
                <div class="glass-card">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"><select id="spy-b" onchange="runSpy()"></select><select id="spy-s" onchange="runSpy()"></select></div>
                    <div class="chat-room" style="margin-top:20px; height:400px;"><div class="chat-scroll" id="spy-win"></div></div>
                </div>
            </div>

            <div id="adm-users" class="pane">
                <div class="glass-card">
                    <h3>Identity Registry</h3>
                    <input type="hidden" id="edit-idx">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
                        <select id="adm-role" onchange="toggleAdm()"><option value="Student">Student</option><option value="Teacher">Teacher</option></select>
                        <input type="text" id="adm-name" placeholder="Name">
                        <input type="text" id="adm-mob" placeholder="Mobile">
                        <input type="text" id="adm-pass" placeholder="PIN">
                        <div id="adm-s-box"><select id="adm-batch"></select><select id="adm-type"><option value="Student">Student (S)</option><option value="Parent">Parent (P)</option></select></div>
                        <div id="adm-t-box" style="display:none;"><input type="text" id="adm-sub" placeholder="Subjects"></div>
                    </div>
                    <button class="btn-ui btn-primary" style="margin-top:15px;" onclick="saveUserLogic()">Commit Profile</button>
                </div>
                <div class="grid-wrap"><table id="user-table"><thead><tr><th>Identity (Admin Peek S/P)</th><th>Role</th><th>PIN</th><th>Control</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="student-home" class="pane">
                <div class="glass-card" style="background:linear-gradient(135deg, #1e1b4b, #6366f1); color:white;"><h3>My Stats</h3><div style="display:flex; gap:50px; margin-top:15px;"><div><div id="my-m" style="font-size:2.5rem; font-weight:800;">0</div><p>Marks</p></div><div><div id="my-r" style="font-size:2.5rem; font-weight:800;">#--</div><p>Global Rank</p></div></div></div>
                <h3>Leaderboard Top 10</h3><div class="grid-wrap"><table id="s-lead"><thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead><tbody id="s-lead-body"></tbody></table></div>
            </div>

            <div id="self-profile" class="pane">
                <div class="glass-card"><h3>Identity Profile</h3><input type="text" id="self-n" style="width:100%; padding:15px; margin:15px 0; border-radius:15px; border:1px solid #ddd;"><input type="text" id="self-p" style="width:100%; padding:15px; margin-bottom:15px; border-radius:15px; border:1px solid #ddd;"><button class="btn-ui btn-primary" onclick="updateSelf()">Update Identity</button></div>
            </div>

        </main>
    </div>

    <script>
        const LS = localStorage;
        let user = null; let activeC = null;

        function boot() {
            if (!LS.getItem('jalaram_genesis_v31')) {
                LS.setItem('adminUser', 'admin'); LS.setItem('adminPass', '1234');
                LS.setItem('batches', JSON.stringify([{name:'Elite 10'}]));
                LS.setItem('teachers', JSON.stringify([{name:'Mr. Sharma', mobile:'9999', password:'1234', subject:'Maths', status:'Active'}]));
                LS.setItem('students', JSON.stringify([{name:'Rahul', mobile:'1111', password:'1234', batch:'Elite 10', marks:95, status:'Active', type:'Student', history:[]}]));
                LS.setItem('chats', '[]'); LS.setItem('schedules', '[]');
                LS.setItem('jalaram_genesis_v31', 'true');
            }
            refreshSelectors();
        }
        boot();

        function getUName(u) { if (!u.type) return u.name; let tag = u.type === 'Student' ? 'S' : 'P'; return `<span class="p-sym sym-${tag.toLowerCase()}">${tag}</span> ${u.name}`; }

        function handleLogin() {
            const r = document.getElementById('l-role').value; const id = document.getElementById('l-id').value.trim(); const ps = document.getElementById('l-pass').value.trim();
            if(r === 'Admin' && id === 'admin' && ps === '1234') { user = {role:'Admin', name:'Admin', mobile:'admin'}; launch(); return; }
            const k = (r === 'Teacher' ? 'teachers' : 'students');
            const f = JSON.parse(LS.getItem(k)).find(x => x.mobile === id && x.password === ps);
            if(f) { if(f.status === 'Suspended') return alert("Access Revoked."); user = f; user.role = r; launch(); } else alert("Login Failed.");
        }

        function launch() {
            document.getElementById('auth-portal').style.display='none'; document.getElementById('master-app').style.display='grid';
            document.getElementById('display-name').innerText = user.name; document.getElementById('display-role').innerText = user.role; document.getElementById('avatar-char').innerText = user.name[0];
            const nav = document.getElementById('nav-links'); nav.innerHTML = '';
            
            // SIDEBAR LOGIC FIXED: ADM-SPY ONLY FOR ADMIN
            const m = {
                'Admin': [{n:'Identity Hub', t:'adm-users'}, {n:'Approvals', t:'adm-approvals', b:true}, {n:'Batches', t:'adm-batches'}, {n:'Spy Monitor', t:'adm-spy'}],
                'Teacher': [{n:'Scheduler', t:'teacher-sch'}, {n:'Dictionary', t:'adm-batches'}, {n:'Leaderboard', t:'student-home'}, {n:'Chat Hub', t:'chat-hub'}],
                'Student': [{n:'Zenith Home', t:'student-home'}, {n:'Discussions', t:'chat-hub'}]
            };

            m[user.role].forEach(l => {
                const d = document.createElement('div'); d.className='nav-link'; d.innerText=l.n;
                if(l.b) d.innerHTML += `<span class="nav-badge" id="appr-badge">0</span>`;
                d.onclick = () => {
                    document.querySelectorAll('.pane, .nav-link').forEach(x=>x.classList.remove('active'));
                    document.getElementById(l.t).classList.add('active'); d.classList.add('active');
                    if(l.t==='adm-users') drawDB(); if(l.t==='adm-batches') drawBn(); if(l.t==='adm-approvals') drawAppr();
                    if(l.t==='teacher-sch') drawTeacherSch(); if(l.t==='student-home') handleEmotions(); if(l.t==='chat-hub') renderChatGrid();
                };
                nav.appendChild(d);
            });
            nav.firstChild.click();
            setInterval(() => { if(activeC) drawRoom(); if(user.role === 'Admin' && document.getElementById('adm-spy').classList.contains('active')) runSpy(); updateApprBadge(); }, 3000);
        }

        // --- DEEP ANALYTICS ---
        function openAnalytics(mob) {
            const s = JSON.parse(LS.getItem('students')).find(x=>x.mobile===mob);
            document.getElementById('ana-title').innerText = s.name + "'s Academic Deep-Dive";
            const abs = document.getElementById('list-absent'); const e = document.getElementById('list-elite'); const p = document.getElementById('list-progress'); const w = document.getElementById('list-warning');
            abs.innerHTML = e.innerHTML = p.innerHTML = w.innerHTML = '';
            (s.history || []).forEach(h => {
                const item = `<div style="font-size:12px; margin-bottom:5px;"><b>${h.sub}</b>: ${h.topic}</div>`;
                if(h.status === 'Absent') abs.innerHTML += item;
                else {
                    const tag = `<div style="font-size:12px; margin-bottom:5px;"><b>Rank #${h.rank}</b> (${h.sub})</div>`;
                    if(h.rank <= 3) e.innerHTML += tag; else if(h.rank <= 10) p.innerHTML += tag; else w.innerHTML += tag;
                }
            });
            document.getElementById('ana-overlay').style.display='block';
        }

        // --- QUANTUM SCHEDULER (BUFFER LOGIC) ---
        function toMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function toStr(m) { let hh = Math.floor(m / 60); let mm = m % 60; let ap = hh >= 12 ? 'PM' : 'AM'; hh = hh % 12 || 12; return `${hh}:${mm < 10 ? '0'+mm : mm} ${ap}`; }
        function validateQuantum() {
            const bt = document.getElementById('sch-batch').value; const dy = document.getElementById('sch-day').value; const stStr = document.getElementById('sch-start').value;
            const dur = parseInt(document.getElementById('sch-dur').value); const type = document.getElementById('sch-type').value; if(!stStr || !dur) return;
            const start = toMin(stStr); const end = start + dur; const schs = JSON.parse(LS.getItem('schedules'));
            
            // Buffer is 10 if booking a Test OR if there is an existing Test
            const conflict = schs.find(s => {
                if(s.batch !== bt || s.day !== dy) return false;
                const buffer = (type === 'Test' || s.type === 'Test') ? 10 : 0;
                return (start < (s.end + buffer) && (end + buffer) > s.start);
            });

            if(conflict) {
                const bar = document.getElementById('quantum-notifier');
                const nextSafe = conflict.end + (type === 'Test' ? 10 : 0);
                bar.innerHTML = `‚ö†Ô∏è JALARAM ALERT: ${conflict.subject} busy until ${toStr(conflict.end)}. Suggestion: Try after ${toStr(nextSafe)}`;
                bar.style.display = 'block'; setTimeout(()=> bar.style.display='none', 8000); return;
            }
            schs.push({ teacher:user.name, subject:user.subject, batch:bt, day:dy, type, topic:document.getElementById('sch-topic').value, start, end, win:`${toStr(start)} - ${toStr(end)}` });
            LS.setItem('schedules', JSON.stringify(schs)); drawTeacherSch();
        }

        function drawTeacherSch() { const b = document.getElementById('t-sch-table').querySelector('tbody'); b.innerHTML = ''; JSON.parse(LS.getItem('schedules')).filter(x=>x.teacher===user.name).forEach((s, i) => b.innerHTML += `<tr><td>${s.batch}</td><td>${s.win}</td><td>${s.subject}</td><td><button class="btn-ui btn-danger" onclick="delSch(${i})">Del</button></td></tr>`); }
        function delSch(i) { let s=JSON.parse(LS.getItem('schedules')); s.splice(i,1); LS.setItem('schedules', JSON.stringify(s)); drawTeacherSch(); }

        // --- BATCH RENAMING LOGIC FIXED ---
        function addBatch() { let v = document.getElementById('new-bn').value; if(!v) return; let b=JSON.parse(LS.getItem('batches')); b.push({name:v}); LS.setItem('batches', JSON.stringify(b)); drawBn(); refreshSelectors(); }
        function drawBn() {
            const b = JSON.parse(LS.getItem('batches')); const box = document.getElementById('bn-table').querySelector('tbody'); box.innerHTML = '';
            b.forEach((x, i) => {
                let canSee = (user.role === 'Admin');
                if(user.role === 'Teacher') {
                    let sch = JSON.parse(LS.getItem('schedules')||'[]').find(s => s.batch === x.name && s.teacher === user.name);
                    if(sch) canSee = true;
                }
                if(canSee) box.innerHTML += `<tr><td><span style="color:var(--brand); cursor:pointer; font-weight:800;" onclick="viewBnDict('${x.name}')">${x.name}</span></td><td>
                <button class="btn-ui btn-primary" onclick="renBatch(${i})">Ren</button><button class="btn-ui btn-danger" onclick="delBn(${i})">Del</button></td></tr>`;
            });
        }
        function renBatch(i) {
            let b = JSON.parse(LS.getItem('batches')); let old = b[i].name; let n = prompt("New Name:", old);
            if(n && n !== old) {
                b[i].name = n;
                let s = JSON.parse(LS.getItem('students')); s.forEach(st => { if(st.batch === old) st.batch = n; });
                LS.setItem('batches', JSON.stringify(b)); LS.setItem('students', JSON.stringify(s)); drawBn();
            }
        }
        function delBn(i) { let b=JSON.parse(LS.getItem('batches')); b.splice(i,1); LS.setItem('batches', JSON.stringify(b)); drawBn(); }
        function viewBnDict(bn) {
            document.getElementById('dict-title').innerText = bn + " Dictionary";
            const b = document.getElementById('dict-table').querySelector('tbody'); b.innerHTML = '';
            JSON.parse(LS.getItem('students')).filter(x => x.batch === bn).forEach(s => b.innerHTML += `<tr><td style="color:var(--brand); cursor:pointer;" onclick="openAnalytics('${s.mobile}')">${getUName(s)}</td><td>98%</td></tr>`);
        }

        // --- EMOTIONS ---
        function handleEmotions() {
            if(user.role !== 'Student') return;
            let s = JSON.parse(LS.getItem('students')).sort((a,b)=>b.marks - a.marks); const r = s.findIndex(x=>x.mobile === user.mobile) + 1;
            const ov = document.getElementById('rank-overlay'); ov.className = ''; ov.innerHTML = ''; ov.style.display = 'none';
            if(r <= 3) { ov.style.display = 'flex'; ov.style.background = 'rgba(99,102,241,0.95)'; ov.innerHTML = `<h1>üèÜ Rank #${r}<br>Jalaram Academy Zenith! üéâ</h1>`; startParty(); setTimeout(()=>{ov.style.display='none';stopParty();}, 4000); }
            else if (r > 10) { ov.style.display = 'flex'; ov.classList.add('blackout'); ov.innerHTML = `<div style="font-size:100px;">‚òπÔ∏è</div><h1>Study Harder and Focus More</h1>`; setTimeout(()=>ov.style.display='none', 3000); }
            document.getElementById('my-m').innerText = user.marks; document.getElementById('my-r').innerText = "#" + r;
            const tb = document.getElementById('s-lead-body'); tb.innerHTML = ''; s.slice(0,10).forEach((x,i)=> tb.innerHTML+=`<tr><td>#${i+1}</td><td>${x.name}</td><td>${x.marks}</td></tr>`);
        }

        // --- CHAT HUB ---
        function renderChatGrid() {
            const b = document.getElementById('chat-list'); b.innerHTML = ''; b.style.display='grid'; document.getElementById('chat-room').style.display='none';
            let opts = []; if(user.role === 'Teacher') user.subject.split(',').forEach(s => JSON.parse(LS.getItem('batches')).forEach(bn => opts.push({s:s.trim(), b:bn.name})));
            else { let ts=JSON.parse(LS.getItem('teachers')); let subs=[]; ts.forEach(t=>t.subject.split(',').forEach(s=>subs.push(s.trim()))); [...new Set(subs)].forEach(s=>opts.push({s, b:user.batch})); }
            opts.forEach(o => b.innerHTML += `<div class="glass-card" onclick="openChat('${o.s}', '${o.b}')"><h3>${o.s}</h3><p>${o.b}</p></div>`);
        }
        function openChat(s, b) { activeC = {s, b}; document.getElementById('chat-list').style.display='none'; document.getElementById('chat-room').style.display='flex'; document.getElementById('chat-title').innerText = s; drawRoom(); }
        function closeChat() { activeC = null; renderChatGrid(); }
        function sendMsg() { 
            let v = document.getElementById('msg-in').value; let f = document.getElementById('msg-file').files[0]; if(!v && !f) return;
            let c = JSON.parse(LS.getItem('chats')); c.push({sender:user.name, msg:v, hasFile:!!f, fileName:f?f.name:'', sub:activeC.s, batch:activeC.b}); 
            LS.setItem('chats', JSON.stringify(c)); document.getElementById('msg-in').value=''; document.getElementById('msg-file').value=''; drawRoom(); 
        }
        function drawRoom() {
            if(!activeC) return; const box = document.getElementById('main-chat'); const all = JSON.parse(LS.getItem('chats'));
            let h = ''; all.forEach(c => { if(c.sub === activeC.s && (c.batch === activeC.b || c.batch === 'All')) h += `<div class="bubble ${c.sender===user.name?'b-sent':'b-recv'}"><b>${c.sender}:</b><br>${c.msg}${c.hasFile?`<span class="attach-tag">üìé ${c.fileName}</span>`:''}</div>`; });
            if(box.innerHTML !== h) { box.innerHTML = h; box.scrollTop = box.scrollHeight; }
        }

        // --- IDENTITY & CORE ---
        function drawDB() { const b = document.getElementById('user-table').querySelector('tbody'); b.innerHTML = ''; ['teachers','students'].forEach(k => JSON.parse(LS.getItem(k)).forEach((u,i) => b.innerHTML += `<tr><td>${getUName(u)}</td><td>${k}</td><td>${u.password}</td><td><button class="btn-ui btn-primary" onclick="alert('PIN: ${u.password}')">üëÅÔ∏è</button><button class="btn-ui btn-danger" onclick="delU('${k}',${i})">Del</button></td></tr>`)); }
        function delU(k,i) { let l=JSON.parse(LS.getItem(k)); l.splice(i,1); LS.setItem(k,JSON.stringify(l)); drawDB(); }
        function updateSelf() { 
            const n = document.getElementById('self-n').value; const p = document.getElementById('self-p').value;
            if(user.role === 'Admin') { LS.setItem('adminPass', p); }
            else { 
                let k = user.role==='Teacher'?'teachers':'students'; let l = JSON.parse(LS.getItem(k));
                let idx = l.findIndex(x=>x.mobile === user.mobile); l[idx].name = n; l[idx].password = p; LS.setItem(k, JSON.stringify(l));
            }
            alert("Updated!"); location.reload(); 
        }

        function runSpy() {
            const bt=document.getElementById('spy-b').value; const sb=document.getElementById('spy-s').value; const win=document.getElementById('spy-win');
            const c=JSON.parse(LS.getItem('chats')); const s=JSON.parse(LS.getItem('students')); let h='';
            c.forEach(x=>{ if(x.batch===bt && x.sub===sb){ let st=s.find(z=>z.name===x.sender); h+=`<div class="bubble b-recv"><b>${st?getUName(st):x.sender}:</b><br>${x.msg}</div>`; } });
            if(win.innerHTML!==h){ win.innerHTML=h; win.scrollTop=win.scrollHeight; }
        }
        function drawAppr() {
            const sb = document.getElementById('appr-s-table').querySelector('tbody'); const tb = document.getElementById('appr-t-table').querySelector('tbody');
            sb.innerHTML = ''; tb.innerHTML = ''; 
            JSON.parse(LS.getItem('students')).forEach((u, i) => { if(u.status === 'Pending') sb.innerHTML += `<tr><td>${u.name}</td><td><button class="btn-ui btn-primary" onclick="apprX('students', ${i})">Approve</button></td></tr>`; });
            JSON.parse(LS.getItem('teachers')).forEach((u, i) => { if(u.status === 'Pending') tb.innerHTML += `<tr><td>${u.name}</td><td><button class="btn-ui btn-primary" onclick="apprX('teachers', ${i})">Approve</button></td></tr>`; });
        }
        function apprX(k, i) { let l = JSON.parse(LS.getItem(k)); l[i].status = 'Active'; LS.setItem(k, JSON.stringify(l)); drawAppr(); }
        function bulkAppr(k) { let l = JSON.parse(LS.getItem(k)); l.forEach(u => u.status='Active'); LS.setItem(k, JSON.stringify(l)); drawAppr(); }
        function updateApprBadge() {
            let count = JSON.parse(LS.getItem('students')).filter(u=>u.status==='Pending').length + JSON.parse(LS.getItem('teachers')).filter(u=>u.status==='Pending').length;
            const b = document.getElementById('appr-badge'); if(b) { b.innerText = count; b.style.display = count===0?'none':'inline-block'; }
        }

        let pC = document.getElementById('party-canvas'); let pX = pC.getContext('2d'); let pS = [];
        function startParty() { pC.width = window.innerWidth; pC.height = window.innerHeight; for(let i=0; i<100; i++) pS.push({x:Math.random()*pC.width, y:Math.random()*pC.height, r:Math.random()*4+1, c:`hsl(${Math.random()*360},70%,60%)`, v:Math.random()*3+2}); ani(); }
        function ani() { pX.clearRect(0,0,pC.width,pC.height); pS.forEach(p => { p.y += p.v; if(p.y > pC.height) p.y = -10; pX.fillStyle=p.c; pX.beginPath(); pX.arc(p.x,p.y,p.r,0,Math.PI*2); pX.fill(); }); if(pS.length) requestAnimationFrame(ani); }
        function stopParty() { pS = []; pX.clearRect(0,0,pC.width,pC.height); }

        function refreshSelectors() {
            const bt = JSON.parse(LS.getItem('batches')); const h = bt.map(x=>`<option value="${x.name}">${x.name}</option>`).join('');
            ['sch-batch', 'r-batch', 'spy-b'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = h; });
            let ts=JSON.parse(LS.getItem('teachers')); let subs=[]; ts.forEach(t=>t.subject.split(',').forEach(s=>subs.push(s.trim())));
            if(document.getElementById('spy-s')) document.getElementById('spy-s').innerHTML = [...new Set(subs)].map(x=>`<option value="${x}">${x}</option>`).join('');
        }
        function swapAuth(m) { document.getElementById('auth-portal').style.display = m === 'login' ? 'block' : 'none'; document.getElementById('reg-box').style.display = m === 'reg' ? 'block' : 'none'; }
        function toggleReg() { let isT = document.getElementById('r-role').value === 'Teacher'; document.getElementById('reg-s-opts').style.display = isT ? 'none' : 'block'; document.getElementById('reg-t-opts').style.display = isT ? 'block' : 'none'; }
        function handleRegister() {
            const r = document.getElementById('r-role').value; const k = r === 'Student' ? 'students' : 'teachers';
            let l = JSON.parse(LS.getItem(k)); let obj = { name: document.getElementById('r-name').value, mobile: document.getElementById('r-mob').value.trim(), password: document.getElementById('r-pass').value.trim(), status: 'Pending' };
            if(r === 'Student') { obj.batch = document.getElementById('r-batch').value; obj.marks = 0; obj.type = 'Student'; obj.history=[]; } else obj.subject = document.getElementById('r-sub').value;
            l.push(obj); LS.setItem(k, JSON.stringify(l)); location.reload();
        }
    </script>
</body>

</html>

