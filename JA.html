<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jalaram Academy | Genesis v31</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand: #6366f1; --sidebar: #0f172a; --bg: #f8fafc;
            --success: #10b981; --danger: #f43f5e; --warning: #f59e0b;
            --text-main: #1e293b; --text-muted: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.2s ease; }
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* --- NOTIFIER & RANK OVERLAYS --- */
        #quantum-notifier { position: fixed; top: 0; left: 0; width: 100%; padding: 18px; background: var(--danger); color: white; font-weight: 700; z-index: 50000; display: none; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        #rank-overlay { position: fixed; top:0; left:0; width:100%; height:100%; z-index:49999; display:none; justify-content:center; align-items:center; text-align:center; color:white; }
        .blackout { background: #000 !important; flex-direction: column; }
        .party-canvas { position: fixed; top: 0; left: 0; pointer-events: none; width: 100%; height: 100%; z-index: 50001; }

        /* --- DEEP DIVE ANALYTICS OVERLAY --- */
        #ana-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); z-index: 45000; display: none; padding: 40px; color: white; overflow-y: auto; }
        .ana-container { max-width: 1200px; margin: 0 auto; }
        .ana-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .ana-sub-split { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; }
        .ana-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .ana-box h4 { font-size: 0.8rem; color: var(--brand); margin-bottom: 10px; text-transform: uppercase; }

        /* --- AUTH --- */
        #auth-portal { height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at top right, #1e1b4b, #0f172a); }
        .auth-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 45px; border-radius: 40px; width: 100%; max-width: 440px; text-align: center; box-shadow: 0 40px 100px rgba(0,0,0,0.5); }
        .scholar-cap { font-size: 50px; display: block; margin-bottom: 5px; }
        .motto { color: var(--brand); font-weight: 700; font-size: 0.8rem; letter-spacing: 1px; margin-bottom: 25px; display: block; }
        .auth-card input, .auth-card select { width: 100%; padding: 15px; margin: 8px 0; border: 1.5px solid #e2e8f0; border-radius: 15px; outline: none; }
        .btn-auth { width: 100%; padding: 18px; background: var(--brand); color: white; border: none; border-radius: 18px; font-weight: 700; cursor: pointer; }

        /* --- LAYOUT --- */
        .app-frame { display: none; grid-template-columns: 280px 1fr; height: 100vh; }
        .sidebar { background: var(--sidebar); padding: 30px 20px; display: flex; flex-direction: column; }
        .sidebar-brand { color: white; font-size: 1.2rem; font-weight: 800; margin-bottom: 40px; }
        .nav-link { padding: 15px 18px; margin-bottom: 6px; cursor: pointer; border-radius: 15px; color: #94a3b8; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .nav-link.active { background: var(--brand); color: white; }
        .nav-badge { background: var(--danger); color: white; font-size: 10px; padding: 2px 7px; border-radius: 10px; font-weight: 800; }

        .main-content { padding: 40px; overflow-y: auto; position: relative; }
        .user-chip { position: absolute; top: 30px; right: 40px; background: white; padding: 10px 20px; border-radius: 30px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 12px; z-index: 100; cursor: pointer; }
        .avatar { width: 36px; height: 36px; background: var(--brand); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; }

        /* --- COMPONENTS --- */
        .glass-card { background: white; border-radius: 30px; padding: 30px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.02); margin-bottom: 30px; }
        .grid-wrap { border-radius: 20px; border: 1px solid #e2e8f0; overflow: hidden; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 0.7rem; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid #f1f5f9; font-size: 0.9rem; font-weight: 600; }
        
        .p-sym { font-weight: 900; padding: 3px 6px; border-radius: 6px; font-size: 9px; margin-right: 8px; }
        .sym-s { background: #e0f2fe; color: #0369a1; }
        .sym-p { background: #ffedd5; color: #9a3412; }

        /* --- CHAT --- */
        .chat-room { height: 500px; display: flex; flex-direction: column; background: white; border-radius: 35px; border: 1px solid #e2e8f0; overflow: hidden; }
        .chat-scroll { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 12px; background: #fcfcfd; }
        .bubble { max-width: 75%; padding: 14px 20px; border-radius: 22px; font-size: 0.95rem; }
        .b-sent { align-self: flex-end; background: var(--brand); color: white; }
        .b-recv { align-self: flex-start; background: #f1f5f9; }
        .attach-tag { display: block; font-size: 10px; color: var(--brand); font-weight: 700; margin-top: 5px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 5px; }

        .btn-ui { padding: 8px 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 0.75rem; margin: 2px; }
        .btn-primary { background: var(--brand); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        .pane { display: none; }
        .pane.active { display: block; animation: paneFade 0.4s ease; }
        @keyframes paneFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="quantum-notifier"></div>
    <div id="rank-overlay"></div>
    <canvas id="party-canvas" class="party-canvas"></canvas>

    <div id="ana-overlay">
        <div class="ana-container">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 id="ana-title">History</h1>
                <button class="btn-ui btn-danger" onclick="document.getElementById('ana-overlay').style.display='none'">Close</button>
            </div>
            <div class="ana-split">
                <div class="ana-box" style="border-top: 4px solid var(--danger);">
                    <h4>üõë Absent History</h4>
                    <div id="list-absent"></div>
                </div>
                <div class="ana-box" style="border-top: 4px solid var(--success);">
                    <h4>‚úÖ Present History</h4>
                    <div class="ana-sub-split">
                        <div class="ana-box"><h4>ü•á Elite (1-3)</h4><div id="list-elite"></div></div>
                        <div class="ana-box"><h4>üìà Progress (4-10)</h4><div id="list-progress"></div></div>
                        <div class="ana-box"><h4>‚ö†Ô∏è Warning (11+)</h4><div id="list-warning"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="auth-portal">
        <div class="auth-card">
            <span class="scholar-cap">üéì</span>
            <h2 style="letter-spacing:-1px;">Jalaram Academy</h2>
            <span class="motto">Step to Success</span>
            <select id="l-role">
                <option value="Admin">Administrator</option>
                <option value="Teacher">Faculty</option>
                <option value="Student">Student / Parent</option>
            </select>
            <input type="text" id="l-id" placeholder="Access ID">
            <input type="password" id="l-pass" placeholder="PIN">
            <button class="btn-auth" onclick="handleLogin()">Authorize</button>
            <p style="margin-top:20px; font-size:12px; cursor:pointer;" onclick="swapAuth('reg')">Request Enrollment</p>
        </div>
        <div class="auth-card" id="reg-box" style="display:none; position:absolute;">
            <h2>Register</h2>
            <select id="r-role" onchange="toggleReg()"><option value="Student">Student</option><option value="Teacher">Teacher</option></select>
            <input type="text" id="r-name" placeholder="Full Name">
            <input type="text" id="r-mob" placeholder="Mobile">
            <input type="password" id="r-pass" placeholder="Set PIN">
            <div id="reg-s-opts"><select id="r-batch"></select></div>
            <div id="reg-t-opts" style="display:none;"><input type="text" id="r-sub" placeholder="Subject"></div>
            <button class="btn-auth" onclick="handleRegister()">Apply</button>
            <p onclick="swapAuth('login')" style="margin-top:20px; cursor:pointer;">‚Üê Back</p>
        </div>
    </div>

    <div id="master-app" class="app-frame">
        <aside class="sidebar">
            <div class="sidebar-brand">Jalaram Academy</div>
            <nav id="nav-links"></nav>
            <div style="margin-top:auto;"><button class="btn-ui btn-danger" style="width:100%" onclick="location.reload()">Terminate</button></div>
        </aside>

        <main class="main-content">
            <div class="user-chip" onclick="openSelfProfile()">
                <div class="avatar" id="avatar-char">?</div>
                <div><div id="display-name" style="font-weight: 800;">User</div><div id="display-role" style="font-size: 0.7rem;">Role</div></div>
            </div>

            <h1 id="page-h1" style="margin-bottom:30px;">Dashboard</h1>

            <div id="adm-approvals" class="pane">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px;">
                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>üéì Students</h3><button class="btn-ui btn-primary" onclick="bulkAppr('students')">Approve All</button>
                        </div>
                        <div class="grid-wrap"><table id="appr-s-table"><thead><tr><th>Name</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3>üë©‚Äçüè´ Teachers</h3><button class="btn-ui btn-primary" onclick="bulkAppr('teachers')">Approve All</button>
                        </div>
                        <div class="grid-wrap"><table id="appr-t-table"><thead><tr><th>Name</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="adm-batches" class="pane">
                <div class="glass-card">
                    <h3>Batch Master</h3>
                    <div style="display:flex; gap:10px; margin-top:15px;"><input type="text" id="new-bn" placeholder="Batch Name" style="flex:1;"><button class="btn-ui btn-primary" onclick="addBatch()">Add</button></div>
                    <div style="display:grid; grid-template-columns: 1fr 1.8fr; gap:20px; margin-top:20px;">
                        <div class="grid-wrap"><table id="bn-table"><thead><tr><th>Batch</th><th>Action</th></tr></thead><tbody></tbody></table></div>
                        <div class="glass-card">
                            <h3 id="dict-title">Dictionary</h3>
                            <div class="grid-wrap"><table id="dict-table"><thead><tr><th>Name (Tap for History)</th><th>Attendance</th></tr></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="teacher-sch" class="pane">
                <div class="glass-card">
                    <h3>Quantum Scheduler</h3>
                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; margin-top:15px;">
                        <select id="sch-batch"></select><select id="sch-day"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option></select><select id="sch-type"><option value="Class">Class (No Buffer)</option><option value="Test">Test (10m Buffer)</option></select>
                        <input type="time" id="sch-start"><input type="number" id="sch-dur" placeholder="Mins" value="60"><input type="text" id="sch-topic" placeholder="Topic">
                    </div>
                    <button class="btn-ui btn-primary" style="width:100%; margin-top:20px;" onclick="validateQuantum()">Secure Slot</button>
                </div>
                <div class="grid-wrap"><table id="t-sch-table"><thead><tr><th>Batch</th><th>Window</th><th>Activity</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="chat-hub" class="pane">
                <div id="chat-list" class="chat-card-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;"></div>
                <div id="chat-room" class="chat-room" style="display:none;">
                    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><button class="btn-ui btn-primary" onclick="closeChat()">‚Üê Back</button><h3 id="chat-title">Room</h3></div>
                    <div class="chat-scroll" id="main-chat"></div>
                    <div style="padding:20px; border-top:1px solid #eee; display:flex; gap:10px;">
                        <input type="file" id="msg-file" style="display:none;" onchange="alert('Attached')"><button class="btn-ui" onclick="document.getElementById('msg-file').click()">üìé</button>
                        <input type="text" id="msg-in" placeholder="Doubt/Message..." style="flex:1;"><button class="btn-ui btn-primary" onclick="sendMsg()">Send</button>
                    </div>
                </div>
            </div>

            <div id="adm-spy" class="pane">
                <div class="glass-card">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"><select id="spy-b" onchange="runSpy()"></select><select id="spy-s" onchange="runSpy()"></select></div>
                    <div class="chat-room" style="margin-top:20px; height:400px;"><div class="chat-scroll" id="spy-win"></div></div>
                </div>
            </div>

            <div id="adm-users" class="pane">
                <div class="glass-card">
                    <h3>Identity Registry</h3>
                    <input type="hidden" id="edit-idx">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px;">
                        <select id="adm-role" onchange="toggleAdm()"><option value="Student">Student</option><option value="Teacher">Teacher</option></select>
                        <input type="text" id="adm-name" placeholder="Name">
                        <input type="text" id="adm-mob" placeholder="Mobile">
                        <input type="text" id="adm-pass" placeholder="PIN">
                        <div id="adm-s-box"><select id="adm-batch"></select><select id="adm-type"><option value="Student">Student (S)</option><option value="Parent">Parent (P)</option></select></div>
                        <div id="adm-t-box" style="display:none;"><input type="text" id="adm-sub" placeholder="Subjects"></div>
                    </div>
                    <button class="btn-ui btn-primary" style="margin-top:15px;" onclick="saveUserLogic()">Commit Profile</button>
                </div>
                <div class="grid-wrap"><table id="user-table"><thead><tr><th>Identity (Admin Peek S/P)</th><th>Role</th><th>PIN</th><th>Control</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="student-home" class="pane">
                <div class="glass-card" style="background:linear-gradient(135deg, #1e1b4b, #6366f1); color:white;"><h3>My Stats</h3><div style="display:flex; gap:50px; margin-top:15px;"><div><div id="my-m" style="font-size:2.5rem; font-weight:800;">0</div><p>Marks</p></div><div><div id="my-r" style="font-size:2.5rem; font-weight:800;">#--</div><p>Global Rank</p></div></div></div>
                <h3>Leaderboard Top 10</h3><div class="grid-wrap"><table id="s-lead"><thead><tr><th>Rank</th><th>Name</th><th>Score</th></tr></thead><tbody id="s-lead-body"></tbody></table></div>
            </div>

            <div id="self-profile" class="pane">
                <div class="glass-card"><h3>Identity Profile</h3><input type="text" id="self-n" style="width:100%; padding:15px; margin:15px 0; border-radius:15px; border:1px solid #ddd;"><input type="text" id="self-p" style="width:100%; padding:15px; margin-bottom:15px; border-radius:15px; border:1px solid #ddd;"><button class="btn-ui btn-primary" onclick="updateSelf()">Update Identity</button></div>
            </div>

        </main>
    </div>

    <script>
        const LS = localStorage;
        let user = null; let activeC = null;

        function boot() {
            if (!LS.getItem('jalaram_genesis_v31')) {
                LS.setItem('adminUser', 'admin'); LS.setItem('adminPass', '1234');
                LS.setItem('batches', JSON.stringify([{name:'Elite 10'}]));
                LS.setItem('teachers', JSON.stringify([{name:'Mr. Sharma', mobile:'9999', password:'1234', subject:'Maths', status:'Active'}]));
                LS.setItem('students', JSON.stringify([{name:'Rahul', mobile:'1111', password:'1234', batch:'Elite 10', marks:95, status:'Active', type:'Student', history:[]}]));
                LS.setItem('chats', '[]'); LS.setItem('schedules', '[]');
                LS.setItem('jalaram_genesis_v31', 'true');
            }
            refreshSelectors();
        }
        boot();

        function getUName(u) { if (!u.type) return u.name; let tag = u.type === 'Student' ? 'S' : 'P'; return `<span class="p-sym sym-${tag.toLowerCase()}">${tag}</span> ${u.name}`; }

        function handleLogin() {
            const r = document.getElementById('l-role').value; const id = document.getElementById('l-id').value.trim(); const ps = document.getElementById('l-pass').value.trim();
            if(r === 'Admin' && id === 'admin' && ps === '1234') { user = {role:'Admin', name:'Admin', mobile:'admin'}; launch(); return; }
            const k = (r === 'Teacher' ? 'teachers' : 'students');
            const f = JSON.parse(LS.getItem(k)).find(x => x.mobile === id && x.password === ps);
            if(f) { if(f.status === 'Suspended') return alert("Access Revoked."); user = f; user.role = r; launch(); } else alert("Login Failed.");
        }

        function launch() {
            document.getElementById('auth-portal').style.display='none'; document.getElementById('master-app').style.display='grid';
            document.getElementById('display-name').innerText = user.name; document.getElementById('display-role').innerText = user.role; document.getElementById('avatar-char').innerText = user.name[0];
            const nav = document.getElementById('nav-links'); nav.innerHTML = '';
            
            // SIDEBAR LOGIC FIXED: ADM-SPY ONLY FOR ADMIN
            const m = {
                'Admin': [{n:'Identity Hub', t:'adm-users'}, {n:'Approvals', t:'adm-approvals', b:true}, {n:'Batches', t:'adm-batches'}, {n:'Spy Monitor', t:'adm-spy'}],
                'Teacher': [{n:'Scheduler', t:'teacher-sch'}, {n:'Dictionary', t:'adm-batches'}, {n:'Leaderboard', t:'student-home'}, {n:'Chat Hub', t:'chat-hub'}],
                'Student': [{n:'Zenith Home', t:'student-home'}, {n:'Discussions', t:'chat-hub'}]
            };

            m[user.role].forEach(l => {
                const d = document.createElement('div'); d.className='nav-link'; d.innerText=l.n;
                if(l.b) d.innerHTML += `<span class="nav-badge" id="appr-badge">0</span>`;
                d.onclick = () => {
                    document.querySelectorAll('.pane, .nav-link').forEach(x=>x.classList.remove('active'));
                    document.getElementById(l.t).classList.add('active'); d.classList.add('active');
                    if(l.t==='adm-users') drawDB(); if(l.t==='adm-batches') drawBn(); if(l.t==='adm-approvals') drawAppr();
                    if(l.t==='teacher-sch') drawTeacherSch(); if(l.t==='student-home') handleEmotions(); if(l.t==='chat-hub') renderChatGrid();
                };
                nav.appendChild(d);
            });
            nav.firstChild.click();
            setInterval(() => { if(activeC) drawRoom(); if(user.role === 'Admin' && document.getElementById('adm-spy').classList.contains('active')) runSpy(); updateApprBadge(); }, 3000);
        }

        // --- DEEP ANALYTICS ---
        function openAnalytics(mob) {
            const s = JSON.parse(LS.getItem('students')).find(x=>x.mobile===mob);
            document.getElementById('ana-title').innerText = s.name + "'s Academic Deep-Dive";
            const abs = document.getElementById('list-absent'); const e = document.getElementById('list-elite'); const p = document.getElementById('list-progress'); const w = document.getElementById('list-warning');
            abs.innerHTML = e.innerHTML = p.innerHTML = w.innerHTML = '';
            (s.history || []).forEach(h => {
                const item = `<div style="font-size:12px; margin-bottom:5px;"><b>${h.sub}</b>: ${h.topic}</div>`;
                if(h.status === 'Absent') abs.innerHTML += item;
                else {
                    const tag = `<div style="font-size:12px; margin-bottom:5px;"><b>Rank #${h.rank}</b> (${h.sub})</div>`;
                    if(h.rank <= 3) e.innerHTML += tag; else if(h.rank <= 10) p.innerHTML += tag; else w.innerHTML += tag;
                }
            });
            document.getElementById('ana-overlay').style.display='block';
        }

        // --- QUANTUM SCHEDULER (BUFFER LOGIC) ---
        function toMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function toStr(m) { let hh = Math.floor(m / 60); let mm = m % 60; let ap = hh >= 12 ? 'PM' : 'AM'; hh = hh % 12 || 12; return `${hh}:${mm < 10 ? '0'+mm : mm} ${ap}`; }
        function validateQuantum() {
            const bt = document.getElementById('sch-batch').value; const dy = document.getElementById('sch-day').value; const stStr = document.getElementById('sch-start').value;
            const dur = parseInt(document.getElementById('sch-dur').value); const type = document.getElementById('sch-type').value; if(!stStr || !dur) return;
            const start = toMin(stStr); const end = start + dur; const schs = JSON.parse(LS.getItem('schedules'));
            
            // Buffer is 10 if booking a Test OR if there is an existing Test
            const conflict = schs.find(s => {
                if(s.batch !== bt || s.day !== dy) return false;
                const buffer = (type === 'Test' || s.type === 'Test') ? 10 : 0;
                return (start < (s.end + buffer) && (end + buffer) > s.start);
            });

            if(conflict) {
                const bar = document.getElementById('quantum-notifier');
                const nextSafe = conflict.end + (type === 'Test' ? 10 : 0);
                bar.innerHTML = `‚ö†Ô∏è JALARAM ALERT: ${conflict.subject} busy until ${toStr(conflict.end)}. Suggestion: Try after ${toStr(nextSafe)}`;
                bar.style.display = 'block'; setTimeout(()=> bar.style.display='none', 8000); return;
            }
            schs.push({ teacher:user.name, subject:user.subject, batch:bt, day:dy, type, topic:document.getElementById('sch-topic').value, start, end, win:`${toStr(start)} - ${toStr(end)}` });
            LS.setItem('schedules', JSON.stringify(schs)); drawTeacherSch();
        }

        function drawTeacherSch() { const b = document.getElementById('t-sch-table').querySelector('tbody'); b.innerHTML = ''; JSON.parse(LS.getItem('schedules')).filter(x=>x.teacher===user.name).forEach((s, i) => b.innerHTML += `<tr><td>${s.batch}</td><td>${s.win}</td><td>${s.subject}</td><td><button class="btn-ui btn-danger" onclick="delSch(${i})">Del</button></td></tr>`); }
        function delSch(i) { let s=JSON.parse(LS.getItem('schedules')); s.splice(i,1); LS.setItem('schedules', JSON.stringify(s)); drawTeacherSch(); }

        // --- BATCH RENAMING LOGIC FIXED ---
        function addBatch() { let v = document.getElementById('new-bn').value; if(!v) return; let b=JSON.parse(LS.getItem('batches')); b.push({name:v}); LS.setItem('batches', JSON.stringify(b)); drawBn(); refreshSelectors(); }
        function drawBn() {
            const b = JSON.parse(LS.getItem('batches')); const box = document.getElementById('bn-table').querySelector('tbody'); box.innerHTML = '';
            b.forEach((x, i) => {
                let canSee = (user.role === 'Admin');
                if(user.role === 'Teacher') {
                    let sch = JSON.parse(LS.getItem('schedules')||'[]').find(s => s.batch === x.name && s.teacher === user.name);
                    if(sch) canSee = true;
                }
                if(canSee) box.innerHTML += `<tr><td><span style="color:var(--brand); cursor:pointer; font-weight:800;" onclick="viewBnDict('${x.name}')">${x.name}</span></td><td>
                <button class="btn-ui btn-primary" onclick="renBatch(${i})">Ren</button><button class="btn-ui btn-danger" onclick="delBn(${i})">Del</button></td></tr>`;
            });
        }
        function renBatch(i) {
            let b = JSON.parse(LS.getItem('batches')); let old = b[i].name; let n = prompt("New Name:", old);
            if(n && n !== old) {
                b[i].name = n;
                let s = JSON.parse(LS.getItem('students')); s.forEach(st => { if(st.batch === old) st.batch = n; });
                LS.setItem('batches', JSON.stringify(b)); LS.setItem('students', JSON.stringify(s)); drawBn();
            }
        }
        function delBn(i) { let b=JSON.parse(LS.getItem('batches')); b.splice(i,1); LS.setItem('batches', JSON.stringify(b)); drawBn(); }
        function viewBnDict(bn) {
            document.getElementById('dict-title').innerText = bn + " Dictionary";
            const b = document.getElementById('dict-table').querySelector('tbody'); b.innerHTML = '';
            JSON.parse(LS.getItem('students')).filter(x => x.batch === bn).forEach(s => b.innerHTML += `<tr><td style="color:var(--brand); cursor:pointer;" onclick="openAnalytics('${s.mobile}')">${getUName(s)}</td><td>98%</td></tr>`);
        }

        // --- EMOTIONS ---
        function handleEmotions() {
            if(user.role !== 'Student') return;
            let s = JSON.parse(LS.getItem('students')).sort((a,b)=>b.marks - a.marks); const r = s.findIndex(x=>x.mobile === user.mobile) + 1;
            const ov = document.getElementById('rank-overlay'); ov.className = ''; ov.innerHTML = ''; ov.style.display = 'none';
            if(r <= 3) { ov.style.display = 'flex'; ov.style.background = 'rgba(99,102,241,0.95)'; ov.innerHTML = `<h1>üèÜ Rank #${r}<br>Jalaram Academy Zenith! üéâ</h1>`; startParty(); setTimeout(()=>{ov.style.display='none';stopParty();}, 4000); }
            else if (r > 10) { ov.style.display = 'flex'; ov.classList.add('blackout'); ov.innerHTML = `<div style="font-size:100px;">‚òπÔ∏è</div><h1>Study Harder and Focus More</h1>`; setTimeout(()=>ov.style.display='none', 3000); }
            document.getElementById('my-m').innerText = user.marks; document.getElementById('my-r').innerText = "#" + r;
            const tb = document.getElementById('s-lead-body'); tb.innerHTML = ''; s.slice(0,10).forEach((x,i)=> tb.innerHTML+=`<tr><td>#${i+1}</td><td>${x.name}</td><td>${x.marks}</td></tr>`);
        }

        // --- CHAT HUB ---
        function renderChatGrid() {
            const b = document.getElementById('chat-list'); b.innerHTML = ''; b.style.display='grid'; document.getElementById('chat-room').style.display='none';
            let opts = []; if(user.role === 'Teacher') user.subject.split(',').forEach(s => JSON.parse(LS.getItem('batches')).forEach(bn => opts.push({s:s.trim(), b:bn.name})));
            else { let ts=JSON.parse(LS.getItem('teachers')); let subs=[]; ts.forEach(t=>t.subject.split(',').forEach(s=>subs.push(s.trim()))); [...new Set(subs)].forEach(s=>opts.push({s, b:user.batch})); }
            opts.forEach(o => b.innerHTML += `<div class="glass-card" onclick="openChat('${o.s}', '${o.b}')"><h3>${o.s}</h3><p>${o.b}</p></div>`);
        }
        function openChat(s, b) { activeC = {s, b}; document.getElementById('chat-list').style.display='none'; document.getElementById('chat-room').style.display='flex'; document.getElementById('chat-title').innerText = s; drawRoom(); }
        function closeChat() { activeC = null; renderChatGrid(); }
        function sendMsg() { 
            let v = document.getElementById('msg-in').value; let f = document.getElementById('msg-file').files[0]; if(!v && !f) return;
            let c = JSON.parse(LS.getItem('chats')); c.push({sender:user.name, msg:v, hasFile:!!f, fileName:f?f.name:'', sub:activeC.s, batch:activeC.b}); 
            LS.setItem('chats', JSON.stringify(c)); document.getElementById('msg-in').value=''; document.getElementById('msg-file').value=''; drawRoom(); 
        }
        function drawRoom() {
            if(!activeC) return; const box = document.getElementById('main-chat'); const all = JSON.parse(LS.getItem('chats'));
            let h = ''; all.forEach(c => { if(c.sub === activeC.s && (c.batch === activeC.b || c.batch === 'All')) h += `<div class="bubble ${c.sender===user.name?'b-sent':'b-recv'}"><b>${c.sender}:</b><br>${c.msg}${c.hasFile?`<span class="attach-tag">üìé ${c.fileName}</span>`:''}</div>`; });
            if(box.innerHTML !== h) { box.innerHTML = h; box.scrollTop = box.scrollHeight; }
        }

        // --- IDENTITY & CORE ---
        function drawDB() { const b = document.getElementById('user-table').querySelector('tbody'); b.innerHTML = ''; ['teachers','students'].forEach(k => JSON.parse(LS.getItem(k)).forEach((u,i) => b.innerHTML += `<tr><td>${getUName(u)}</td><td>${k}</td><td>${u.password}</td><td><button class="btn-ui btn-primary" onclick="alert('PIN: ${u.password}')">üëÅÔ∏è</button><button class="btn-ui btn-danger" onclick="delU('${k}',${i})">Del</button></td></tr>`)); }
        function delU(k,i) { let l=JSON.parse(LS.getItem(k)); l.splice(i,1); LS.setItem(k,JSON.stringify(l)); drawDB(); }
        function updateSelf() { 
            const n = document.getElementById('self-n').value; const p = document.getElementById('self-p').value;
            if(user.role === 'Admin') { LS.setItem('adminPass', p); }
            else { 
                let k = user.role==='Teacher'?'teachers':'students'; let l = JSON.parse(LS.getItem(k));
                let idx = l.findIndex(x=>x.mobile === user.mobile); l[idx].name = n; l[idx].password = p; LS.setItem(k, JSON.stringify(l));
            }
            alert("Updated!"); location.reload(); 
        }

        function runSpy() {
            const bt=document.getElementById('spy-b').value; const sb=document.getElementById('spy-s').value; const win=document.getElementById('spy-win');
            const c=JSON.parse(LS.getItem('chats')); const s=JSON.parse(LS.getItem('students')); let h='';
            c.forEach(x=>{ if(x.batch===bt && x.sub===sb){ let st=s.find(z=>z.name===x.sender); h+=`<div class="bubble b-recv"><b>${st?getUName(st):x.sender}:</b><br>${x.msg}</div>`; } });
            if(win.innerHTML!==h){ win.innerHTML=h; win.scrollTop=win.scrollHeight; }
        }
        function drawAppr() {
            const sb = document.getElementById('appr-s-table').querySelector('tbody'); const tb = document.getElementById('appr-t-table').querySelector('tbody');
            sb.innerHTML = ''; tb.innerHTML = ''; 
            JSON.parse(LS.getItem('students')).forEach((u, i) => { if(u.status === 'Pending') sb.innerHTML += `<tr><td>${u.name}</td><td><button class="btn-ui btn-primary" onclick="apprX('students', ${i})">Approve</button></td></tr>`; });
            JSON.parse(LS.getItem('teachers')).forEach((u, i) => { if(u.status === 'Pending') tb.innerHTML += `<tr><td>${u.name}</td><td><button class="btn-ui btn-primary" onclick="apprX('teachers', ${i})">Approve</button></td></tr>`; });
        }
        function apprX(k, i) { let l = JSON.parse(LS.getItem(k)); l[i].status = 'Active'; LS.setItem(k, JSON.stringify(l)); drawAppr(); }
        function bulkAppr(k) { let l = JSON.parse(LS.getItem(k)); l.forEach(u => u.status='Active'); LS.setItem(k, JSON.stringify(l)); drawAppr(); }
        function updateApprBadge() {
            let count = JSON.parse(LS.getItem('students')).filter(u=>u.status==='Pending').length + JSON.parse(LS.getItem('teachers')).filter(u=>u.status==='Pending').length;
            const b = document.getElementById('appr-badge'); if(b) { b.innerText = count; b.style.display = count===0?'none':'inline-block'; }
        }

        let pC = document.getElementById('party-canvas'); let pX = pC.getContext('2d'); let pS = [];
        function startParty() { pC.width = window.innerWidth; pC.height = window.innerHeight; for(let i=0; i<100; i++) pS.push({x:Math.random()*pC.width, y:Math.random()*pC.height, r:Math.random()*4+1, c:`hsl(${Math.random()*360},70%,60%)`, v:Math.random()*3+2}); ani(); }
        function ani() { pX.clearRect(0,0,pC.width,pC.height); pS.forEach(p => { p.y += p.v; if(p.y > pC.height) p.y = -10; pX.fillStyle=p.c; pX.beginPath(); pX.arc(p.x,p.y,p.r,0,Math.PI*2); pX.fill(); }); if(pS.length) requestAnimationFrame(ani); }
        function stopParty() { pS = []; pX.clearRect(0,0,pC.width,pC.height); }

        function refreshSelectors() {
            const bt = JSON.parse(LS.getItem('batches')); const h = bt.map(x=>`<option value="${x.name}">${x.name}</option>`).join('');
            ['sch-batch', 'r-batch', 'spy-b'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = h; });
            let ts=JSON.parse(LS.getItem('teachers')); let subs=[]; ts.forEach(t=>t.subject.split(',').forEach(s=>subs.push(s.trim())));
            if(document.getElementById('spy-s')) document.getElementById('spy-s').innerHTML = [...new Set(subs)].map(x=>`<option value="${x}">${x}</option>`).join('');
        }
        function swapAuth(m) { document.getElementById('auth-portal').style.display = m === 'login' ? 'block' : 'none'; document.getElementById('reg-box').style.display = m === 'reg' ? 'block' : 'none'; }
        function toggleReg() { let isT = document.getElementById('r-role').value === 'Teacher'; document.getElementById('reg-s-opts').style.display = isT ? 'none' : 'block'; document.getElementById('reg-t-opts').style.display = isT ? 'block' : 'none'; }
        function handleRegister() {
            const r = document.getElementById('r-role').value; const k = r === 'Student' ? 'students' : 'teachers';
            let l = JSON.parse(LS.getItem(k)); let obj = { name: document.getElementById('r-name').value, mobile: document.getElementById('r-mob').value.trim(), password: document.getElementById('r-pass').value.trim(), status: 'Pending' };
            if(r === 'Student') { obj.batch = document.getElementById('r-batch').value; obj.marks = 0; obj.type = 'Student'; obj.history=[]; } else obj.subject = document.getElementById('r-sub').value;
            l.push(obj); LS.setItem(k, JSON.stringify(l)); location.reload();
        }
    </script>
</body>
</html>