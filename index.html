<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalaram Academy v318 | AI Control</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        :root { --primary: #0f5bb8; --bg: #f8fafc; --text: #0f172a; --danger: #ef4444; --success: #22c55e; --surface: #ffffff; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color:transparent; user-select:none; }
        body { background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* UI COMPONENTS */
        .btn { width:100%; padding:14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; gap:8px; transition:0.2s; }
        .btn:active { transform:scale(0.98); }
        .btn-main { background:var(--primary); color:white; }
        .btn-sec { background:white; color:#334155; border:1px solid #cbd5e1; }
        .btn-danger { background:#fee2e2; color:#b91c1c; }
        .btn-upi { background:#4f46e5; color:white; }
        .btn-sm { width:auto; padding:6px 12px; font-size:12px; margin:0; height:32px; }

        .card { background:var(--surface); border-radius:16px; padding:16px; margin-bottom:12px; border:1px solid #e2e8f0; box-shadow:0 2px 4px rgba(0,0,0,0.02); }
        .row { display:flex; align-items:center; justify-content:space-between; }
        input, select, textarea { width:100%; padding:14px; border:1px solid #cbd5e1; border-radius:10px; margin-bottom:12px; outline:none; background:#f8fafc; font-size:14px; font-family:inherit; }
        input:focus, textarea:focus { border-color:var(--primary); background:white; }

        /* CHECKBOX LIST */
        .chk-row { display:flex; align-items:center; padding:10px; background:#f1f5f9; border-radius:8px; margin-bottom:8px; }
        .chk-row input { width:auto; margin:0 10px 0 0; }

        /* LAYOUT */
        #auth-layer { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; }
        #app-layer { display:none; height:100%; flex-direction:column; }
        .main-content { flex:1; overflow-y:auto; padding:15px; padding-bottom:100px; }
        
        .app-header { background:white; padding:15px; border-bottom:1px solid #e2e8f0; display:flex; align-items:center; justify-content:space-between; }
        .bot-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:12px 10px 25px 10px; border-top:1px solid #e2e8f0; z-index:1000; }
        .nav-item { text-align:center; color:#94a3b8; font-size:10px; font-weight:600; cursor:pointer; }
        .nav-item.active { color:var(--primary); }
        .nav-item i { font-size:24px; display:block; margin-bottom:4px; }

        /* SUB NAV */
        .sub-nav { display:flex; gap:20px; border-bottom:1px solid #e2e8f0; margin-bottom:15px; padding-bottom:0px; overflow-x:auto; }
        .sub-item { font-size:13px; font-weight:600; color:#64748b; cursor:pointer; padding-bottom:10px; white-space:nowrap; border-bottom:2px solid transparent; }
        .sub-item.active { color:var(--primary); border-bottom-color:var(--primary); }

        /* MODALS */
        .sheet-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9000; display:none; align-items:flex-end; backdrop-filter:blur(2px); }
        .sheet { background:white; width:100%; border-radius:24px 24px 0 0; padding:24px; max-height:90vh; overflow-y:auto; animation:slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }

        /* FULLSCREEN PLAYERS */
        .fullscreen-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:10000; display:none; flex-direction:column; }
        .fs-header { padding:15px; background:rgba(20,20,20,0.9); color:white; display:flex; justify-content:space-between; align-items:center; }
        .fs-content { flex:1; width:100%; height:100%; background:black; overflow-y:auto; padding:20px; }
        iframe { width:100%; height:100%; border:none; }

        /* CHAT BUBBLES */
        .chat-msg { background:#f1f5f9; padding:10px; border-radius:10px; margin-bottom:10px; font-size:13px; border-left:3px solid var(--primary); }
        .chat-alert { background:#fee2e2; border-left-color:red; color:#991b1b; }

        /* UTILS */
        .badge { font-size:10px; padding:4px 8px; border-radius:6px; font-weight:700; text-transform:uppercase; }
        .b-admin { background:#1e293b; color:white; }
        .b-student { background:#fef3c7; color:#92400e; }
        .empty-state { text-align:center; padding:40px 20px; color:#94a3b8; font-size:13px; }

        /* RED PEN CANVAS */
        #canvas-container { position: relative; width: 100%; overflow: hidden; touch-action: none; border: 2px solid #ddd; border-radius: 8px; }
        canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        
        .q-preview { background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:8px; font-size:12px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="video-room" class="fullscreen-overlay">
        <div class="fs-header">
            <div class="row" style="gap:10px;"><span style="color:red; animation:pulse 2s infinite;">‚óè</span> <b id="room-title">Live Class</b></div>
            <button class="btn-sm btn-danger" onclick="VideoService.endCall()">End Call</button>
        </div>
        <div id="jitsi-container" class="fs-content" style="padding:0;"></div>
    </div>

    <div id="content-player" class="fullscreen-overlay">
        <div class="fs-header">
            <b id="content-title">Learning Mode</b>
            <button class="btn-sm btn-sec" style="background:rgba(255,255,255,0.2); color:white; border:none;" onclick="ContentService.close()">Close</button>
        </div>
        <div id="player-container" class="fs-content" style="padding:0;"></div>
    </div>

    <div id="quiz-player" class="fullscreen-overlay" style="background:#f8fafc;">
        <div class="fs-header" style="background:white; color:#333; border-bottom:1px solid #eee;">
            <b id="quiz-title-display">Exam</b>
            <button class="btn-sm btn-sec" onclick="QuizService.close()">Exit</button>
        </div>
        <div id="quiz-container" class="fs-content" style="background:#f8fafc; color:#333;"></div>
    </div>

    <div id="checker-player" class="fullscreen-overlay" style="background:white; z-index:10002;">
        <div class="fs-header" style="background:#333; color:white;">
            <b>Manual Correction</b>
            <div style="display:flex; gap:10px">
                <button class="btn-sm btn-sec" onclick="CanvasEngine.clear()">Clear</button>
                <button class="btn-sm btn-main" onclick="CanvasEngine.saveAndMark()">Save & Mark</button>
                <button class="btn-sm btn-danger" onclick="document.getElementById('checker-player').style.display='none'">X</button>
            </div>
        </div>
        <div class="fs-content" style="background:#f1f5f9; padding:10px; display:flex; flex-direction:column; align-items:center;">
            <div id="canvas-wrapper" style="background:white; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:100%; max-width:600px; position:relative; min-height:300px; display:flex; align-items:center; justify-content:center; color:#888;">
                <img id="sheet-bg" style="width:100%; display:block; pointer-events:none;">
                <div id="text-answer-display" style="padding:20px; width:100%; display:none; text-align:left;"></div>
                <canvas id="draw-layer" style="position:absolute; top:0; left:0; width:100%; height:100%;"></canvas>
            </div>
            <div style="width:100%; max-width:600px; margin-top:20px; padding:20px; background:white; border-radius:10px;">
                <label><b>Assign Marks:</b></label>
                <input id="manual-score" type="number" placeholder="Enter Score">
                <textarea id="manual-feedback" placeholder="Teacher Remarks..." rows="2"></textarea>
            </div>
        </div>
    </div>

    <div id="auth-layer">
        <div style="font-size:64px; margin-bottom:20px;">üéì</div>
        <h2 style="color:var(--text); margin-bottom:10px;">Jalaram Academy</h2>
        <p style="color:#64748b; margin-bottom:30px; font-size:14px;">Enterprise Resource Portal v318</p>
        <div style="width:100%; max-width:320px;">
            <select id="l-role"><option value="Admin">Admin</option><option value="Teacher">Teacher</option><option value="Student">Student</option></select>
            <input id="l-id" placeholder="User ID (e.g. ADM-001)">
            <input type="password" id="l-pass" placeholder="PIN">
            <button class="btn btn-main" onclick="AuthService.login()">Login</button>
        </div>
    </div>

    <div id="app-layer">
        <div class="app-header">
            <div><b style="font-size:16px;">Jalaram Academy</b><div style="font-size:11px; color:#64748b;" id="user-greeting">Welcome</div></div>
            <i class="material-icons" style="color:#64748b; cursor:pointer;" onclick="AuthService.logout()">logout</i>
        </div>
        <main class="main-content"><div id="pane-container"></div></main>
        <div class="bot-nav" id="bot-nav"></div>
    </div>

    <div id="reg-sheet" class="sheet-overlay" onclick="Router.closeSheet('reg-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Register</h3>
            <select id="r-role" onchange="UiRenderer.toggleRegFields()"><option>Student</option><option>Teacher</option></select>
            <input id="r-name" placeholder="Name">
            <div id="r-stu-div">
                <input id="r-sm" placeholder="Student Mobile">
                <input id="r-pm" placeholder="Parent Mobile">
                <select id="r-batch"></select>
                <label style="font-size:11px; font-weight:bold; margin-top:10px; display:block;">Student Subjects</label>
                <input id="r-stu-subs" placeholder="e.g. Maths, Physics (Empty = All)">
            </div>
            <div id="r-tch-div" style="display:none;"><input id="r-subs" placeholder="Subjects Teaches"></div>
            <input id="r-pass" placeholder="PIN (Default: 1234)">
            <button class="btn btn-main" onclick="AuthService.register()">Create</button>
        </div>
    </div>

    <div id="add-course-sheet" class="sheet-overlay" onclick="Router.closeSheet('add-course-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Add New Course</h3>
            <input id="ac-name" placeholder="Course Title">
            <input id="ac-price" type="number" placeholder="Price (‚Çπ)">
            <select id="ac-cat"></select>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <select id="ac-type"><option value="video">Video (YouTube URL)</option><option value="pdf">PDF (Drive URL)</option></select>
            <input id="ac-url" placeholder="Paste URL Here">
            <button class="btn btn-main" onclick="MarketService.addCourse()">Publish Course</button>
        </div>
    </div>

    <div id="buy-sheet" class="sheet-overlay" onclick="Router.closeSheet('buy-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Secure Payment</h3>
            <div id="upi-qr-container" style="text-align:center; margin-bottom:20px;"></div>
            <div id="upi-intent-btn" style="margin-bottom:15px;"></div>
            <input id="buy-txn" placeholder="Enter UTR/Ref Number">
            <input type="hidden" id="buy-course-id">
            <button class="btn btn-main" onclick="MarketService.confirmOrder()">Submit Verification</button>
        </div>
    </div>
    
    <div id="pay-sheet" class="sheet-overlay" onclick="Router.closeSheet('pay-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Setup UPI</h3>
            <input id="p-val" placeholder="Your UPI ID (VPA)">
            <input id="p-name" placeholder="Merchant Name (Optional)">
            <button class="btn btn-main" onclick="savePayAccount()">Save UPI</button>
        </div>
    </div>

    <div id="batch-sheet" class="sheet-overlay" onclick="Router.closeSheet('batch-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="row"><h3 id="bs-title">Batch</h3><button class="btn-sm btn-sec" onclick="Router.closeSheet('batch-sheet')">Close</button></div>
            <div class="sub-nav">
                <div class="sub-item active" id="tab-live" onclick="BatchService.switchTab('live')">Live</div>
                <div class="sub-item" id="tab-doubts" onclick="BatchService.switchTab('doubts')">Doubts</div>
                <div class="sub-item" id="tab-tests" onclick="BatchService.switchTab('tests')">Tests</div>
                <div class="sub-item" id="tab-rank" onclick="BatchService.switchTab('rank')">Rank</div>
            </div>
            <div id="b-content"></div>
        </div>
    </div>

    <div id="subject-select-sheet" class="sheet-overlay" onclick="Router.closeSheet('subject-select-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Select Class Subject</h3>
            <div id="subject-list-container"></div>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <button class="btn btn-sec" onclick="BatchService.startVisibilityCall('General')">Start Combined/General Class</button>
        </div>
    </div>

    <div id="staff-sheet" class="sheet-overlay" onclick="Router.closeSheet('staff-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="row"><h3>Select Teachers</h3><button class="btn-sm btn-sec" onclick="Router.closeSheet('staff-sheet')">Cancel</button></div>
            <div class="row" style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:10px;"><b>Select All</b><input type="checkbox" onchange="BatchService.toggleAllTeachers(this)"></div>
            <div id="staff-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
            <button class="btn btn-main btn-danger" onclick="BatchService.startStaffCall()">üìû Start Private Call</button>
        </div>
    </div>

    <div id="test-creator-sheet" class="sheet-overlay" onclick="Router.closeSheet('test-creator-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Create New Test</h3>
            <div class="row" style="margin-bottom:20px;">
                <button class="btn btn-sec" style="flex:1; margin-right:10px;" onclick="Router.openSheet('add-quiz-sheet'); Router.closeSheet('test-creator-sheet');">Objective (MCQ)</button>
                <button class="btn btn-main" style="flex:1;" onclick="QuizService.initSubjectiveCreator(); Router.closeSheet('test-creator-sheet');">Subjective Exam</button>
            </div>
            <p style="font-size:12px; color:gray; text-align:center;">Choose test type.</p>
        </div>
    </div>

    <div id="add-quiz-sheet" class="sheet-overlay" onclick="Router.closeSheet('add-quiz-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Create MCQ Quiz</h3>
            <input id="qz-q" placeholder="Question">
            <input id="qz-o1" placeholder="Option A">
            <input id="qz-o2" placeholder="Option B">
            <input id="qz-o3" placeholder="Option C">
            <input id="qz-o4" placeholder="Option D">
            <select id="qz-ans"><option value="1">Option A Correct</option><option value="2">Option B Correct</option><option value="3">Option C Correct</option><option value="4">Option D Correct</option></select>
            <button class="btn btn-main" onclick="QuizService.add()">Post MCQ</button>
        </div>
    </div>

    <div id="add-sub-exam-sheet" class="sheet-overlay" onclick="Router.closeSheet('add-sub-exam-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Create Theory Exam</h3>
            <input id="se-title" placeholder="Exam Title">
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            
            <div style="margin-bottom:15px; background:#f0fdf4; padding:10px; border:1px solid #bbf7d0; border-radius:8px;">
                <label style="font-size:11px; font-weight:bold; color:#166534; display:block; margin-bottom:5px;">Grading Mode</label>
                <select id="se-mode">
                    <option value="ai">ü§ñ AI Auto-Check (Instant)</option>
                    <option value="manual">‚úçÔ∏è Manual Review (Teacher)</option>
                </select>
            </div>

            <div style="background:#f0f9ff; padding:15px; border-radius:10px; border:1px solid #bae6fd; margin-bottom:15px;">
                <label style="font-size:11px; font-weight:bold; color:#0369a1;">AI Keyword Syntax (If Auto-Check)</label>
                <ul style="font-size:11px; color:#555; padding-left:20px; margin-top:5px;"><li><b>!Word</b> : Critical (30% marks cut if missing).</li><li><b>Word/Synonym</b> : Group (Only 1 counts).</li></ul>
                <input id="se-q" placeholder="Question Text" style="margin-top:10px;">
                <div class="row"><input id="se-mm" type="number" placeholder="Marks" style="width:100%"></div>
                <textarea id="se-keys" placeholder="e.g. !Photosynthesis, Water/H2O" rows="3"></textarea>
                <button class="btn btn-sec" onclick="QuizService.pushQuestion()">+ Add This Question</button>
            </div>
            <div id="se-preview-list" style="margin-bottom:15px; max-height:150px; overflow-y:auto;"></div>
            <div class="row" style="background:#f0fdf4; padding:10px; border-radius:8px; margin-bottom:10px; color:green;"><b>Total:</b> <span id="se-total-calc">0</span></div>
            <button class="btn btn-main" onclick="QuizService.publishExam()">Publish</button>
        </div>
    </div>

    <script>
        // === DATA SERVICE ===
        class DatabaseService {
            constructor() {
                this.tables = ['users', 'courses', 'batches', 'orders', 'config', 'doubts', 'quizzes', 'exams', 'notis', 'results'];
                this.cache = {}; 
                this.tables.forEach(t => this.cache[t] = JSON.parse(localStorage.getItem('ja_' + t)) || []);
                if(this.cache['config'].length === 0) this.cache['config'] = [{upiId: "", upiName: "Jalaram Academy"}];
            }
            async add(table, data) { if(!data.id) data.id = Date.now().toString(); this.cache[table].push(data); this.commit(table); }
            async get(table) { return this.cache[table]; }
            async update(table, id, data) {
                const idx = this.cache[table].findIndex(x => x.id === id);
                if(idx !== -1) { this.cache[table][idx] = { ...this.cache[table][idx], ...data }; this.commit(table); }
            }
            commit(table) { localStorage.setItem('ja_' + table, JSON.stringify(this.cache[table])); }
        }
        const DB = new DatabaseService();

        // === UTILS ===
        const STANDARD_SUBJECTS = ["Mathematics", "Physics", "Chemistry", "Biology", "History", "English", "Computer Science"];
        function levenshtein(a,b){const m=[];let i,j;if(a.length==0)return b.length;if(b.length==0)return a.length;for(i=0;i<=b.length;i++)m[i]=[i];for(j=0;j<=a.length;j++)m[0][j]=j;for(i=1;i<=b.length;i++){for(j=1;j<=a.length;j++){m[i][j]=(b.charAt(i-1)==a.charAt(j-1))?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1);}}return m[b.length][a.length];}
        function smartFormat(str) {if(!str)return[];return [...new Set(str.split(',').map(s=>s.trim()).map(w=>{let best=null,low=100;STANDARD_SUBJECTS.forEach(std=>{let c=levenshtein(w.toLowerCase(),std.toLowerCase());if(c<low&&c<=Math.max(3,std.length*0.45)){low=c;best=std;}});return best||w.charAt(0).toUpperCase()+w.slice(1);}))];}

        // === CANVAS ENGINE (RED PEN) ===
        const CanvasEngine = {
            ctx: null, canvas: null, isDrawing: false, currentResultId: null,
            init: (imgSrc, rid, textContent) => {
                CanvasEngine.currentResultId = rid;
                const img = document.getElementById('sheet-bg');
                const textDiv = document.getElementById('text-answer-display');
                CanvasEngine.canvas = document.getElementById('draw-layer');
                CanvasEngine.ctx = CanvasEngine.canvas.getContext('2d');
                
                if (imgSrc) {
                    // IMAGE MODE
                    img.style.display = 'block'; textDiv.style.display = 'none';
                    img.src = imgSrc;
                    img.onload = () => {
                        CanvasEngine.canvas.width = img.width || 600;
                        CanvasEngine.canvas.height = img.height || 800;
                        CanvasEngine.setPen();
                    };
                } else {
                    // TEXT MODE (For Manual Typed Review)
                    img.style.display = 'none'; textDiv.style.display = 'block';
                    textDiv.innerHTML = textContent || "No content";
                    CanvasEngine.canvas.width = 600; CanvasEngine.canvas.height = 400; // Fixed canvas for text overlay
                    CanvasEngine.setPen();
                }

                ['mousedown','touchstart'].forEach(e => CanvasEngine.canvas.addEventListener(e, CanvasEngine.startDraw));
                ['mousemove','touchmove'].forEach(e => CanvasEngine.canvas.addEventListener(e, CanvasEngine.draw));
                ['mouseup','touchend'].forEach(e => CanvasEngine.canvas.addEventListener(e, CanvasEngine.stopDraw));
            },
            setPen: () => { CanvasEngine.ctx.strokeStyle = "red"; CanvasEngine.ctx.lineWidth = 3; CanvasEngine.ctx.lineCap = "round"; },
            getPos: (e) => {
                const rect = CanvasEngine.canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: (clientX - rect.left) * (CanvasEngine.canvas.width / rect.width), y: (clientY - rect.top) * (CanvasEngine.canvas.height / rect.height) };
            },
            startDraw: (e) => { e.preventDefault(); CanvasEngine.isDrawing = true; const p = CanvasEngine.getPos(e); CanvasEngine.ctx.beginPath(); CanvasEngine.ctx.moveTo(p.x, p.y); },
            draw: (e) => { if(!CanvasEngine.isDrawing) return; e.preventDefault(); const p = CanvasEngine.getPos(e); CanvasEngine.ctx.lineTo(p.x, p.y); CanvasEngine.ctx.stroke(); },
            stopDraw: () => { CanvasEngine.isDrawing = false; },
            clear: () => CanvasEngine.ctx.clearRect(0, 0, CanvasEngine.canvas.width, CanvasEngine.canvas.height),
            saveAndMark: async () => {
                const score = document.getElementById('manual-score').value;
                const feedback = document.getElementById('manual-feedback').value;
                if(!score) return alert("Enter Marks");
                await DB.update('results', CanvasEngine.currentResultId, { score: parseFloat(score), feedback: feedback, corrected: true });
                alert("Saved!"); document.getElementById('checker-player').style.display = 'none'; BatchService.switchTab('rank');
            }
        };

        // === QUIZ ENGINE ===
        const QuizService = {
            tempQuestions: [],
            add: async () => { /* ...existing mcq code... */ },
            initSubjectiveCreator: () => {
                QuizService.tempQuestions = []; document.getElementById('se-total-calc').innerText = '0'; document.getElementById('se-preview-list').innerHTML = ''; Router.openSheet('add-sub-exam-sheet');
            },
            pushQuestion: () => {
                const qText = document.getElementById('se-q').value; const mm = parseInt(document.getElementById('se-mm').value); const keysRaw = document.getElementById('se-keys').value;
                if(!qText || !mm) return alert("Question & Marks required");
                const parsedKeys = keysRaw ? keysRaw.split(',').map(k => k.trim()) : [];
                QuizService.tempQuestions.push({ q: qText, mm: mm, keys: parsedKeys });
                document.getElementById('se-q').value = ''; document.getElementById('se-mm').value = ''; document.getElementById('se-keys').value = '';
                document.getElementById('se-total-calc').innerText = QuizService.tempQuestions.reduce((a,b) => a + b.mm, 0);
                document.getElementById('se-preview-list').innerHTML = QuizService.tempQuestions.map((x,i) => `<div class="q-preview"><b>Q${i+1}.</b> ${x.q} (${x.mm} Marks)</div>`).join('');
            },
            publishExam: async () => {
                const title = document.getElementById('se-title').value; if(!title) return;
                const mode = document.getElementById('se-mode').value; // 'ai' or 'manual'
                await DB.add('exams', { 
                    batch: document.getElementById('bs-title').innerText, title: title, questions: QuizService.tempQuestions, 
                    totalMarks: QuizService.tempQuestions.reduce((a,b) => a + b.mm, 0), type: 'exam', mode: mode, date: new Date().toLocaleDateString() 
                });
                Router.closeSheet('add-sub-exam-sheet'); BatchService.switchTab('tests');
            },
            start: (id, type) => {
                const c = document.getElementById('quiz-container'); document.getElementById('quiz-player').style.display = 'flex';
                if(type === 'mcq') { /* existing mcq code */ } 
                else {
                    const exam = DB.cache['exams'].find(x => x.id == id);
                    c.innerHTML = `<div style="padding:20px;"><h3>${exam.title}</h3>
                        <p style="font-size:12px;color:gray">Mode: ${exam.mode === 'ai' ? 'Auto-Check' : 'Manual Review'}</p>
                        ${exam.questions.map((q, i) => `<div style="margin-bottom:20px;"><b style="font-size:14px;">Q${i+1}. ${q.q}</b> <span class="badge b-admin" style="float:right">${q.mm} Marks</span><textarea id="ans-${i}" rows="4" style="width:100%; border:1px solid #ddd; padding:10px; margin-top:5px;"></textarea></div>`).join('')}
                        <hr><b style="color:#d97706">Or Upload Answer Sheet (Hybrid)</b>
                        <input type="file" id="sheet-upload" accept="image/*" style="margin-top:10px;">
                        <button class="btn btn-main" style="margin-top:20px" onclick="QuizService.submitExam('${id}')">Submit Exam</button>
                    </div>`;
                }
            },
            submitExam: async (eid) => {
                const fileInput = document.getElementById('sheet-upload');
                const exam = DB.cache['exams'].find(x => x.id == eid);
                
                // 1. SHEET UPLOAD (Always Manual)
                if(fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        await DB.add('results', { 
                            qid: eid, qText: exam.title, uid: AuthService.currentUser.m, uName: AuthService.currentUser.n, batch: AuthService.currentUser.batch, 
                            score: 0, max: exam.totalMarks, date: new Date().toLocaleDateString(), type: 'sheet', sheetImg: e.target.result, corrected: false 
                        });
                        alert("Sheet Uploaded! Waiting for Correction."); QuizService.close();
                    };
                    reader.readAsDataURL(file);
                    return;
                }

                // 2. TYPED ANSWERS
                let totalObtained = 0;
                let fullAnalysis = [];
                let answersText = ""; // For manual review view

                exam.questions.forEach((q, i) => {
                    const ans = document.getElementById(`ans-${i}`).value;
                    answersText += `<b>Q${i+1}: ${q.q}</b><br>${ans}<br><br>`;
                    
                    if (exam.mode === 'ai') {
                        // AI LOGIC (Existing)
                        const ansLower = ans.toLowerCase();
                        let uniqueHits = 0;
                        q.keys.forEach(k => {
                            const isCritical = k.startsWith('!');
                            const cleanKey = isCritical ? k.substring(1) : k;
                            const synonyms = cleanKey.split('/').map(s => s.trim().toLowerCase());
                            if(synonyms.some(s => ansLower.includes(s))) uniqueHits++;
                        });
                        let qScore = (uniqueHits / Math.max(1, q.keys.length)) * q.mm; // Simplified density for brevity
                        if(qScore > q.mm) qScore = q.mm;
                        totalObtained += Math.round(qScore * 10) / 10;
                    }
                });

                if (exam.mode === 'ai') {
                    // SAVE AI SCORE
                    await DB.add('results', { qid: eid, qText: exam.title, uid: AuthService.currentUser.m, uName: AuthService.currentUser.n, batch: AuthService.currentUser.batch, score: totalObtained, max: exam.totalMarks, date: new Date().toLocaleDateString(), type: 'exam', analysis: fullAnalysis });
                    alert(`Exam Submitted! AI Score: ${totalObtained}/${exam.totalMarks}`);
                } else {
                    // SAVE FOR MANUAL REVIEW (Score 0, corrected false)
                    await DB.add('results', { 
                        qid: eid, qText: exam.title, uid: AuthService.currentUser.m, uName: AuthService.currentUser.n, batch: AuthService.currentUser.batch, 
                        score: 0, max: exam.totalMarks, date: new Date().toLocaleDateString(), type: 'manual_text', textContent: answersText, corrected: false 
                    });
                    alert("Submitted! Waiting for Teacher Review.");
                }
                QuizService.close();
            },
            close: () => document.getElementById('quiz-player').style.display = 'none'
        };

        // === BATCH MANAGER ===
        const BatchService = {
            currentBatch: null,
            open: (name) => { BatchService.currentBatch = name; document.getElementById('bs-title').innerText = name; Router.openSheet('batch-sheet'); BatchService.switchTab('live'); },
            switchTab: (tab) => {
                document.querySelectorAll('.sub-item').forEach(i => i.classList.remove('active')); document.getElementById('tab-'+tab).classList.add('active');
                const c = document.getElementById('b-content'); const role = AuthService.currentUser.role;
                
                if(tab === 'live') { /* ... */ }
                if(tab === 'rank') {
                    const results = DB.cache['results'].filter(r => r.batch === BatchService.currentBatch);
                    // Filter pending items
                    const pending = results.filter(r => !r.corrected && (r.type === 'sheet' || r.type === 'manual_text'));
                    
                    let html = '';
                    if (role === 'Teacher' && pending.length > 0) {
                        html = `<div style="background:#fff7ed; padding:10px; border:1px solid #fed7aa; margin-bottom:15px; border-radius:8px;">
                            <b>‚ö† ${pending.length} Pending Review</b>
                            ${pending.map(p => `<div class="row" style="margin-top:5px; font-size:12px;">${p.uName} - ${p.qText} <button class="btn-sm btn-main" onclick="BatchService.openCorrector('${p.id}')">Correct</button></div>`).join('')}
                        </div>`;
                    }
                    
                    // Leaderboard Logic
                    let lb = {};
                    results.forEach(r => {
                        if(r.corrected || r.type === 'exam' || r.type === 'mcq') { // Only count graded stuff
                            if(!lb[r.uid]) lb[r.uid] = { name: r.uName, total: 0 };
                            lb[r.uid].total += (r.score || 0);
                        }
                    });
                    const sorted = Object.values(lb).sort((a,b) => b.total - a.total);
                    html += sorted.map((s,i) => `<div class="row" style="padding:10px; border-bottom:1px solid #eee;"><div><b style="color:${i===0?'#d97706':'#333'}">#${i+1} ${s.name}</b></div><b style="color:var(--primary)">${s.total}</b></div>`).join('');
                    c.innerHTML = html || '<div class="empty-state">No Data</div>';
                }
            },
            openCorrector: (rid) => {
                const res = DB.cache['results'].find(r => r.id === rid);
                document.getElementById('checker-player').style.display = 'flex';
                // Pass sheetImg (if exists) OR textContent (if manual text)
                CanvasEngine.init(res.sheetImg, rid, res.textContent);
            },
            // ... (Rest of existing functions) ...
            prepLiveClass: () => {}, startVisibilityCall: async (s) => {}, openStaffSelection: async () => {}, toggleAllTeachers: () => {}, startStaffCall: async () => {}, postDoubt: async () => {}
        };

        // ... (Auth, Router, MarketService, VideoService etc.) ...
        const VideoService = { api:null, startCall:(r,u)=>{}, endCall:()=>{} };
        const MarketService = { addCourse:async()=>{}, initBuy:async()=>{}, confirmOrder:async()=>{} }; 
        const AuthService = { currentUser:null, login:async()=>{}, register:async()=>{}, logout:()=>{} };
        const Router = { init:(r)=>{}, nav:(p)=>{}, openSheet:(i)=>{}, closeSheet:(i)=>{} };
        const UiRenderer = { renderHome:async()=>{}, renderAdmin:async()=>{}, renderCourses:async()=>{}, toggleRegFields:()=>{} };
    </script>
</body>
</html>
