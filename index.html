<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalaram Academy | v191 Life Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #0091ea; --bg: #f0f2f5; --text: #111b21;
            --danger: #ef4444; --success: #22c55e; --warning: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:#f0f2f5; color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* HEADER */
        .app-bar { background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); position: sticky; top:0; z-index:100; }
        .brand { font-size:18px; font-weight:800; }
        
        /* SUB NAVIGATION (User Friendly Tabs) */
        .sub-nav { background:white; white-space:nowrap; overflow-x:auto; border-bottom:1px solid #ddd; padding:0 10px; display:none; }
        .sub-tab { display:inline-block; padding:12px 15px; font-size:13px; font-weight:600; color:#54656f; border-bottom:3px solid transparent; cursor:pointer; }
        .sub-tab.active { color:var(--primary); border-color:var(--primary); }

        /* CONTENT */
        .main { flex:1; overflow-y:auto; padding:15px; padding-bottom:80px; }
        .pane { display:none; } .pane.active { display:block; }

        /* CARDS */
        .card { background:white; padding:15px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:10px; border: 1px solid rgba(0,0,0,0.03); }
        .row { display:flex; justify-content:space-between; align-items:center; }
        .label { font-size:11px; color:#54656f; font-weight:700; margin-bottom:5px; display:block; text-transform:uppercase; }

        /* INPUTS & BUTTONS */
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px; font-size:14px; background:white; outline:none; }
        input:focus { border-color:var(--primary); }
        .btn { padding:12px; border:none; border-radius:8px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-top:5px; transition: 0.2s; }
        .btn-main { background:var(--primary); color:white; }
        .btn-sec { background:#e2e8f0; color:#1e293b; }
        .btn-red { background:#fee2e2; color:var(--danger); }

        /* PIE CHART */
        .pie-chart { width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(var(--success) 0% 0%, #eee 0% 100%); display: flex; align-items: center; justify-content: center; position: relative; margin: 10px auto; }
        .pie-chart::after { content: ""; position: absolute; width: 90px; height: 90px; background: white; border-radius: 50%; }
        .pie-text { position: absolute; z-index: 1; font-weight: 800; font-size: 22px; }

        /* BOTTOM NAVIGATION */
        .bot-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:10px; border-top:1px solid #ddd; }
        .nav-item { text-align:center; font-size:10px; color:#54656f; font-weight:600; width:25%; cursor:pointer; display:flex; flex-direction:column; align-items:center; }
        .nav-item.active { color:var(--primary); }
        .nav-item .material-icons { font-size: 22px; margin-bottom: 2px; }

        /* MODAL */
        .modal-ol { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; }
        .modal { background:white; width:90%; max-width:400px; padding:20px; border-radius:15px; }
        #party-canvas { position: fixed; top:0; left:0; pointer-events:none; z-index:9999; }
    </style>
</head>
<body>

    <canvas id="party-canvas"></canvas>

    <div id="auth" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f0f2f5; z-index:3000; display:flex; align-items:center; justify-content:center;">
        <div class="card" style="width:320px; text-align:center; padding:30px;">
            <div style="font-size:50px;">üéì</div>
            <h2 style="font-weight:800; color:var(--primary);">Jalaram Academy</h2>
            <p style="color:#666; margin-bottom:20px; font-size:12px;">Step to Success</p>
            <div id="l-form">
                <select id="l-role"><option>Admin</option><option>Teacher</option><option>Student</option></select>
                <input id="l-id" placeholder="Login ID (Try 1111 or 9999)">
                <input type="password" id="l-pass" placeholder="PIN (Try 1234)">
                <button class="btn btn-main" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <div class="app-bar">
            <div class="brand">Jalaram Zenith</div>
            <div id="u-chip" style="font-size:10px; background:rgba(255,255,255,0.2); padding:4px 10px; border-radius:20px; font-weight:700;">User</div>
        </div>
        
        <div class="sub-nav" id="sub-nav"></div>

        <div class="main">
            <div id="pane-admin" class="pane">
                <div class="card">
                    <h3>Identity Hub</h3>
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <button class="btn btn-main" style="flex:1;" onclick="openAddModal('Student')">+ STUDENT</button>
                        <button class="btn btn-main" style="flex:1; background:#6c5ce7;" onclick="openAddModal('Teacher')">+ TEACHER</button>
                    </div>
                </div>
                <input placeholder="üîç Search Users..." onkeyup="renderUsers(this.value)">
                <div id="list-s"></div>
                <div id="list-t"></div>
            </div>

            <div id="pane-batches" class="pane">
                <div class="card">
                    <h3>Quantum Scheduler</h3>
                    <select id="sch-batch"></select>
                    <div style="display:flex; gap:10px;">
                        <input type="time" id="sch-time">
                        <input type="number" id="sch-dur" placeholder="Mins" value="60">
                    </div>
                    <input type="text" id="sch-sub" placeholder="Subject Name (auto-capitalize)" oninput="formatSubs(this)">
                    <button class="btn btn-main" onclick="saveQuantum()">SECURE SLOT</button>
                </div>
                <div id="master-sch-list"></div>
            </div>

            <div id="pane-home" class="pane">
                <div class="card" style="background:var(--primary); color:white;">
                    <h3>Student Progress</h3>
                    <div class="row" style="margin-top:10px;">
                        <div>MARKS: <span id="my-m">0</span></div>
                        <div>RANK: <span id="my-r">#--</span></div>
                    </div>
                </div>
                <div class="card" style="text-align:center;">
                    <div class="pie-chart" id="att-pie"><div class="pie-text" id="att-val">0%</div></div>
                    <p style="font-weight:700;">Attendance</p>
                </div>
                <div id="student-classes"></div>
            </div>

            <div id="pane-profile" class="pane">
                <div class="card">
                    <h3>Menu</h3>
                    <button class="btn btn-sec" onclick="startSim('Teacher')">Simulate Teacher</button>
                    <button class="btn btn-sec" onclick="startSim('Student')">Simulate Student</button>
                    <button class="btn btn-red" style="margin-top:20px;" onclick="location.reload()">Logout</button>
                </div>
            </div>
        </div>

        <div class="bot-nav" id="bot-nav"></div>
    </div>

    <div id="add-modal" class="modal-ol" onclick="this.style.display='none'">
        <div class="modal" onclick="event.stopPropagation()">
            <h3 id="modal-title">Registry</h3>
            <input id="m-name" placeholder="Full Name">
            <input id="m-mob" placeholder="Mobile / ID">
            <input id="m-pass" placeholder="PIN">
            <div id="m-stu-box"><select id="m-batch"><option>Class 10 A</option><option>Class 12</option></select></div>
            <button class="btn btn-main" onclick="commitUser()">SAVE TO CLOUD</button>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG (Paste your keys here) ---
        const firebaseConfig = { apiKey: "PASTE_HERE", authDomain: "PASTE_HERE", projectId: "PASTE_HERE" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DUMMY DATA FOR OFFLINE/BYPASS
        let dummy = {
            '1111': {n:'Rahul', role:'Student', batch:'Class 10 A', att:90, marks:95, rank:1, p:'1234'},
            '9999': {n:'Mr. Sharma', role:'Teacher', p:'1234'}
        };

        let currentUser = null;
        let state = { users: [], schedules: [], batches: ['Class 10 A', 'Class 12'] };

        function initListeners() {
            db.collection('users').onSnapshot(snap => { state.users = snap.docs.map(d => d.data()); refreshUI(); });
            db.collection('schedules').onSnapshot(snap => { state.schedules = snap.docs.map(d => d.data()); refreshUI(); });
        }
        initListeners();

        function login() {
            const id = document.getElementById('l-id').value, ps = document.getElementById('l-pass').value;
            if(id === 'admin' && ps === '1234') { currentUser = {n:'Admin', role:'Admin'}; finalize(); return; }
            if(dummy[id] && dummy[id].p === ps) { currentUser = dummy[id]; finalize(); return; }
            const f = state.users.find(u => u.m === id && u.p === ps);
            if(f) { currentUser = f; finalize(); } else { alert("Login Failed"); }
        }

        function finalize() {
            document.getElementById('auth').style.display='none';
            document.getElementById('app').style.display='block';
            document.getElementById('u-chip').innerText = currentUser.n;
            setupNav(); refreshUI();
        }

        function setupNav() {
            const nav = document.getElementById('bot-nav');
            const items = [
                {i:'pane-home',l:'Home',ic:'home'},
                {i:'pane-admin',l:'Admin',ic:'badge'},
                {i:'pane-batches',l:'Classes',ic:'school'},
                {i:'pane-profile',l:'Menu',ic:'menu'}
            ];
            nav.innerHTML = items.map(x => `<div class="nav-item" onclick="openPane('${x.i}', this)"><span class="material-icons">${x.ic}</span>${x.l}</div>`).join('');
            openPane('pane-home', nav.firstChild);
        }

        function openPane(id, el) {
            document.querySelectorAll('.pane, .nav-item').forEach(x => x.classList.remove('active'));
            document.getElementById(id).classList.add('active'); if(el) el.classList.add('active');
        }

        function renderUsers() {
            document.getElementById('list-s').innerHTML = state.users.filter(x=>x.role==='Student').map(u => `<div class="card"><b>${u.n}</b> - ${u.batch}</div>`).join('');
            document.getElementById('list-t').innerHTML = state.users.filter(x=>x.role==='Teacher').map(u => `<div class="card"><b>${u.n}</b> - Faculty</div>`).join('');
        }

        function saveQuantum() {
            const bt = document.getElementById('sch-batch').value, t = document.getElementById('sch-time').value, sub = document.getElementById('sch-sub').value;
            const dur = parseInt(document.getElementById('sch-dur').value);
            const start = parseInt(t.split(':')[0])*60 + parseInt(t.split(':')[1]), end = start + dur;

            const clash = state.schedules.find(s => {
                if(s.batch !== bt) return false;
                const eStart = parseInt(s.time.split(':')[0])*60 + parseInt(s.time.split(':')[1]), eEnd = eStart + s.dur;
                return (start < eEnd + 10) && (end + 10 > eStart);
            });

            if(clash) alert(`‚ö†Ô∏è CLASH! ${clash.sub} by ${clash.teacher} at ${clash.time}. 10m Buffer required.`);
            else { db.collection('schedules').add({ batch:bt, time:t, dur:dur, sub:sub, teacher:currentUser.n }); }
        }

        function refreshUI() {
            if(!currentUser) return;
            if(currentUser.role === 'Student') {
                const att = currentUser.att || 0;
                document.getElementById('att-val').innerText = att + "%";
                document.getElementById('att-pie').style.background = `conic-gradient(var(--success) 0% ${att}%, #eee ${att}% 100%)`;
                document.getElementById('my-m').innerText = currentUser.marks || 0;
                document.getElementById('my-r').innerText = "#" + (currentUser.rank || '--');
                if(currentUser.rank <= 3) triggerConfetti();
                document.getElementById('student-classes').innerHTML = state.schedules.filter(x=>x.batch===currentUser.batch).map(c => `<div class="card"><b>${c.sub}</b><br><small>${c.time}</small></div>`).join('');
            }
            if(currentUser.role === 'Admin') renderUsers();
            document.getElementById('sch-batch').innerHTML = state.batches.map(b=>`<option>${b}</option>`).join('');
            document.getElementById('master-sch-list').innerHTML = state.schedules.map(s => `<div class="card"><b>${s.sub}</b> - ${s.batch} at ${s.time}</div>`).join('');
        }

        function formatSubs(el) { if(el.value.endsWith(',')) { let p = el.value.split(',').map(x=>x.trim().charAt(0).toUpperCase()+x.trim().slice(1)); el.value = p.join(', ') + ' '; } }
        function openAddModal(r) { document.getElementById('add-modal').style.display='flex'; document.getElementById('modal-title').innerText = "+ " + r; document.getElementById('add-modal').dataset.role = r; }
        function commitUser() { const role = document.getElementById('add-modal').dataset.role; const u = { n:document.getElementById('m-name').value, m:document.getElementById('m-mob').value, p:document.getElementById('m-pass').value, role:role }; if(role==='Student') u.batch = document.getElementById('m-batch').value; db.collection('users').add(u); document.getElementById('add-modal').style.display='none'; }
        function triggerConfetti() { const c = document.getElementById('party-canvas'); const ctx = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; let p = Array.from({length:50}, () => ({x:Math.random()*c.width, y:Math.random()*c.height, c:`hsl(${Math.random()*360},70%,50%)`, v:Math.random()*2+1})); function frame() { ctx.clearRect(0,0,c.width,c.height); p.forEach(x => { x.y+=x.v; if(x.y>c.height) x.y=-10; ctx.fillStyle=x.c; ctx.fillRect(x.x,x.y,4,4); }); requestAnimationFrame(frame); } frame(); }
        function startSim(r) { currentUser = {n:"Sim "+r, role:r, batch:'Class 10 A', att:85, marks:90, rank:1}; finalize(); }
    </script>
</body>
</html>
