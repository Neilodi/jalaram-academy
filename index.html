<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalaram Academy v257</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --text: #0f172a; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* AUTH */
        #auth-layer { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; }
        
        /* APP */
        #app-layer { display:none; height:100%; flex-direction:column; }
        .app-bar { padding:20px; background:white; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        .main-content { flex:1; overflow-y:auto; padding:20px; padding-bottom:100px; }

        /* UI */
        .u-card { background:white; padding:15px; border-radius:16px; box-shadow:0 4px 10px rgba(0,0,0,0.03); margin-bottom:15px; border:1px solid #e2e8f0; }
        .btn { padding:14px; border:none; border-radius:12px; font-weight:700; cursor:pointer; width:100%; font-size:14px; margin-bottom:10px; display:flex; align-items:center; justify-content:center; gap:5px; transition:0.2s; }
        .btn:active { transform:scale(0.98); }
        .btn-main { background:var(--primary); color:white; }
        .btn-sec { background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; }
        input, select { width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:12px; margin-bottom:10px; outline:none; background:white; font-size:14px; }

        /* MODALS */
        .sheet-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9000; display:none; align-items:flex-end; }
        .sheet { background:white; width:100%; border-radius:25px 25px 0 0; padding:25px; box-shadow:0 -10px 40px rgba(0,0,0,0.1); max-height:85vh; overflow-y:auto; animation:slideUp 0.3s forwards; }
        @keyframes slideUp { from { transform:translateY(100%); } to { transform:translateY(0); } }
        .sheet-handle { width:40px; height:5px; background:#e2e8f0; border-radius:10px; margin:0 auto 20px auto; }

        /* EXTRAS */
        .teacher-only, .admin-only { display:none; }
        .pie-chart { width:24px; height:24px; border-radius:50%; background:conic-gradient(var(--primary) 0% 0%, #e2e8f0 0% 100%); margin-left:10px; }
        .bot-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:12px; border-top:1px solid #eee; z-index:1000; }
        .nav-item { text-align:center; font-size:10px; color:#94a3b8; font-weight:bold; }
        .nav-item.active { color:var(--primary); }
        .nav-item i { font-size:24px; display:block; margin-bottom:3px; }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div style="font-size:50px; margin-bottom:10px;">üéì</div>
        <h2 style="color:var(--primary); margin-bottom:5px;">Jalaram Academy</h2>
        <p style="color:#64748b; margin-bottom:30px;">v257 Safe Mode</p>
        
        <div style="width:100%; max-width:320px;">
            <select id="l-role"><option>Admin</option><option>Teacher</option><option>Student</option></select>
            <input id="l-id" placeholder="ID (ADM-001)">
            <input type="password" id="l-pass" placeholder="PIN (1234)">
            
            <button class="btn btn-main" onclick="tryLogin()">Login Dashboard</button>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn btn-sec" onclick="openSheet('reg-sheet')">New Register</button>
                <button class="btn btn-sec" onclick="openSheet('public-sheet')">View Courses</button>
            </div>
        </div>
    </div>

    <div id="app-layer">
        <div class="app-bar">
            <div>
                <h3 style="margin:0;" id="greet-name">Hello</h3>
                <small style="color:#64748b">Let's learn something.</small>
            </div>
            <i class="material-icons" onclick="location.reload()" style="color:#64748b">power_settings_new</i>
        </div>

        <main class="main-content">
            <div id="pane-home" class="pane">
                <div class="u-card">
                    <h3>üèÜ Leaderboard</h3>
                    <div id="lb-list"></div>
                </div>
            </div>

            <div id="pane-batches" class="pane" style="display:none;">
                <div class="u-card">
                    <div class="row"><h3>Classes</h3><button class="btn btn-sm btn-sec admin-only" style="width:auto; padding:5px 10px;" onclick="addBatch()">+ Batch</button></div>
                    <div id="batch-list"></div>
                </div>
            </div>

            <div id="pane-admin" class="pane" style="display:none;">
                <div class="u-card">
                    <h3>Database</h3>
                    <div id="user-list"></div>
                </div>
                <div class="u-card">
                    <h3>Courses</h3>
                    <div class="row"><button class="btn btn-sec btn-sm" onclick="addCourse()">+ Add Course</button></div>
                    <div id="course-list"></div>
                </div>
            </div>
            
            <div id="pane-store" class="pane" style="display:none;"><div class="u-card"><h3>Store</h3><div id="store-list"></div></div></div>
            <div id="pane-chat" class="pane" style="display:none;"><div class="u-card"><h3>Chat</h3><div id="chat-list"></div></div></div>
            <div id="pane-profile" class="pane" style="display:none;"><div class="u-card"><h3>Profile</h3><input id="prof-id" readonly></div></div>
        </main>

        <div class="bot-nav" id="bot-nav"></div>
    </div>

    <div id="reg-sheet" class="sheet-overlay" onclick="closeSheet('reg-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <h3>New Registration</h3>
            <select id="r-role" onchange="togReg()"><option>Student</option><option>Teacher</option></select>
            <input id="r-name" placeholder="Full Name">
            
            <div id="r-stu-div">
                <input id="r-sm" placeholder="Student Mobile">
                <select id="r-batch"></select>
                <small>Select Subjects:</small>
                <div id="r-ticks" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:10px;"></div>
            </div>
            
            <div id="r-tch-div" style="display:none;">
                <input id="r-subs" placeholder="Subjects (Comma separated)">
            </div>

            <input id="r-pass" placeholder="Create PIN">
            <button class="btn btn-main" onclick="doReg()">Register</button>
        </div>
    </div>

    <div id="batch-sheet" class="sheet-overlay" onclick="closeSheet('batch-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <h3 id="bs-title">Batch</h3>
            
            <div class="teacher-only" style="background:#f0f9ff; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #bfdbfe;">
                <b style="color:var(--primary)">‚ö° Quantum Generator</b>
                <input id="q-topic" placeholder="Topic" style="margin-top:5px;">
                <div class="row">
                    <select id="q-buf" style="width:48%; margin:0;"><option>No Buffer</option><option>10m Buffer</option></select>
                    <button class="btn btn-main" style="width:48%; margin:0;" onclick="alert('Quantum Notification Sent!')">Notify</button>
                </div>
            </div>

            <div class="teacher-only row" style="margin-bottom:10px;">
                <b>Tools:</b> 
                <div>
                    <button class="btn btn-sec" style="width:auto; padding:5px 10px;" onclick="renderStu('att')">Att.</button>
                    <button class="btn btn-sec" style="width:auto; padding:5px 10px;" onclick="setupMarks()">Marks</button>
                </div>
            </div>
            
            <div id="marks-panel" style="display:none; background:#fff7ed; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #fdba74;">
                <b style="color:#c2410c">Test Setup</b>
                <div class="row">
                    <input id="t-name" placeholder="Test Name" style="width:60%; margin:0;">
                    <input id="t-total" placeholder="Total" style="width:35%; margin:0;" type="number" onchange="renderStu('marks')">
                </div>
            </div>

            <div id="bs-list"></div>
        </div>
    </div>

    <div id="public-sheet" class="sheet-overlay" onclick="closeSheet('public-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <h3>Courses</h3>
            <div onclick="aiGen('Maths')" style="padding:15px; border-bottom:1px solid #eee;"><b>Maths</b><br><small>Tap for Info</small></div>
            <div onclick="aiGen('Science')" style="padding:15px; border-bottom:1px solid #eee;"><b>Science</b><br><small>Tap for Info</small></div>
            <div id="ai-res" style="margin-top:15px; padding:15px; background:#f8fafc; border-radius:10px;"></div>
        </div>
    </div>

    <script>
        // --- 1. CORE FUNCTIONS (Must be defined first) ---
        function openSheet(id) {
            document.getElementById(id).style.display = 'flex';
            if(id === 'reg-sheet') initReg();
        }
        function closeSheet(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- 2. DATA LOAD (With Fail-Safe) ---
        let users = [
            {n:'Admin', m:'ADM-001', p:'1234', role:'Admin'},
            {n:'Amit Sir', m:'TCH-001', p:'1234', role:'Teacher', subjects:'Maths, Science'},
            {n:'Rohan', m:'STU-001', p:'1234', role:'Student', batch:'Class 10 A', marks:45}
        ];
        let batches = ['Class 10 A', 'Class 12'];
        let globalSubjects = ['Maths', 'Science', 'English'];
        let currentUser = null;
        let activeTotal = 100;

        // Force clean start to fix broken buttons from previous cache
        try {
            if(!localStorage.getItem('v257_fix')) {
                localStorage.clear();
                localStorage.setItem('v257_fix', 'true');
            } else {
                if(localStorage.getItem('ja_users')) users = JSON.parse(localStorage.getItem('ja_users'));
                if(localStorage.getItem('ja_batches')) batches = JSON.parse(localStorage.getItem('ja_batches'));
                if(localStorage.getItem('ja_subs')) globalSubjects = JSON.parse(localStorage.getItem('ja_subs'));
            }
        } catch(e) { console.log("Data reset error", e); }

        function sync() {
            localStorage.setItem('ja_users', JSON.stringify(users));
            localStorage.setItem('ja_batches', JSON.stringify(batches));
            localStorage.setItem('ja_subs', JSON.stringify(globalSubjects));
        }

        // --- 3. LOGIN & REG ---
        function tryLogin() {
            let id = document.getElementById('l-id').value;
            let u = users.find(x => x.m === id);
            if(u) { currentUser = u; launchApp(); } 
            else { alert("Try ADM-001 / 1234"); }
        }

        function initReg() {
            document.getElementById('r-batch').innerHTML = batches.map(b => `<option>${b}</option>`).join('');
            document.getElementById('r-ticks').innerHTML = globalSubjects.map(s => `<label><input type="checkbox" value="${s}"> ${s}</label>`).join('');
            togReg();
        }

        function togReg() {
            let r = document.getElementById('r-role').value;
            document.getElementById('r-stu-div').style.display = r === 'Student' ? 'block' : 'none';
            document.getElementById('r-tch-div').style.display = r === 'Teacher' ? 'block' : 'none';
        }

        function doReg() {
            let n = document.getElementById('r-name').value;
            let role = document.getElementById('r-role').value;
            let id = (role==='Student'?'STU':'TCH') + '-' + Math.floor(Math.random()*10000);
            
            let u = {n:n, m:id, p:'1234', role:role, status:'Pending'};
            if(role === 'Student') {
                u.batch = document.getElementById('r-batch').value;
                // Get Ticks
                let acc = [];
                document.querySelectorAll('#r-ticks input:checked').forEach(c => acc.push(c.value));
                u.access = acc;
            } else {
                u.subjects = document.getElementById('r-subs').value;
                // Add to Global Subjects
                u.subjects.split(',').forEach(s => {
                    let trimS = s.trim();
                    if(!globalSubjects.includes(trimS)) globalSubjects.push(trimS);
                });
            }
            users.push(u); sync();
            alert("ID: " + id); closeSheet('reg-sheet');
        }

        // --- 4. APP LAUNCHER ---
        function launchApp() {
            document.getElementById('auth-layer').style.display = 'none';
            document.getElementById('app-layer').style.display = 'flex';
            document.getElementById('greet-name').innerText = "Hi, " + currentUser.n;

            // Visibility
            document.querySelectorAll('.admin-only').forEach(e => e.style.display = currentUser.role==='Admin'?'block':'none');
            document.querySelectorAll('.teacher-only').forEach(e => e.style.display = (currentUser.role==='Teacher'||currentUser.role==='Admin')?'block':'none');

            // Nav
            let menu = [];
            if(currentUser.role==='Admin') menu = ['Admin', 'Batches', 'Store'];
            else if(currentUser.role==='Teacher') menu = ['Batches', 'Chat', 'Profile'];
            else menu = ['Home', 'Chat', 'Store'];

            document.getElementById('bot-nav').innerHTML = menu.map(m => {
                let icon = {'Home':'home','Admin':'admin_panel_settings','Batches':'class','Store':'menu_book','Chat':'chat','Profile':'person'}[m];
                return `<div class="nav-item" onclick="nav('pane-${m.toLowerCase()}')"><i class="material-icons">${icon}</i>${m}</div>`;
            }).join('');

            nav('pane-' + menu[0].toLowerCase());
        }

        function nav(id) {
            document.querySelectorAll('.pane').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            
            if(id === 'pane-home') renderLB();
            if(id === 'pane-batches') renderBatches();
            if(id === 'pane-admin') renderAdmin();
            if(id === 'pane-profile') document.getElementById('prof-id').value = currentUser.m;
        }

        // --- 5. FEATURES ---
        function renderLB() {
            let list = users.filter(u => u.role === 'Student').sort((a,b) => b.marks - a.marks);
            document.getElementById('lb-list').innerHTML = list.map((u, i) => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                    <b>#${i+1} ${u.n}</b> <span style="color:blue">${u.marks || 0}%</span>
                </div>
            `).join('');
        }

        function renderBatches() {
            document.getElementById('batch-list').innerHTML = batches.map(b => `
                <div class="u-card" onclick="openBatch('${b}')"><b>${b}</b></div>
            `).join('');
        }

        function openBatch(b) {
            openSheet('batch-sheet');
            document.getElementById('bs-title').innerText = b;
            renderStu('view');
        }

        function setupMarks() {
            document.getElementById('marks-panel').style.display = 'block';
        }

        function renderStu(mode) {
            let b = document.getElementById('bs-title').innerText;
            if(mode === 'marks') activeTotal = parseInt(document.getElementById('t-total').value) || 100;

            document.getElementById('bs-list').innerHTML = users.filter(u => u.batch === b && u.role === 'Student').map(u => {
                let action = `<small>${u.m}</small>`;
                if(mode === 'att') action = `<button class="btn-sec" style="padding:5px;">P</button><button class="btn-sec" style="padding:5px;">A</button>`;
                if(mode === 'marks') {
                    let pct = Math.round(((u.marks||0) / activeTotal) * 100);
                    action = `<div style="display:flex; align-items:center;"><input value="${u.marks||0}" style="width:40px; margin:0;" onchange="saveMark('${u.m}', this.value)"> <div class="pie-chart" style="background:conic-gradient(var(--primary) 0% ${pct}%, #eee ${pct}% 100%)"></div></div>`;
                }
                return `<div class="row" style="padding:10px; border-bottom:1px solid #eee;"><b>${u.n}</b>${action}</div>`;
            }).join('');
        }

        function saveMark(id, val) {
            let u = users.find(x => x.m === id);
            if(u) { u.marks = parseInt(val); sync(); renderStu('marks'); }
        }

        // --- 6. ADMIN ---
        function renderAdmin() {
            document.getElementById('user-list').innerHTML = users.map(u => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <div><b>${u.n}</b><br><small>${u.m}</small></div>
                    <button class="btn-red" style="width:auto; padding:5px 10px; font-size:12px;" onclick="delUser('${u.m}')">Del</button>
                </div>
            `).join('');
            
            document.getElementById('course-list').innerHTML = globalSubjects.map(s => `
                <div style="padding:10px; border-bottom:1px solid #eee;"><b>${s}</b></div>
            `).join('');
        }

        function delUser(id) {
            if(confirm("Delete?")) {
                users = users.filter(x => x.m !== id);
                // Smart Subject Cleanup
                updateGlobalSubjects();
                sync();
                renderAdmin();
            }
        }

        function addBatch() { let b = prompt("Name:"); if(b) { batches.push(b); sync(); renderBatches(); } }
        function addCourse() { let c = prompt("Course:"); if(c) { globalSubjects.push(c); sync(); renderAdmin(); } }

        function aiGen(s) {
            document.getElementById('ai-res').innerHTML = "Generating...";
            setTimeout(() => document.getElementById('ai-res').innerHTML = `<b>${s} Syllabus</b><br>AI generated insight loaded.`, 1000);
        }
    </script>
</body>
</html>
