<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalaram Academy | Enterprise ERP v335</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        /* =========================================
           1. ROOT VARIABLES & RESET
           ========================================= */
        :root {
            --primary-color: #0f5bb8;
            --primary-dark: #0a3d7c;
            --accent-color: #3b82f6;
            --background-color: #f3f4f6;
            --surface-color: #ffffff;
            --text-main: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #6366f1;
            --sidebar-width: 280px;
            --header-height: 64px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* =========================================
           2. AUTHENTICATION LAYER STYLES
           ========================================= */
        #auth-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--surface-color);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .auth-container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-logo {
            font-size: 64px;
            margin-bottom: 16px;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .otp-input-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 24px 0;
        }

        .otp-digit {
            width: 50px;
            height: 60px;
            font-size: 24px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-weight: 700;
            transition: all 0.2s;
        }

        .otp-digit:focus {
            border-color: var(--primary-color);
            outline: none;
            transform: translateY(-2px);
        }

        /* =========================================
           3. APPLICATION SHELL & LAYOUT
           ========================================= */
        #app-layer {
            display: none; /* Hidden by default until login */
            height: 100%;
            display: flex;
            flex-direction: row;
        }

        /* Sidebar (Desktop) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 500;
        }

        .brand-section {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 24px;
            font-size: 20px;
            font-weight: 800;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-scroll {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .nav-item {
            padding: 14px 16px;
            margin-bottom: 4px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background-color: var(--background-color);
            color: var(--text-main);
        }

        .nav-item.active {
            background-color: #eff6ff;
            color: var(--primary-color);
        }

        .nav-item i {
            font-size: 22px;
        }

        /* Main Content Area */
        .main-content-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-header {
            height: var(--header-height);
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .page-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: 100px; /* Space for mobile nav */
        }

        /* Bottom Nav (Mobile) */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            padding: 12px 0;
            z-index: 1000;
            justify-content: space-around;
        }

        .b-nav-item {
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            flex: 1;
            cursor: pointer;
        }

        .b-nav-item.active {
            color: var(--primary-color);
        }

        .b-nav-item i {
            font-size: 24px;
            display: block;
            margin-bottom: 4px;
        }

        /* Responsive Breakpoint */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bottom-nav { display: flex; }
            .page-scroll { padding: 16px; }
        }

        /* =========================================
           4. COMPONENT LIBRARY
           ========================================= */
        /* Cards */
        .card {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            margin-bottom: 16px;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            gap: 8px;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(15, 91, 184, 0.2); width: 100%; }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-success { background: #dcfce7; color: #166534; }
        .btn-sm { padding: 8px 16px; font-size: 12px; width: auto; height: 32px; }

        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: #f9fafb;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 12px;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            background: white;
        }

        /* Badges & Chips */
        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-new { background: #fee2e2; color: #ef4444; }
        .badge-rec { background: #dcfce7; color: #10b981; }

        /* =========================================
           5. MARKETPLACE UI (Horizontal Scrolls)
           ========================================= */
        .spotlight-wrapper {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 24px;
            scrollbar-width: none;
        }

        .spotlight-card {
            min-width: 280px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: var(--radius-lg);
            padding: 24px;
            color: white;
            position: relative;
            box-shadow: var(--shadow-md);
        }

        .category-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            margin-bottom: 16px;
            padding-bottom: 4px;
        }

        .category-pill {
            background: white;
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .category-pill.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        .product-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 12px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .product-image {
            height: 100px;
            background: #f3f4f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 32px;
            color: #9ca3af;
        }

        /* =========================================
           6. ADMIN DASHBOARD & LISTS
           ========================================= */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 16px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-color);
            display: block;
        }

        .user-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* =========================================
           7. CLASSROOM TOOLS (Chat, Quantum, etc)
           ========================================= */
        .quantum-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .chat-message {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 13px;
            border-left: 3px solid var(--primary-color);
        }

        /* =========================================
           8. OVERLAYS & MODALS
           ========================================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 5000;
            display: none;
            align-items: flex-end; /* Bottom sheet style on mobile */
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-sheet {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @media(min-width: 768px) {
            .modal-overlay { align-items: center; }
            .modal-sheet { border-radius: 24px; }
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 10000;
            display: none;
            flex-direction: column;
        }

        /* UTILS */
        .admin-only { display: none; } /* Toggled via JS */
        .teacher-only { display: none; } /* Toggled via JS */
        .simulation-banner {
            background: #f97316;
            color: white;
            text-align: center;
            padding: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="auth-layer">
        <div class="auth-container">
            <div class="auth-logo">üéì</div>
            <h2 style="color: var(--text-main); margin-bottom: 8px;">Jalaram Academy</h2>
            <p style="color: var(--text-secondary); margin-bottom: 32px;">Enterprise Resource Portal v335</p>

            <div id="auth-step-1">
                <label style="display:block; text-align:left; font-size:12px; font-weight:700; margin-bottom:6px; color:var(--text-secondary);">SELECT ROLE</label>
                <select id="login-role">
                    <option value="Admin">Administrator</option>
                    <option value="Teacher">Faculty / Teacher</option>
                    <option value="Student">Student / Parent</option>
                </select>

                <label style="display:block; text-align:left; font-size:12px; font-weight:700; margin-bottom:6px; color:var(--text-secondary);">USER ID</label>
                <input id="login-id" placeholder="e.g. ADM-001 or STU-1002">

                <button class="btn btn-primary" onclick="AuthSystem.requestOTP()">
                    <i class="material-icons">lock</i> Secure Login
                </button>
                <button class="btn btn-secondary" style="margin-top:12px; width:100%;" onclick="ModalSystem.open('register-modal')">
                    Register New Account
                </button>
            </div>

            <div id="auth-step-2" style="display:none;">
                <h3 style="margin-bottom:8px;">Verify Identity</h3>
                <p id="otp-message" style="font-size:13px; color:var(--success-color); margin-bottom:20px;"></p>
                
                <div class="otp-input-group">
                    <input class="otp-digit" maxlength="1" id="d1" onkeyup="Utils.moveFocus(this,'d2')">
                    <input class="otp-digit" maxlength="1" id="d2" onkeyup="Utils.moveFocus(this,'d3')">
                    <input class="otp-digit" maxlength="1" id="d3" onkeyup="Utils.moveFocus(this,'d4')">
                    <input class="otp-digit" maxlength="1" id="d4" onkeyup="AuthSystem.verifyOTP()">
                </div>

                <button class="btn btn-primary" onclick="AuthSystem.verifyOTP()">Verify Code</button>
                <button class="btn btn-secondary" style="margin-top:12px; width:100%;" onclick="location.reload()">Cancel</button>
            </div>
        </div>
        <div style="margin-top:40px; font-size:11px; color:var(--success-color); font-weight:600;">
            ‚óè System Status: Online & Encrypted
        </div>
    </div>

    <div id="app-layer">
        
        <aside class="sidebar">
            <div class="brand-section">
                <i class="material-icons" style="margin-right:10px;">school</i> Jalaram Academy
            </div>
            <div class="nav-scroll" id="desktop-nav-container">
                </div>
            <div style="padding:20px; border-top:1px solid var(--border-color);">
                <button class="btn btn-danger" style="width:100%;" onclick="AuthSystem.logout()">
                    <i class="material-icons">logout</i> Logout
                </button>
            </div>
        </aside>

        <div class="main-content-col">
            <div class="simulation-banner" id="sim-banner" onclick="location.reload()">
                üëÅÔ∏è SIMULATION MODE ACTIVE - YOU ARE VIEWING AS A USER - TAP TO EXIT
            </div>

            <header class="top-header">
                <div class="row">
                    <h2 id="page-title" style="font-size:18px;">Home</h2>
                </div>
                <div class="row">
                    <div style="text-align:right;">
                        <b style="font-size:14px;" id="header-user-name">User</b><br>
                        <span style="font-size:11px; color:var(--success-color);" id="header-user-role">Role</span>
                    </div>
                    <div class="avatar-circle" id="header-avatar">U</div>
                </div>
            </header>

            <main class="page-scroll" id="main-container">
                </main>
        </div>

        <nav class="bottom-nav" id="mobile-nav-container">
            </nav>
    </div>

    <div id="video-engine" class="fullscreen-overlay">
        <div style="padding:16px; background:#1f2937; color:white; display:flex; justify-content:space-between; align-items:center;">
            <div class="row"><span style="color:red; animation:pulse 1s infinite;">‚óè</span> <b>Live Classroom</b></div>
            <button class="btn-sm btn-danger" onclick="VideoSystem.endCall()">End Class</button>
        </div>
        <div id="jitsi-container" style="flex:1; background:black;"></div>
    </div>

    <div id="exam-engine" class="fullscreen-overlay" style="background:var(--background-color);">
        <div style="padding:16px; background:white; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
            <div class="row"><b>Examination</b> <span id="exam-timer" class="badge badge-new" style="background:#1f2937; color:white;">00:00:00</span></div>
            <button class="btn-sm btn-secondary" onclick="ExamSystem.close()">Exit</button>
        </div>
        <div id="exam-content" style="padding:20px; overflow-y:auto; flex:1;"></div>
    </div>

    <div id="correction-engine" class="fullscreen-overlay" style="background:white; z-index:12000;">
        <div style="padding:16px; background:#1f2937; color:white; display:flex; justify-content:space-between; align-items:center;">
            <b>Red Pen Correction Mode</b>
            <div class="row">
                <button class="btn-sm btn-secondary" style="background:rgba(255,255,255,0.1); color:white; border:none;" onclick="CanvasSystem.clear()">Clear</button>
                <button class="btn-sm btn-success" onclick="CanvasSystem.save()">Save & Mark</button>
                <button class="btn-sm btn-danger" onclick="document.getElementById('correction-engine').style.display='none'">Close</button>
            </div>
        </div>
        <div style="flex:1; overflow-y:auto; background:#f3f4f6; display:flex; flex-direction:column; align-items:center; padding:20px;">
            <div id="canvas-container" style="position:relative; background:white; box-shadow:var(--shadow-md); margin-bottom:20px;">
                <img id="submission-img" style="display:block; max-width:100%; pointer-events:none;">
                <div id="text-submission-view" style="padding:20px; display:none;"></div>
                <canvas id="drawing-layer" style="position:absolute; top:0; left:0; cursor:crosshair;"></canvas>
            </div>
            <div class="card" style="width:100%; max-width:600px;">
                <label style="font-size:12px; font-weight:700;">Assign Grade</label>
                <input id="grade-input" placeholder="e.g. 18/20">
                <label style="font-size:12px; font-weight:700;">Feedback</label>
                <textarea id="feedback-input" placeholder="Teacher remarks..." rows="2"></textarea>
            </div>
        </div>
    </div>

    <div id="register-modal" class="modal-overlay" onclick="ModalSystem.close('register-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3>Create New Account</h3>
            <p style="color:gray; font-size:13px; margin-bottom:20px;">Enter details to generate ID.</p>
            
            <label style="font-size:11px; font-weight:700;">ROLE</label>
            <select id="reg-role" onchange="ModalSystem.toggleRegFields()">
                <option>Student</option>
                <option>Teacher</option>
            </select>

            <label style="font-size:11px; font-weight:700;">FULL NAME</label>
            <input id="reg-name" placeholder="John Doe">

            <div id="reg-student-fields">
                <label style="font-size:11px; font-weight:700;">STUDENT MOBILE</label>
                <input id="reg-sm" type="tel" placeholder="10 Digit Mobile">
                
                <label style="font-size:11px; font-weight:700;">PARENT MOBILE</label>
                <input id="reg-pm" type="tel" placeholder="10 Digit Mobile">
                
                <label style="font-size:11px; font-weight:700;">BATCH</label>
                <select id="reg-batch"></select>
                
                <label style="font-size:11px; font-weight:700;">SUBJECTS</label>
                <input id="reg-stu-subs" placeholder="Maths, Physics (Comma separated)">
            </div>

            <div id="reg-teacher-fields" style="display:none;">
                <label style="font-size:11px; font-weight:700;">SUBJECTS TAUGHT</label>
                <input id="reg-tch-subs" placeholder="Maths, Physics">
            </div>

            <label style="font-size:11px; font-weight:700;">CREATE PIN</label>
            <input id="reg-pin" type="password" placeholder="4 Digit PIN">

            <button class="btn btn-primary" onclick="AuthSystem.register()">Register</button>
        </div>
    </div>

    <div id="course-modal" class="modal-overlay" onclick="ModalSystem.close('course-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3>Add New Course</h3>
            <input id="c-title" placeholder="Course Title (e.g. Master Physics)">
            <div class="row">
                <input id="c-price" type="number" placeholder="Price (‚Çπ)">
                <input id="c-rating" type="number" placeholder="Rating (1-5)">
            </div>
            <label style="font-size:11px; font-weight:700;">CATEGORY</label>
            <select id="c-cat"></select>
            <label style="font-size:11px; font-weight:700;">OFFER TAG</label>
            <input id="c-offer" placeholder="e.g. 50% OFF (Optional)">
            <button class="btn btn-primary" onclick="MarketSystem.addCourse()">Publish Course</button>
        </div>
    </div>

    <div id="edit-user-modal" class="modal-overlay" onclick="ModalSystem.close('edit-user-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3>Manage User Profile</h3>
            <input type="hidden" id="edit-uid">
            
            <label style="font-size:11px; font-weight:700;">FULL NAME</label>
            <input id="edit-name">
            
            <label style="font-size:11px; font-weight:700;">STUDENT MOBILE</label>
            <input id="edit-sm">
            
            <label style="font-size:11px; font-weight:700;">PARENT MOBILE</label>
            <input id="edit-pm">
            
            <label style="font-size:11px; font-weight:700;">BATCH</label>
            <select id="edit-batch"></select>

            <div class="row" style="margin-top:20px;">
                <button class="btn btn-primary" onclick="AdminSystem.saveUserEdit()">Save Changes</button>
                <button class="btn btn-danger" style="width:40%;" onclick="AdminSystem.deleteUser()">Delete User</button>
            </div>
        </div>
    </div>

    <div id="request-modal" class="modal-overlay" onclick="ModalSystem.close('request-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3>Request Profile Update</h3>
            <div class="quantum-box" style="margin-bottom:15px; font-size:12px; color:var(--text-secondary);">
                <b>Maker-Checker Protocol:</b> Changes entered here will be sent to the Admin for approval.
            </div>
            <input type="hidden" id="req-uid">
            <input id="req-name" placeholder="Name">
            <input id="req-sm" placeholder="Student Mobile">
            <input id="req-pm" placeholder="Parent Mobile">
            <button class="btn btn-primary" onclick="ClassroomSystem.submitRequest()">Send Request</button>
        </div>
    </div>

    <div id="upload-modal" class="modal-overlay" onclick="ModalSystem.close('upload-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3>New Assignment</h3>
            <input id="assign-title" placeholder="Title">
            <textarea id="assign-desc" placeholder="Instructions" rows="3"></textarea>
            <label style="font-size:11px; font-weight:700;">DEADLINE</label>
            <input id="assign-date" type="datetime-local">
            <label style="font-size:11px; font-weight:700;">SUBJECT</label>
            <select id="assign-sub"><option>Maths</option><option>Physics</option><option>General</option></select>
            <button class="btn btn-primary" onclick="ClassroomSystem.postAssignment()">Post Assignment</button>
        </div>
    </div>

    <div id="filter-modal" class="modal-overlay" onclick="ModalSystem.close('filter-modal')">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3>Sort & Filter</h3>
            <button class="btn btn-secondary" style="width:100%; margin-bottom:10px;" onclick="MarketSystem.sort('price_asc')">Price: Low to High</button>
            <button class="btn btn-secondary" style="width:100%; margin-bottom:10px;" onclick="MarketSystem.sort('rating_desc')">Rating: High to Low</button>
            <button class="btn btn-secondary" style="width:100%;" onclick="MarketSystem.sort('relevance')">Relevance (Default)</button>
        </div>
    </div>

    <script>
        // --- 1. UTILITIES ---
        const Utils = {
            id: (prefix) => `${prefix}-${Math.floor(Math.random() * 10000)}`,
            moveFocus: (el, nextId) => { if(el.value.length >= 1) document.getElementById(nextId).focus(); },
            now: () => new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
            date: () => new Date().toLocaleDateString(),
            formatCurrency: (n) => '‚Çπ' + n.toLocaleString('en-IN')
        };

        // --- 2. DATABASE LAYER ---
        class Database {
            constructor() {
                this.tables = ['users', 'courses', 'batches', 'categories', 'assignments', 'submissions', 'chats', 'notis', 'requests', 'exams'];
                this.data = {};
                this.tables.forEach(t => {
                    this.data[t] = JSON.parse(localStorage.getItem('ja_' + t)) || [];
                });
                this.seed();
            }

            seed() {
                if (this.data.users.length === 0) {
                    this.data.users.push({ m: 'ADM-001', n: 'System Admin', p: '1234', role: 'Admin', status: 'Active', sm: '9999999999', pm: '8888888888' });
                    this.commit('users');
                }
                if (this.data.batches.length === 0) {
                    this.data.batches = ['Class 10 A', 'Class 12 B', 'NEET Droppers'];
                    this.commit('batches');
                }
                if (this.data.categories.length === 0) {
                    this.data.categories = ['IIT-JEE', 'NEET', 'Foundation', 'Boards'];
                    this.commit('categories');
                }
                if (this.data.courses.length === 0) {
                    this.data.courses = [
                        { id: 1, name: 'Physics Mastery', price: 4999, rating: 4.8, cat: 'IIT-JEE', offer: 'BESTSELLER' },
                        { id: 2, name: 'Biology NCERT', price: 2499, rating: 4.5, cat: 'NEET', offer: 'NEW' }
                    ];
                    this.commit('courses');
                }
            }

            commit(table) {
                localStorage.setItem('ja_' + table, JSON.stringify(this.data[table]));
            }

            add(table, item) {
                if (!item.id) item.id = Date.now();
                this.data[table].push(item);
                this.commit(table);
                return item;
            }

            update(table, id, updates) {
                const idx = this.data[table].findIndex(x => x.id == id || x.m == id);
                if (idx !== -1) {
                    this.data[table][idx] = { ...this.data[table][idx], ...updates };
                    this.commit(table);
                }
            }

            delete(table, id) {
                this.data[table] = this.data[table].filter(x => x.id != id && x.m != id);
                this.commit(table);
            }

            get(table) { return this.data[table]; }
        }
        const DB = new Database();

        // --- 3. AUTHENTICATION SYSTEM ---
        const AuthSystem = {
            currentUser: null,
            tempUser: null,
            otpCode: null,

            requestOTP: () => {
                const id = document.getElementById('login-id').value;
                const role = document.getElementById('login-role').value;
                const user = DB.get('users').find(u => u.m === id && u.role === role);

                if (user) {
                    if (user.status === 'Pending') return alert("Account pending Admin approval.");
                    
                    AuthSystem.tempUser = user;
                    
                    // Smart Switch Logic
                    if (window.firebase) {
                        console.log("Cloud Environment Detected: Triggering Firebase Auth");
                    } else {
                        // Simulation Mode
                        AuthSystem.otpCode = Math.floor(1000 + Math.random() * 9000);
                        const msg = `OTP ${AuthSystem.otpCode} sent to ${user.sm || 'Mobile'} & ${user.pm || 'Parent'}`;
                        document.getElementById('otp-message').innerText = msg;
                        alert(msg); // Browser Alert for visibility
                    }

                    document.getElementById('auth-step-1').style.display = 'none';
                    document.getElementById('auth-step-2').style.display = 'block';
                } else {
                    alert("User ID not found in database.");
                }
            },

            verifyOTP: () => {
                const input = [1,2,3,4].map(i => document.getElementById('d'+i).value).join('');
                if (window.firebase || input == AuthSystem.otpCode) {
                    AuthSystem.currentUser = AuthSystem.tempUser;
                    document.getElementById('auth-layer').style.display = 'none';
                    document.getElementById('app-layer').style.display = 'flex';
                    Router.init();
                } else {
                    alert("Incorrect OTP");
                }
            },

            register: () => {
                const role = document.getElementById('reg-role').value;
                const prefix = role === 'Student' ? 'STU' : 'TCH';
                const newId = Utils.id(prefix);
                
                // If Admin is adding manually, status is Active. Else Pending.
                const isAdmin = AuthSystem.currentUser && AuthSystem.currentUser.role === 'Admin';
                const status = isAdmin ? 'Active' : 'Pending';

                const newUser = {
                    m: newId,
                    n: document.getElementById('reg-name').value,
                    p: document.getElementById('reg-pin').value || '1234',
                    role: role,
                    status: status,
                    batch: document.getElementById('reg-batch').value,
                    sm: document.getElementById('reg-sm').value,
                    pm: document.getElementById('reg-pm').value,
                    subs: (document.getElementById('reg-stu-subs').value || document.getElementById('reg-tch-subs').value || '').split(',').map(s=>s.trim())
                };

                DB.add('users', newUser);
                
                if (isAdmin) {
                    alert(`User Created Successfully!\nID: ${newId}`);
                    ModalSystem.close('register-modal');
                    Router.loadPage('Admin');
                } else {
                    alert(`Registration Request Sent!\nYour ID: ${newId}\nPlease save this ID.`);
                    ModalSystem.close('register-modal');
                }
            },

            logout: () => location.reload()
        };

        // --- 4. ROUTER & NAVIGATION ---
        const Router = {
            init: () => {
                const u = AuthSystem.currentUser;
                
                // Update Header
                document.getElementById('header-user-name').innerText = u.n;
                document.getElementById('header-user-role').innerText = u.role;
                document.getElementById('header-avatar').innerText = u.n.charAt(0);

                // Role-Based Visibility
                if (u.role === 'Admin') document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
                if (u.role !== 'Student') document.querySelectorAll('.teacher-only').forEach(e => e.style.display = 'block');

                // Generate Menus
                const menus = Router.getMenus(u.role);
                Router.renderNav(menus);
                
                // Load Default Page
                Router.loadPage(menus[0].name);
            },

            getMenus: (role) => {
                const common = [
                    { name: 'Home', icon: 'home' },
                    { name: 'Courses', icon: 'menu_book' },
                    { name: 'Chat', icon: 'chat' },
                    { name: 'Store', icon: 'store' }
                ];
                if (role === 'Admin') return [
                    { name: 'Admin', icon: 'admin_panel_settings' },
                    { name: 'Batches', icon: 'class' },
                    ...common.slice(1)
                ];
                if (role === 'Teacher') return [
                    { name: 'Batches', icon: 'class' },
                    ...common
                ];
                return common;
            },

            renderNav: (menus) => {
                const deskHTML = menus.map(m => `
                    <div class="nav-item" onclick="Router.loadPage('${m.name}')" id="nav-${m.name}">
                        <i class="material-icons">${m.icon}</i> ${m.name}
                    </div>
                `).join('');
                
                const mobHTML = menus.map(m => `
                    <div class="b-nav-item" onclick="Router.loadPage('${m.name}')" id="mob-${m.name}">
                        <i class="material-icons">${m.icon}</i> ${m.name}
                    </div>
                `).join('');

                document.getElementById('desktop-nav-container').innerHTML = deskHTML;
                document.getElementById('mobile-nav-container').innerHTML = mobHTML;
            },

            loadPage: (pageName) => {
                document.getElementById('page-title').innerText = pageName;
                const container = document.getElementById('main-container');
                container.innerHTML = ''; // Clear

                // Highlight Nav
                document.querySelectorAll('.nav-item, .b-nav-item').forEach(e => e.classList.remove('active'));
                const deskNav = document.getElementById(`nav-${pageName}`);
                const mobNav = document.getElementById(`mob-${pageName}`);
                if (deskNav) deskNav.classList.add('active');
                if (mobNav) mobNav.classList.add('active');

                // Render Content
                switch(pageName) {
                    case 'Home': Pages.renderHome(container); break;
                    case 'Admin': Pages.renderAdmin(container); break;
                    case 'Courses': Pages.renderMarketplace(container); break;
                    case 'Batches': Pages.renderBatches(container); break;
                    case 'Chat': Pages.renderChat(container); break;
                    case 'Store': Pages.renderStore(container); break;
                }
            }
        };

        // --- 5. PAGE RENDERERS ---
        const Pages = {
            renderHome: (el) => {
                const u = AuthSystem.currentUser;
                const schedule = DB.get('assignments').filter(a => a.subject === 'General' || (u.subs||[]).includes(a.subject)); // Simplified Logic
                
                el.innerHTML = `
                    <div class="card" style="background: linear-gradient(135deg, #0f5bb8, #3b82f6); color:white;">
                        <h3>üëã Welcome back, ${u.n}</h3>
                        <p style="opacity:0.9; margin-top:5px;">You have ${schedule.length} active updates.</p>
                    </div>

                    <div class="card" style="background:#f0f9ff; border-color:#bae6fd;">
                        <h4 style="margin-bottom:12px; color:var(--primary-color);">üìÖ Today's Schedule (Quantum Planner)</h4>
                        ${schedule.length ? schedule.map(s => `
                            <div class="row" style="padding:10px 0; border-bottom:1px solid #e0f2fe;">
                                <div><b>${s.title}</b><br><small>${s.subject}</small></div>
                                <button class="btn btn-sm btn-primary" onclick="VideoSystem.joinClass('${s.subject}')">Join</button>
                            </div>
                        `).join('') : '<p style="font-size:13px; color:gray;">No live classes scheduled.</p>'}
                    </div>

                    <div class="card">
                        <h4>üì¢ Notice Board</h4>
                        ${DB.get('notis').slice(0, 3).map(n => `<div class="chat-message">${n.msg} <small style="float:right">${n.date}</small></div>`).join('')}
                    </div>
                `;
            },

            renderAdmin: (el) => {
                const pending = DB.get('users').filter(u => u.status === 'Pending');
                const reqs = DB.get('requests');
                const users = DB.get('users').filter(u => u.status === 'Active');

                el.innerHTML = `
                    <div class="stat-grid">
                        <div class="stat-box"><span class="stat-value">${users.length}</span>Active Users</div>
                        <div class="stat-box"><span class="stat-value">${DB.get('courses').length}</span>Courses</div>
                    </div>

                    <div class="card">
                        <h4>Quick Actions</h4>
                        <div class="row" style="margin-top:10px;">
                            <button class="btn btn-secondary" onclick="ModalSystem.openCategoryManager()">Manage Categories</button>
                            <button class="btn btn-secondary" onclick="ModalSystem.open('register-modal')">Add User</button>
                        </div>
                    </div>

                    ${pending.length > 0 ? `
                        <div class="card" style="border-left:4px solid var(--danger-color);">
                            <h4>‚ö†Ô∏è Pending Registrations (${pending.length})</h4>
                            ${pending.map(u => `
                                <div class="user-list-item">
                                    <div><b>${u.n}</b><br><small>${u.role}</small></div>
                                    <div style="margin-left:auto; display:flex; gap:8px;">
                                        <button class="btn btn-sm btn-success" onclick="AdminSystem.approve('${u.m}')">Accept</button>
                                        <button class="btn btn-sm btn-secondary" onclick="AdminSystem.edit('${u.m}')">Edit</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    ${reqs.length > 0 ? `
                        <div class="card" style="border-left:4px solid var(--warning-color);">
                            <h4>üìù Profile Change Requests (${reqs.length})</h4>
                            ${reqs.map(r => `
                                <div class="user-list-item">
                                    <div><small>Request by ${r.requester}</small><br><b>Target: ${r.targetName}</b></div>
                                    <button class="btn btn-sm btn-primary" onclick="AdminSystem.processRequest('${r.id}', true)">Approve</button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <div class="card">
                        <h4>User Database</h4>
                        <input placeholder="Search users..." onkeyup="AdminSystem.filterUsers(this.value)" style="margin-top:10px;">
                        <div id="admin-user-list">
                            ${users.map(u => `
                                <div class="user-list-item">
                                    <div class="avatar-circle">${u.n[0]}</div>
                                    <div style="flex:1;"><b>${u.n}</b><br><small>${u.m} ‚Ä¢ ${u.role}</small></div>
                                    <button class="btn btn-sm btn-secondary" onclick="AdminSystem.edit('${u.m}')">Edit</button>
                                    <button class="btn btn-sm btn-success" onclick="AdminSystem.simulate('${u.m}')">üëÅ</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderMarketplace: (el) => {
                const courses = DB.get('courses');
                el.innerHTML = `
                    <div class="spotlight-wrapper">
                        <div class="spotlight-card">
                            <span class="badge badge-new" style="background:rgba(255,255,255,0.2); color:white;">RECOMMENDED</span>
                            <h3>Physics Masterclass</h3>
                            <p style="font-size:13px; opacity:0.9; margin-top:5px;">Complete syllabus coverage for IIT-JEE.</p>
                            <button class="btn btn-sm btn-secondary" style="margin-top:10px;">View Details</button>
                        </div>
                        <div class="spotlight-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <span class="badge badge-new" style="background:rgba(255,255,255,0.2); color:white;">NEW</span>
                            <h3>NEET Biology</h3>
                            <p style="font-size:13px; opacity:0.9; margin-top:5px;">NCERT Line-by-line breakdown.</p>
                            <button class="btn btn-sm btn-secondary" style="margin-top:10px;">View Details</button>
                        </div>
                    </div>

                    <div class="row" style="margin-bottom:10px;">
                        <div class="category-scroll" id="cat-scroll-container">
                            </div>
                        <button class="btn btn-sm btn-secondary" onclick="ModalSystem.open('filter-modal')">
                            <i class="material-icons">tune</i>
                        </button>
                    </div>

                    <div class="admin-only" style="margin-bottom:16px;">
                        <button class="btn btn-primary" onclick="MarketSystem.openAddCourse()">+ Add New Course</button>
                    </div>

                    <div class="product-grid" id="market-grid">
                        ${MarketSystem.generateGridHTML(courses)}
                    </div>
                `;
                MarketSystem.renderCategories();
                
                // Re-apply admin visibility logic after rendering HTML
                if(AuthSystem.currentUser.role === 'Admin') document.querySelectorAll('.admin-only').forEach(e=>e.style.display='block');
            },

            renderBatches: (el) => {
                const u = AuthSystem.currentUser;
                const isTeacher = u.role === 'Teacher' || u.role === 'Admin';
                
                // Quantum Generator is for Teachers
                const quantumHTML = isTeacher ? `
                    <div class="quantum-box">
                        <div class="row">
                            <b style="color:var(--primary-color);">‚ö° QUANTUM GENERATOR</b>
                            <span class="badge badge-rec">ONLINE</span>
                        </div>
                        <div class="row" style="margin-top:10px;">
                            <input id="q-msg" placeholder="Message (e.g. Class Delayed)" style="margin:0; width:60%;">
                            <select id="q-time" style="margin:0; width:35%;">
                                <option value="">Now</option>
                                <option value="in 10m">in 10m</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm" style="width:100%; margin-top:10px;" onclick="ClassroomSystem.sendQuantum()">Send Blast</button>
                    </div>
                ` : '';

                el.innerHTML = `
                    ${quantumHTML}
                    <div class="card">
                        <div class="row">
                            <h3>My Batches</h3>
                            ${u.role==='Admin' ? '<button class="btn btn-sm btn-secondary" onclick="ClassroomSystem.addBatch()">+ New</button>' : ''}
                        </div>
                        <div class="product-grid" style="margin-top:16px;">
                            ${DB.get('batches').map(b => `
                                <div class="product-card" onclick="ClassroomSystem.openBatch('${b}')" style="cursor:pointer; text-align:center;">
                                    <i class="material-icons" style="font-size:40px; color:#9ca3af; margin-bottom:10px;">school</i>
                                    <b>${b}</b>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Assignments & Tests</h3>
                        ${isTeacher ? '<button class="btn btn-secondary" onclick="ModalSystem.open(\'upload-modal\')">+ Create New</button>' : ''}
                        <div style="margin-top:16px;">
                            ${DB.get('assignments').map(a => `
                                <div class="user-list-item">
                                    <div><b>${a.title}</b><br><small>${a.subject}</small></div>
                                    <button class="btn btn-sm btn-primary" onclick="ClassroomSystem.handleAssignment('${a.id}')">
                                        ${u.role==='Student' ? 'Submit' : 'Check'}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            renderChat: (el) => {
                const u = AuthSystem.currentUser;
                const chats = DB.get('chats');
                el.innerHTML = `
                    <div class="card" style="height:calc(100vh - 180px); display:flex; flex-direction:column;">
                        <div style="flex:1; background:#f9fafb; border-radius:12px; padding:16px; overflow-y:auto; margin-bottom:16px;">
                            ${chats.map(c => `
                                <div style="margin-bottom:12px;">
                                    <b style="color:${c.sender===u.n?'var(--primary-color)':'var(--text-main)'};">${c.sender}</b>: 
                                    <span style="color:var(--text-secondary);">${c.msg}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="row">
                            <input id="chat-input" placeholder="Type a message..." style="margin:0;">
                            <button class="btn btn-primary" onclick="ClassroomSystem.sendChat()"><i class="material-icons">send</i></button>
                        </div>
                    </div>
                    ${u.role === 'Admin' ? '<div class="card" style="background:#fff7ed; border-color:#fed7aa;"><h3>üïµÔ∏è Spy Monitor Active</h3><p style="font-size:12px;">You are viewing the global chat stream.</p></div>' : ''}
                `;
            },

            renderStore: (el) => {
                el.innerHTML = `
                    <div class="card" style="background:#f0fdf4; border-color:#bbf7d0;">
                        <h4 style="color:#166534; margin-bottom:10px;">Free Demo Classes</h4>
                        <div class="row" style="border-bottom:1px solid #dcfce7; padding:10px 0; cursor:pointer;" onclick="VideoSystem.playMedia('Demo: Calculus')">
                            <div style="display:flex; align-items:center; gap:10px;"><i class="material-icons" style="color:#166534;">play_circle</i> <b>Calculus Intro</b></div>
                            <span class="badge badge-rec">Free</span>
                        </div>
                        <div class="row" style="padding:10px 0; cursor:pointer;" onclick="VideoSystem.playMedia('Demo: Optics')">
                            <div style="display:flex; align-items:center; gap:10px;"><i class="material-icons" style="color:#166534;">play_circle</i> <b>Ray Optics</b></div>
                            <span class="badge badge-rec">Free</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4>Premium Study Material</h4>
                        <p style="color:gray; font-size:13px;">Purchase a course to unlock.</p>
                        <div class="user-list-item" style="opacity:0.6;">
                            <i class="material-icons" style="color:#ef4444;">picture_as_pdf</i> 
                            <div><b>HC Verma Solutions</b><br><small>Locked</small></div>
                            <i class="material-icons">lock</i>
                        </div>
                    </div>
                `;
            }
        };

        // --- 6. FEATURE SYSTEMS ---
        const AdminSystem = {
            approve: (id) => { DB.update('users', id, {status:'Active'}); Router.loadPage('Admin'); },
            edit: (id) => {
                const u = DB.get('users').find(x => x.m === id);
                document.getElementById('edit-uid').value = id;
                document.getElementById('edit-name').value = u.n;
                document.getElementById('edit-sm').value = u.sm || '';
                document.getElementById('edit-pm').value = u.pm || '';
                // Populate Batches
                document.getElementById('edit-batch').innerHTML = DB.get('batches').map(b => `<option ${u.batch===b?'selected':''}>${b}</option>`).join('');
                ModalSystem.open('edit-user-modal');
            },
            saveUserEdit: () => {
                const id = document.getElementById('edit-uid').value;
                DB.update('users', id, {
                    n: document.getElementById('edit-name').value,
                    sm: document.getElementById('edit-sm').value,
                    pm: document.getElementById('edit-pm').value,
                    batch: document.getElementById('edit-batch').value
                });
                ModalSystem.close('edit-user-modal');
                Router.loadPage('Admin');
            },
            deleteUser: () => {
                if(confirm("Are you sure?")) {
                    DB.delete('users', document.getElementById('edit-uid').value);
                    ModalSystem.close('edit-user-modal');
                    Router.loadPage('Admin');
                }
            },
            simulate: (id) => {
                const u = DB.get('users').find(x => x.m === id);
                AuthSystem.currentUser = u;
                document.getElementById('sim-banner').style.display = 'block';
                Router.init();
            },
            filterUsers: (q) => {
                const term = q.toLowerCase();
                const users = DB.get('users').filter(u => u.status==='Active' && (u.n.toLowerCase().includes(term) || u.m.toLowerCase().includes(term)));
                document.getElementById('admin-user-list').innerHTML = users.map(u => `
                    <div class="user-list-item">
                        <div class="avatar-circle">${u.n[0]}</div>
                        <div style="flex:1;"><b>${u.n}</b><br><small>${u.m} ‚Ä¢ ${u.role}</small></div>
                        <button class="btn btn-sm btn-secondary" onclick="AdminSystem.edit('${u.m}')">Edit</button>
                        <button class="btn btn-sm btn-success" onclick="AdminSystem.simulate('${u.m}')">üëÅ</button>
                    </div>
                `).join('');
            },
            processRequest: (rid, approved) => {
                const req = DB.get('requests').find(r => r.id == rid);
                if(approved) {
                    DB.update('users', req.targetUid, req.changes);
                    alert("Changes Applied!");
                }
                DB.delete('requests', rid);
                Router.loadPage('Admin');
            }
        };

        const MarketSystem = {
            renderCategories: () => {
                const cats = ['All', ...DB.get('categories')];
                document.getElementById('cat-scroll-container').innerHTML = cats.map(c => `
                    <div class="category-pill ${c==='All'?'active':''}" onclick="MarketSystem.filter('${c}', this)">${c}</div>
                `).join('');
            },
            filter: (cat, el) => {
                document.querySelectorAll('.category-pill').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
                const list = cat === 'All' ? DB.get('courses') : DB.get('courses').filter(c => c.cat === cat);
                document.getElementById('market-grid').innerHTML = MarketSystem.generateGridHTML(list);
            },
            generateGridHTML: (list) => {
                return list.map(i => `
                    <div class="product-card">
                        ${i.offer ? `<span class="badge badge-new" style="position:absolute; top:10px; left:10px;">${i.offer}</span>` : ''}
                        <div class="product-image"><i class="material-icons">menu_book</i></div>
                        <b style="font-size:14px; margin-bottom:4px;">${i.name}</b>
                        <div class="row">
                            <span style="font-weight:800; font-size:14px;">${Utils.formatCurrency(i.price)}</span>
                            <span style="font-size:12px; color:#f59e0b;">‚òÖ ${i.rating}</span>
                        </div>
                        <button class="btn btn-sm btn-primary" style="margin-top:10px; width:100%;" onclick="alert('Enrolled in ${i.name}')">Enroll Now</button>
                        ${AuthSystem.currentUser.role === 'Admin' ? `<i class="material-icons" style="position:absolute; bottom:10px; right:10px; color:red; cursor:pointer;" onclick="MarketSystem.deleteCourse(${i.id})">delete</i>` : ''}
                    </div>
                `).join('');
            },
            openAddCourse: () => {
                document.getElementById('c-cat').innerHTML = DB.get('categories').map(c => `<option>${c}</option>`).join('');
                ModalSystem.open('course-modal');
            },
            addCourse: () => {
                DB.add('courses', {
                    name: document.getElementById('c-title').value,
                    price: parseInt(document.getElementById('c-price').value),
                    rating: parseFloat(document.getElementById('c-rating').value),
                    cat: document.getElementById('c-cat').value,
                    offer: document.getElementById('c-offer').value
                });
                ModalSystem.close('course-modal');
                Router.loadPage('Courses');
            },
            deleteCourse: (id) => {
                if(confirm("Delete Course?")) {
                    DB.delete('courses', id);
                    Router.loadPage('Courses');
                }
            },
            sort: (type) => {
                let list = DB.get('courses');
                if(type === 'price_asc') list.sort((a,b) => a.price - b.price);
                if(type === 'rating_desc') list.sort((a,b) => b.rating - a.rating);
                document.getElementById('market-grid').innerHTML = MarketSystem.generateGridHTML(list);
                ModalSystem.close('filter-modal');
            }
        };

        const ClassroomSystem = {
            openBatch: (name) => {
                alert("Opening Batch View for: " + name);
                // Implementation would switch to a Batch Details sub-view
            },
            addBatch: () => {
                let n = prompt("New Batch Name:");
                if(n) { DB.add('batches', n); Router.loadPage('Batches'); }
            },
            sendQuantum: () => {
                const msg = document.getElementById('q-msg').value;
                const time = document.getElementById('q-time').value;
                if(msg) {
                    DB.add('notis', { msg: `‚ö° ${msg} ${time}`, date: Utils.now() });
                    alert("Quantum Blast Sent!");
                }
            },
            postAssignment: () => {
                DB.add('assignments', {
                    title: document.getElementById('assign-title').value,
                    desc: document.getElementById('assign-desc').value,
                    date: document.getElementById('assign-date').value,
                    subject: document.getElementById('assign-sub').value
                });
                ModalSystem.close('upload-modal');
                Router.loadPage('Batches');
            },
            handleAssignment: (id) => {
                if (AuthSystem.currentUser.role === 'Student') {
                    alert("Opening Submission Form...");
                } else {
                    document.getElementById('correction-engine').style.display = 'flex';
                    CanvasSystem.init();
                }
            },
            submitRequest: () => {
                const uid = AuthSystem.currentUser.m; // In real flow, Teacher selects Student
                // For this demo, assuming Teacher requests change for a student ID entered manually or implied
                // Simplified:
                alert("Request Sent to Admin!");
                ModalSystem.close('request-modal');
            },
            sendChat: () => {
                const txt = document.getElementById('chat-input').value;
                if(txt) {
                    DB.add('chats', { sender: AuthSystem.currentUser.n, msg: txt });
                    document.getElementById('chat-input').value = '';
                    Router.loadPage('Chat');
                }
            }
        };

        const VideoSystem = {
            joinClass: (room) => {
                document.getElementById('video-engine').style.display = 'flex';
                const domain = 'meet.jit.si';
                const options = {
                    roomName: room || 'JalaramGeneralRoom',
                    width: '100%',
                    height: '100%',
                    parentNode: document.querySelector('#jitsi-container'),
                    userInfo: { displayName: AuthSystem.currentUser.n }
                };
                VideoSystem.api = new JitsiMeetExternalAPI(domain, options);
            },
            endCall: () => {
                if (VideoSystem.api) VideoSystem.api.dispose();
                document.getElementById('video-engine').style.display = 'none';
            },
            playMedia: (title) => {
                alert("Playing Demo Video: " + title);
            }
        };

        const CanvasSystem = {
            init: () => {
                const canvas = document.getElementById('drawing-layer');
                const ctx = canvas.getContext('2d');
                canvas.width = 600; canvas.height = 800; // Demo size
                ctx.strokeStyle = "red";
                ctx.lineWidth = 2;
                
                let isDrawing = false;
                canvas.onmousedown = (e) => { isDrawing = true; ctx.moveTo(e.offsetX, e.offsetY); };
                canvas.onmousemove = (e) => { if(isDrawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } };
                canvas.onmouseup = () => { isDrawing = false; };
            },
            clear: () => {
                const c = document.getElementById('drawing-layer');
                const ctx = c.getContext('2d');
                ctx.clearRect(0, 0, c.width, c.height);
            },
            save: () => {
                alert("Marked & Saved!");
                document.getElementById('correction-engine').style.display = 'none';
            }
        };

        const ExamSystem = {
            close: () => document.getElementById('exam-engine').style.display = 'none'
        };

        const ModalSystem = {
            open: (id) => { 
                document.getElementById(id).style.display = 'flex';
                // Dynamic Batch Population
                if(id==='register-modal' || id==='edit-user-modal') {
                    const batches = DB.get('batches');
                    const opts = batches.map(b => `<option>${b}</option>`).join('');
                    if(document.getElementById('reg-batch')) document.getElementById('reg-batch').innerHTML = opts;
                    if(document.getElementById('edit-batch')) document.getElementById('edit-batch').innerHTML = opts;
                } 
            },
            close: (id) => document.getElementById(id).style.display = 'none',
            toggleRegFields: () => {
                const r = document.getElementById('reg-role').value;
                document.getElementById('reg-student-fields').style.display = r === 'Student' ? 'block' : 'none';
                document.getElementById('reg-teacher-fields').style.display = r === 'Teacher' ? 'block' : 'none';
            },
            openCategoryManager: () => {
                let c = prompt("Enter new Category Name:");
                if(c) { DB.add('categories', c); Router.loadPage('Admin'); }
            }
        };

        // --- 7. INITIALIZATION ---
        // Nothing needed here, Auth Layer handles first interaction.
    </script>
</body>
</html>
