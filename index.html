<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalaram Academy | v333 Master</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --primary: #0f5bb8;
            --primary-dark: #0a3d7c;
            --bg: #f8fafc;
            --text: #0f172a;
            --danger: #ef4444;
            --success: #22c55e;
            --warn: #f59e0b;
            --surface: #ffffff;
            --border: #e2e8f0;
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color:transparent; user-select:none; }
        body { background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* --- 2. UNIVERSAL UI KIT --- */
        .btn {
            width:100%; padding:14px; border-radius:12px; border:none;
            font-weight:700; cursor:pointer; font-size:14px;
            display:flex; align-items:center; justify-content:center;
            gap:8px; transition:0.2s;
        }
        .btn:active { transform:scale(0.98); }
        .btn-main { background:var(--primary); color:white; box-shadow:0 4px 10px rgba(15,91,184,0.2); }
        .btn-sec { background:white; color:#334155; border:1px solid #cbd5e1; }
        .btn-danger { background:#fee2e2; color:#b91c1c; }
        .btn-sm { width:auto; padding:6px 12px; font-size:11px; margin:0; height:30px; }

        .card {
            background:var(--surface); border-radius:16px; padding:16px;
            margin-bottom:12px; border:1px solid #e2e8f0;
            box-shadow:0 2px 4px rgba(0,0,0,0.02);
        }

        .row { display:flex; align-items:center; justify-content:space-between; }
        
        input, select, textarea {
            width:100%; padding:12px; border:1px solid #cbd5e1;
            border-radius:10px; margin-bottom:10px; outline:none;
            background:#f8fafc; font-size:14px; font-family:inherit;
        }
        input:focus { border-color:var(--primary); background:white; }

        /* --- 3. APP STRUCTURE --- */
        #auth-layer {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:white; z-index:5000;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            padding:30px;
        }
        
        #app-layer { display:none; height:100%; flex-direction:column; }

        .app-header {
            background:white; padding:15px; border-bottom:1px solid #e2e8f0;
            display:flex; align-items:center; justify-content:space-between;
        }

        .main-content { flex:1; overflow-y:auto; padding:15px; padding-bottom:100px; }
        
        .bot-nav {
            position:fixed; bottom:0; width:100%; background:white;
            display:flex; justify-content:space-around;
            padding:12px 10px 25px 10px; border-top:1px solid #e2e8f0;
            z-index:1000;
        }
        .nav-item { text-align:center; color:#94a3b8; font-size:10px; font-weight:600; cursor:pointer; }
        .nav-item.active { color:var(--primary); }
        .nav-item i { font-size:24px; display:block; margin-bottom:4px; }

        /* --- 4. ADMIN DASHBOARD WIDGETS --- */
        .stat-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px; }
        .stat-card {
            background:#f0f9ff; border:1px solid #bae6fd;
            padding:15px; border-radius:12px; text-align:center;
        }
        .stat-num { font-size:24px; font-weight:800; color:var(--primary); display:block; }
        .stat-label { font-size:11px; color:#64748b; font-weight:600; text-transform:uppercase; }
        
        .user-row {
            display:flex; align-items:center; padding:12px;
            border-bottom:1px solid #eee; gap:12px;
        }
        .user-av {
            width:40px; height:40px; background:#e2e8f0;
            border-radius:50%; display:flex; align-items:center;
            justify-content:center; font-weight:bold; color:#64748b; font-size:14px;
        }
        .action-icon {
            width:32px; height:32px; border-radius:8px;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; margin-left:5px;
        }

        /* --- 5. QUANTUM & ALERTS --- */
        .schedule-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border:1px solid #bae6fd; padding:15px;
            border-radius:12px; margin-bottom:10px;
            border-left:4px solid var(--primary);
        }
        .quantum-box {
            background:#eff6ff; padding:10px; border-radius:8px;
            margin-bottom:10px; border:1px solid #bfdbfe;
        }
        .chat-msg {
            background:#f1f5f9; padding:10px; border-radius:10px;
            margin-bottom:10px; font-size:13px; border-left:3px solid var(--primary);
        }
        .sim-banner {
            background:#f97316; color:white; text-align:center;
            padding:8px; font-weight:bold; font-size:11px;
            cursor:pointer; display:none;
        }

        /* --- 6. MODALS & SHEETS --- */
        .sheet-overlay {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:9000;
            display:none; align-items:flex-end; backdrop-filter:blur(2px);
        }
        .sheet {
            background:white; width:100%; border-radius:24px 24px 0 0;
            padding:24px; max-height:90vh; overflow-y:auto;
            animation:slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        @keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }

        /* --- 7. FULLSCREEN PLAYERS --- */
        .fullscreen-overlay {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:black; z-index:10000;
            display:none; flex-direction:column;
        }
        .fs-header {
            padding:15px; background:rgba(20,20,20,0.9); color:white;
            display:flex; justify-content:space-between; align-items:center;
        }
        .fs-content { flex:1; width:100%; height:100%; background:black; overflow-y:auto; padding:20px; }

        /* --- 8. UTILS --- */
        .sub-nav { display:flex; gap:20px; border-bottom:1px solid #e2e8f0; margin-bottom:15px; overflow-x:auto; }
        .sub-item { font-size:13px; font-weight:600; color:#64748b; cursor:pointer; padding-bottom:10px; border-bottom:2px solid transparent; white-space:nowrap; }
        .sub-item.active { color:var(--primary); border-bottom-color:var(--primary); }
        .chk-row { display:flex; align-items:center; padding:10px; background:#f1f5f9; border-radius:8px; margin-bottom:8px; }
        .chk-row input { width:auto; margin:0 10px 0 0; }
        .otp-box { display:flex; gap:10px; justify-content:center; margin:20px 0; }
        .otp-digit { width:50px; height:60px; font-size:24px; text-align:center; border:2px solid #e2e8f0; border-radius:10px; font-weight:700; }
        #canvas-container { position:relative; width:100%; overflow:hidden; touch-action:none; border:2px solid #ddd; border-radius:8px; }
        canvas { position:absolute; top:0; left:0; cursor:crosshair; }
        .badge { font-size:10px; padding:4px 8px; border-radius:6px; font-weight:700; text-transform:uppercase; }
        .b-admin { background:#1e293b; color:white; } 
        .b-student { background:#fff7ed; color:#c2410c; border:1px solid #fdba74; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="auth-layer">
        <div style="font-size:64px; margin-bottom:20px;">üéì</div>
        <h2 style="color:var(--text); margin-bottom:10px;">Jalaram Academy</h2>
        <p style="color:#64748b; margin-bottom:30px; font-size:14px;">Enterprise Portal v333</p>
        
        <div id="auth-step-1" style="width:100%; max-width:320px;">
            <select id="l-role">
                <option value="Admin">Admin</option>
                <option value="Teacher">Teacher</option>
                <option value="Student">Student</option>
            </select>
            <input id="l-id" placeholder="User ID (e.g. ADM-001)">
            <button class="btn btn-main" onclick="AuthService.requestOtp()">Secure Login</button>
            <button class="btn btn-sec" style="margin-top:12px;" onclick="Router.openSheet('reg-sheet')">New Registration</button>
        </div>

        <div id="auth-step-2" style="width:100%; max-width:320px; display:none; text-align:center;">
            <p id="otp-hint" style="font-size:12px; color:green; margin-bottom:10px;"></p>
            <div class="otp-box">
                <input class="otp-digit" maxlength="1" id="d1" onkeyup="move(this,'d2')">
                <input class="otp-digit" maxlength="1" id="d2" onkeyup="move(this,'d3')">
                <input class="otp-digit" maxlength="1" id="d3" onkeyup="move(this,'d4')">
                <input class="otp-digit" maxlength="1" id="d4" onkeyup="AuthService.verifyOtp()">
            </div>
            <button class="btn btn-main" onclick="AuthService.verifyOtp()">Verify Identity</button>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="location.reload()">Cancel</button>
        </div>
        
        <div style="margin-top:50px; font-size:10px; color:green;">‚óè System: Online & Secure</div>
    </div>

    <div id="app-layer">
        <div class="sim-banner" id="sim-bar" onclick="location.reload()">
            üëÅÔ∏è SIMULATION MODE ACTIVE: Tap to Exit & Logout
        </div>

        <div class="app-header">
            <div>
                <b style="font-size:16px;">Jalaram Academy</b>
                <div style="font-size:11px; color:#64748b;" id="user-greeting">Welcome</div>
            </div>
            <i class="material-icons" style="color:#64748b; cursor:pointer;" onclick="AuthService.logout()">logout</i>
        </div>

        <main class="main-content">
            <div id="pane-container"></div>
        </main>

        <div class="bot-nav" id="bot-nav"></div>
    </div>

    <div id="video-room" class="fullscreen-overlay">
        <div class="fs-header">
            <div class="row" style="gap:10px;"><span style="color:red; animation:pulse 2s infinite;">‚óè</span> <b>Live Class</b></div>
            <button class="btn-sm btn-danger" onclick="VideoService.endCall()">End Class</button>
        </div>
        <div id="jitsi-container" class="fs-content" style="padding:0;"></div>
    </div>

    <div id="content-player" class="fullscreen-overlay">
        <div class="fs-header">
            <b>Learning Mode</b>
            <button class="btn-sm btn-sec" onclick="ContentService.close()">Close</button>
        </div>
        <div id="player-container" class="fs-content" style="padding:0;"></div>
    </div>

    <div id="quiz-player" class="fullscreen-overlay" style="background:#f8fafc;">
        <div class="fs-header" style="background:white; color:#333; border-bottom:1px solid #eee;">
            <div class="row" style="gap:10px;">
                <b>Exam</b>
                <span id="exam-countdown" style="background:#333;color:white;padding:3px 6px;border-radius:4px;font-size:12px;display:none;">00:00</span>
            </div>
            <button class="btn-sm btn-sec" onclick="QuizService.close()">Exit</button>
        </div>
        <div id="quiz-container" class="fs-content" style="background:#f8fafc; color:#333;"></div>
    </div>
    
    <div id="checker-player" class="fullscreen-overlay" style="background:white; z-index:10002;">
        <div class="fs-header" style="background:#333; color:white;">
            <b>Correction Mode</b>
            <div style="display:flex; gap:10px">
                <button class="btn-sm btn-sec" onclick="CanvasEngine.clear()">Clear</button>
                <button class="btn-sm btn-main" onclick="CanvasEngine.saveAndMark()">Save</button>
                <button class="btn-sm btn-danger" onclick="document.getElementById('checker-player').style.display='none'">X</button>
            </div>
        </div>
        <div class="fs-content" style="background:#f1f5f9; padding:10px; display:flex; flex-direction:column; align-items:center;">
            <div id="canvas-wrapper" style="background:white; width:100%; max-width:600px; position:relative; min-height:400px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                <img id="sheet-bg" style="width:100%; pointer-events:none;">
                <div id="text-answer-display" style="padding:20px; width:100%; display:none;"></div>
                <canvas id="draw-layer" style="position:absolute; top:0; left:0; width:100%; height:100%;"></canvas>
            </div>
            <div style="width:100%; max-width:600px; margin-top:20px; background:white; padding:15px; border-radius:10px;">
                <label><b>Assign Grade:</b></label>
                <input id="manual-score" placeholder="Score (e.g. 15/20)">
                <textarea id="manual-feedback" placeholder="Remarks..." rows="2"></textarea>
            </div>
        </div>
    </div>

    <div id="edit-user-sheet" class="sheet-overlay" onclick="Router.closeSheet('edit-user-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Manage User (Admin)</h3>
            <input type="hidden" id="eu-id">
            <label style="font-size:11px; font-weight:bold;">Full Name</label>
            <input id="eu-name">
            <label style="font-size:11px; font-weight:bold;">Student Mobile</label>
            <input id="eu-sm">
            <label style="font-size:11px; font-weight:bold;">Parent Mobile</label>
            <input id="eu-pm">
            <label style="font-size:11px; font-weight:bold;">Batch</label>
            <select id="eu-batch"></select>
            <div class="row">
                <button class="btn btn-main" onclick="UiRenderer.saveUserEdit()">Save Changes</button>
                <button class="btn btn-danger" style="width:40%" onclick="UiRenderer.deleteUser()">Delete</button>
            </div>
        </div>
    </div>

    <div id="req-sheet" class="sheet-overlay" onclick="Router.closeSheet('req-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Request Profile Edit</h3>
            <p style="font-size:12px; color:gray; margin-bottom:15px;">Change request will be sent to Admin.</p>
            <input type="hidden" id="req-uid">
            <label style="font-size:11px; font-weight:bold;">Name</label>
            <input id="req-name">
            <label style="font-size:11px; font-weight:bold;">Student Mobile</label>
            <input id="req-sm">
            <label style="font-size:11px; font-weight:bold;">Parent Mobile</label>
            <input id="req-pm">
            <button class="btn btn-main" onclick="BatchService.submitRequest()">Send Request</button>
        </div>
    </div>

    <div id="reg-sheet" class="sheet-overlay" onclick="Router.closeSheet('reg-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Register</h3>
            <select id="r-role" onchange="UiRenderer.toggleRegFields()">
                <option>Student</option>
                <option>Teacher</option>
            </select>
            <input id="r-name" placeholder="Full Name">
            <div id="r-stu-div">
                <input id="r-sm" placeholder="Student Mobile">
                <input id="r-pm" placeholder="Parent Mobile">
                <select id="r-batch"></select>
                <label style="font-size:11px; font-weight:bold; margin-top:10px; display:block;">Subjects</label>
                <input id="r-stu-subs" placeholder="e.g. Maths, Physics">
            </div>
            <div id="r-tch-div" style="display:none;">
                <input id="r-subs" placeholder="Subjects Teaches">
            </div>
            <input id="r-pass" placeholder="PIN (Backup Login)">
            <button class="btn btn-main" onclick="AuthService.register()">Create Account</button>
        </div>
    </div>

    <div id="batch-sheet" class="sheet-overlay" onclick="Router.closeSheet('batch-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <div class="row">
                <h3 id="bs-title">Batch</h3>
                <button class="btn-sm btn-sec" onclick="Router.closeSheet('batch-sheet')">Close</button>
            </div>
            <div id="quantum-gen" class="quantum-box" style="display:none;">
                <div class="row">
                    <b style="color:var(--primary); font-size:12px;">‚ö° QUANTUM PAGER</b>
                    <span class="status-dot"></span>
                </div>
                <div class="row" style="margin-top:5px; gap:5px;">
                    <input id="q-topic" placeholder="Message (e.g. Class Delayed)" style="margin:0; font-size:12px;">
                    <select id="q-buf" style="width:80px; margin:0; font-size:12px;">
                        <option value="">Now</option>
                        <option value="in 10m">in 10m</option>
                        <option value="in 30m">in 30m</option>
                    </select>
                </div>
                <button class="btn btn-main btn-sm" style="width:100%; margin-top:5px;" onclick="BatchService.sendQuantum()">Send Blast</button>
            </div>
            
            <div class="sub-nav">
                <div class="sub-item active" id="tab-live" onclick="BatchService.switchTab('live')">Live</div>
                <div class="sub-item" id="tab-assign" onclick="BatchService.switchTab('assign')">Work</div>
                <div class="sub-item" id="tab-tests" onclick="BatchService.switchTab('tests')">Tests</div>
                <div class="sub-item" id="tab-students" onclick="BatchService.switchTab('students')">Students</div>
            </div>
            <div id="b-content"></div>
        </div>
    </div>

    <div id="cat-sheet" class="sheet-overlay" onclick="Router.closeSheet('cat-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Categories</h3>
            <div class="row">
                <input id="new-cat-in" placeholder="New Category" style="margin:0; width:70%">
                <button class="btn-sm btn-main" style="width:25%" onclick="MarketService.addCat()">Add</button>
            </div>
            <hr style="border:0;border-top:1px solid #eee;margin:15px 0;">
            <div id="cat-list-admin"></div>
        </div>
    </div>

    <div id="edit-course-sheet" class="sheet-overlay" onclick="Router.closeSheet('edit-course-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Edit Course</h3>
            <input type="hidden" id="ec-id">
            <label style="font-size:11px; font-weight:bold;">Name</label>
            <input id="ec-name">
            <label style="font-size:11px; font-weight:bold;">Price</label>
            <input id="ec-price" type="number">
            <button class="btn btn-main" onclick="MarketService.saveCourseEdit()">Update</button>
            <button class="btn btn-danger" style="margin-top:10px;" onclick="MarketService.deleteCourse()">Delete</button>
        </div>
    </div>

    <div id="subject-select-sheet" class="sheet-overlay" onclick="Router.closeSheet('subject-select-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Start Class</h3>
            <div class="row" style="background:#f0f9ff; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #bae6fd;">
                <b style="color:#0284c7">Repeat Daily (Schedule)?</b>
                <input type="checkbox" id="class-daily-toggle" style="width:20px; height:20px;">
            </div>
            <div id="subject-list-container"></div>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="BatchService.startVisibilityCall('General')">Start Combined</button>
        </div>
    </div>

    <div id="staff-sheet" class="sheet-overlay" onclick="Router.closeSheet('staff-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Select Staff</h3>
            <div class="row" style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:10px;">
                <b>Select All</b>
                <input type="checkbox" onchange="BatchService.toggleAllTeachers(this)">
            </div>
            <div id="staff-list" style="max-height:200px;overflow-y:auto;margin-bottom:15px;"></div>
            <button class="btn btn-main btn-danger" onclick="BatchService.startStaffCall()">Start Call</button>
        </div>
    </div>
    
    <div id="add-assign-sheet" class="sheet-overlay" onclick="Router.closeSheet('add-assign-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>New Assignment</h3>
            <input id="as-title" placeholder="Title">
            <textarea id="as-desc" placeholder="Instructions" rows="3"></textarea>
            <label style="font-size:11px; font-weight:bold;">Deadline</label>
            <input id="as-deadline" type="datetime-local">
            <label style="font-size:11px; font-weight:bold;">Subject</label>
            <select id="as-subject"><option value="General">All</option><option value="Mathematics">Mathematics</option><option value="Physics">Physics</option></select>
            <button class="btn btn-main" style="margin-top:15px;" onclick="AssignmentService.create()">Post</button>
        </div>
    </div>

    <div id="submit-assign-sheet" class="sheet-overlay" onclick="Router.closeSheet('submit-assign-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Submit Work</h3>
            <p id="sas-title" style="font-weight:bold;"></p>
            <input type="hidden" id="sas-id">
            <div class="card" style="display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="document.getElementById('assign-upload-img').click()">
                <i class="material-icons" style="font-size:24px; color:var(--primary);">image</i> <b>Gallery / Camera</b>
            </div>
            <input type="file" id="assign-upload-img" accept="image/*" style="display:none" onchange="AssignmentService.handleFile(this, 'img')">
            <div class="card" style="display:flex; align-items:center; gap:15px; cursor:pointer;" onclick="document.getElementById('assign-upload-pdf').click()">
                <i class="material-icons" style="font-size:24px; color:#ef4444;">picture_as_pdf</i> <b>Upload PDF</b>
            </div>
            <input type="file" id="assign-upload-pdf" accept="application/pdf" style="display:none" onchange="AssignmentService.handleFile(this, 'pdf')">
        </div>
    </div>

    <div id="test-creator-sheet" class="sheet-overlay" onclick="Router.closeSheet('test-creator-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Create Test</h3>
            <div class="row" style="margin-bottom:20px;">
                <button class="btn btn-sec" style="flex:1; margin-right:10px;" onclick="Router.openSheet('add-quiz-sheet'); Router.closeSheet('test-creator-sheet');">MCQ</button>
                <button class="btn btn-main" style="flex:1;" onclick="QuizService.initSubjectiveCreator(); Router.closeSheet('test-creator-sheet');">Subjective</button>
            </div>
        </div>
    </div>

    <div id="add-quiz-sheet" class="sheet-overlay" onclick="Router.closeSheet('add-quiz-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Create MCQ</h3>
            <input id="qz-q" placeholder="Question">
            <input id="qz-o1" placeholder="A"><input id="qz-o2" placeholder="B"><input id="qz-o3" placeholder="C"><input id="qz-o4" placeholder="D">
            <select id="qz-ans"><option value="1">A</option><option value="2">B</option><option value="3">C</option><option value="4">D</option></select>
            <button class="btn btn-main" onclick="QuizService.add()">Post</button>
        </div>
    </div>

    <div id="add-sub-exam-sheet" class="sheet-overlay" onclick="Router.closeSheet('add-sub-exam-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Create Exam</h3>
            <input id="se-title" placeholder="Title">
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <div class="row" style="margin-bottom:10px;">
                <div style="flex:1; margin-right:10px;"><label style="font-size:11px;">Timed?</label><select id="se-timed" onchange="document.getElementById('time-config').style.display=this.value==='Yes'?'flex':'none'"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                <div style="flex:1;"><label style="font-size:11px;">Daily?</label><select id="se-daily"><option value="No">No</option><option value="Yes">Yes</option></select></div>
            </div>
            <div id="time-config" class="row" style="display:none; gap:5px; margin-top:5px; margin-bottom:10px;">
                <input id="se-h" placeholder="HH" type="number"><input id="se-m" placeholder="MM" type="number">
            </div>
            <div style="margin-bottom:15px; background:#f0fdf4; padding:10px; border-radius:8px;">
                <label style="font-size:11px; font-weight:bold; color:#166534;">Grading Mode</label>
                <select id="se-mode"><option value="ai">ü§ñ AI Auto-Check</option><option value="manual">‚úçÔ∏è Manual Review</option></select>
            </div>
            <div style="background:#f0f9ff; padding:15px; border-radius:10px; margin-bottom:15px;">
                <input id="se-q" placeholder="Question Text">
                <div class="row"><input id="se-mm" type="number" placeholder="Marks" style="width:100%"></div>
                <textarea id="se-keys" placeholder="Keywords (!Important, Synonym/Alt)" rows="2"></textarea>
                <button class="btn btn-sec" onclick="QuizService.pushQuestion()">+ Add Question</button>
            </div>
            <div id="se-preview-list" style="margin-bottom:15px; max-height:100px; overflow-y:auto;"></div>
            <button class="btn btn-main" onclick="QuizService.publishExam()">Publish</button>
        </div>
    </div>

    <div id="add-course-sheet" class="sheet-overlay" onclick="Router.closeSheet('add-course-sheet')">
        <div class="sheet" onclick="event.stopPropagation()">
            <h3>Add Course</h3>
            <input id="ac-name" placeholder="Title"><input id="ac-price" type="number" placeholder="Price">
            <select id="ac-cat"></select><select id="ac-type"><option value="video">Video</option><option value="pdf">PDF</option></select>
            <input id="ac-url" placeholder="URL">
            <button class="btn btn-main" onclick="MarketService.addCourse()">Publish</button>
        </div>
    </div>

    <script>
        // === 1. DATABASE & CONFIG ===
        class DatabaseService {
            constructor() {
                this.tables = ['users', 'courses', 'batches', 'orders', 'config', 'doubts', 'quizzes', 'exams', 'assignments', 'submissions', 'notis', 'results', 'schedule', 'categories', 'requests'];
                this.cache = {}; 
                this.tables.forEach(t => this.cache[t] = JSON.parse(localStorage.getItem('ja_' + t)) || []);
                
                // SEED ADMIN
                if(this.cache['users'].length === 0) { 
                    this.cache['users'].push({m:'ADM-001', n:'Admin', p:'1234', role:'Admin', status:'Active', sm:'999', pm:'888'}); 
                    this.commit('users'); 
                }
                if(this.cache['batches'].length === 0) { this.cache['batches'].push({name:'Class 10 A'}, {name:'Class 12 B'}); this.commit('batches'); }
                if(this.cache['categories'].length === 0) { this.cache['categories'].push('IIT-JEE', 'NEET'); this.commit('categories'); }
            }
            async add(table, data) { if(!data.id) data.id = Date.now().toString(); this.cache[table].push(data); this.commit(table); }
            async get(table) { return this.cache[table]; }
            async update(table, id, data) { const idx = this.cache[table].findIndex(x => x.id === id); if(idx !== -1) { this.cache[table][idx] = { ...this.cache[table][idx], ...data }; this.commit(table); } }
            async delete(table, id) { this.cache[table] = this.cache[table].filter(x => x.id !== id); this.commit(table); }
            commit(table) { localStorage.setItem('ja_' + table, JSON.stringify(this.cache[table])); }
        }
        const DB = new DatabaseService();
        function move(obj, nextID) { if(obj.value.length >= obj.maxLength && nextID) document.getElementById(nextID).focus(); }

        // === 2. SMART AUTH (OTP + ENV) ===
        const AuthService = {
            currentUser: null, tempUser: null, otp: null,
            
            requestOtp: async () => {
                const id=document.getElementById('l-id').value, role=document.getElementById('l-role').value;
                const user = (await DB.get('users')).find(u => u.m === id && u.role === role);
                if (user) { 
                    if(user.status === 'Pending') return alert("Pending Admin Approval.");
                    AuthService.tempUser = user;
                    // SMART SWITCH: CLOUD vs LOCAL
                    if (window.firebase) { console.log("Sending Real OTP..."); } 
                    else {
                        AuthService.otp = Math.floor(1000 + Math.random() * 9000);
                        document.getElementById('otp-hint').innerText = `OTP ${AuthService.otp} sent to ${user.sm || 'Student'} & ${user.pm || 'Parent'}`;
                    }
                    document.getElementById('auth-step-1').style.display='none'; document.getElementById('auth-step-2').style.display='block';
                } else alert("Invalid ID");
            },
            
            verifyOtp: async () => {
                const input = [1,2,3,4].map(i=>document.getElementById('d'+i).value).join('');
                if(window.firebase || input == AuthService.otp) {
                    AuthService.currentUser = AuthService.tempUser;
                    document.getElementById('auth-layer').style.display='none'; document.getElementById('app-layer').style.display='flex';
                    document.getElementById('user-greeting').innerText = `Hello, ${AuthService.currentUser.n}`;
                    Router.init(AuthService.currentUser.role);
                } else alert("Wrong OTP");
            },
            
            logout: () => location.reload(),
            
            register: async () => {
                const r=document.getElementById('r-role').value, id=(r==='Student'?'STU':'TCH')+'-'+Math.floor(Math.random()*10000);
                const status = (AuthService.currentUser && AuthService.currentUser.role === 'Admin') ? 'Active' : 'Pending';
                
                await DB.add('users', { 
                    m:id, n:document.getElementById('r-name').value, 
                    role:r, status:status, 
                    batch:document.getElementById('r-batch').value, 
                    sm:document.getElementById('r-sm').value, 
                    pm:document.getElementById('r-pm').value, 
                    subs: (document.getElementById('r-stu-subs').value||'').split(',') 
                });
                
                if(status === 'Active') { 
                    alert(`User Added (Active)\nID: ${id}`); 
                    Router.closeSheet('reg-sheet'); 
                    UiRenderer.renderAdmin(); 
                } else { 
                    alert(`Request Sent! ID: ${id}\nWait for Admin Approval.`); 
                    Router.closeSheet('reg-sheet'); 
                }
            }
        };

        // === 3. CORE LOGIC (BATCH, SECURITY, QUANTUM) ===
        const BatchService = {
            currentBatch: null,
            open: (name) => { 
                BatchService.currentBatch = name; 
                document.getElementById('bs-title').innerText = name; 
                Router.openSheet('batch-sheet'); 
                document.getElementById('quantum-gen').style.display = (AuthService.currentUser.role !== 'Student') ? 'block' : 'none'; 
                BatchService.switchTab('live'); 
            },
            switchTab: (tab) => {
                document.querySelectorAll('.sub-item').forEach(i => i.classList.remove('active')); document.getElementById('tab-'+tab).classList.add('active');
                const c = document.getElementById('b-content'); const u = AuthService.currentUser;
                
                if(tab === 'live') c.innerHTML = `<div style="text-align:center;padding:30px;"><button class="btn btn-main btn-danger" onclick="BatchService.prepLiveClass()">üî¥ Join Class</button></div>` + ((u.role==='Admin')?`<div style="margin-top:20px;border-top:1px solid #eee;padding-top:10px;"><button class="btn btn-sec" onclick="BatchService.openStaffSelection()">üìû Staff Call</button></div>`:'');
                
                if(tab === 'assign') {
                    const assigns = DB.cache['assignments'].filter(a => a.batch === BatchService.currentBatch);
                    c.innerHTML = ((u.role!=='Student')?`<button class="btn btn-sec" onclick="Router.openSheet('add-assign-sheet')" style="margin-bottom:10px;">+ New</button>`:'') + assigns.map(a => `<div class="card"><div class="row"><div><b>${a.title}</b><br>${a.subject}</div><button class="btn-sm btn-main" onclick="${u.role==='Student'?'AssignmentService.initSubmit':'BatchService.checkSubmission'}('${a.id}')">${u.role==='Student'?'Submit':'Check'}</button></div></div>`).join('');
                }
                
                if(tab === 'tests') {
                    const tests = [...DB.cache['quizzes'], ...DB.cache['exams']].filter(q => q.batch === BatchService.currentBatch);
                    c.innerHTML = ((u.role!=='Student')?`<button class="btn btn-sec" onclick="Router.openSheet('test-creator-sheet')" style="margin-bottom:10px;">+ New Test</button>`:'') + tests.map(t => `<div class="card"><div class="row"><div><span class="badge ${t.type==='mcq'?'b-admin':'b-student'}">${t.type}</span> <b>${t.title||t.q}</b></div><button class="btn-sm btn-main" onclick="QuizService.start('${t.id}','${t.type}')">Start</button></div></div>`).join('');
                }
                
                if(tab === 'students') {
                    const students = DB.cache['users'].filter(s => s.batch === BatchService.currentBatch && s.role === 'Student' && (u.role === 'Admin' || (u.subs||[]).some(ts => (s.subs||[]).includes(ts))));
                    c.innerHTML = students.map(s => `<div class="user-row"><div class="user-av">${s.n[0]}</div><div style="flex:1"><b>${s.n}</b><br>${s.m}</div>${(u.role==='Teacher')?`<div class="action-icon" style="background:#f0f9ff" onclick="BatchService.openEditRequest('${s.id}')">‚úé</div>`:''}</div>`).join('') || '<div class="empty-state">No Visible Students</div>';
                }
            },
            
            openEditRequest: (uid) => { const s = DB.cache['users'].find(u => u.id === uid); document.getElementById('req-uid').value = uid; document.getElementById('req-name').value = s.n; document.getElementById('req-sm').value = s.sm; document.getElementById('req-pm').value = s.pm; Router.openSheet('req-sheet'); },
            submitRequest: async () => { const req = { type:'Profile', targetUid:document.getElementById('req-uid').value, requester:AuthService.currentUser.n, changes:{ n:document.getElementById('req-name').value, sm:document.getElementById('req-sm').value, pm:document.getElementById('req-pm').value }, status:'Pending' }; await DB.add('requests', req); alert("Sent to Admin!"); Router.closeSheet('req-sheet'); },
            sendQuantum: async () => { await DB.add('notis', { batch:BatchService.currentBatch, msg:`‚ö° ${document.getElementById('q-topic').value} ${document.getElementById('q-buf').value}`, date:new Date().toLocaleTimeString() }); alert("Sent!"); },
            prepLiveClass: () => { const u=AuthService.currentUser; if(u.role==='Student'||u.role==='Admin') VideoService.startCall(BatchService.currentBatch, u.n); else Router.openSheet('subject-select-sheet'); },
            startVisibilityCall: async (subj) => { const b=BatchService.currentBatch; if(document.getElementById('class-daily-toggle').checked) await DB.add('schedule', { batch:b, title:`${subj} Live`, info:'Daily', room:`${b} ${subj}` }); VideoService.startCall(`${b} ${subj}`, AuthService.currentUser.n); },
            checkSubmission: (sid) => { const sub = DB.cache['submissions'].find(s => s.id === sid); document.getElementById('checker-player').style.display='flex'; CanvasEngine.init(sub.sheetImg, sid, null, true); },
            openStaffSelection: async () => { document.getElementById('staff-list').innerHTML = DB.cache['users'].filter(u=>u.role==='Teacher').map(t=>`<div class="chk-row"><input type="checkbox" class="tch-chk" value="${t.m}">${t.n}</div>`).join(''); Router.openSheet('staff-sheet'); },
            startStaffCall: () => { Router.closeSheet('staff-sheet'); VideoService.startCall(`${BatchService.currentBatch} Staff`, 'Admin'); }
        };

        // === 4. UI RENDERER (THE GOD MODE DASHBOARD) ===
        const UiRenderer = {
            async renderHome() {
                const u = AuthService.currentUser;
                const notis = (await DB.get('notis')).filter(n => (n.batch === u.batch && !n.target) || (n.target === u.m));
                const schedule = (await DB.get('schedule')).filter(s => s.batch === u.batch);
                
                let schedHtml = schedule.length ? `<h3>üìÖ Today's Schedule</h3>` + schedule.map(s => `<div class="schedule-card"><div class="row"><div><b>${s.title}</b><br>${s.info}</div><button class="btn-sm btn-main" onclick="VideoService.startCall('${s.room}','${u.n}')">Join</button></div></div>`).join('') : '';
                
                document.getElementById('pane-container').innerHTML = `
                    ${schedHtml}
                    <div class="card" onclick="BatchService.open('${u.batch || 'General'}')">
                        <div class="row">
                            <div><h3 style="color:#b91c1c; margin:0;">üî¥ Enter Classroom</h3><p style="font-size:12px; color:gray; margin-top:5px;">Join Video, Tests & Submissions</p></div>
                            <i class="material-icons" style="color:#b91c1c; font-size:32px;">videocam</i>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üì¢ Notice Board</h3>
                        ${notis.length ? notis.map(n => `<div class="chat-msg ${n.isCall?'chat-alert':''}">${n.msg} ${n.isCall ? `<button class="btn-sm btn-main" style="margin-top:5px;" onclick="VideoService.startCall('${n.room}','${u.n}')">Join Call</button>` : ''}</div>`).join('') : '<div class="empty-state">No new notices.</div>'}
                    </div>`;
            },
            async renderAdmin() {
                const users = DB.cache['users'];
                const pending = users.filter(u => u.status === 'Pending');
                const reqs = DB.cache['requests'];
                
                let html = `
                    <div class="stat-grid">
                        <div class="stat-card"><span class="stat-num">${users.filter(u=>u.role==='Student').length}</span><span class="stat-label">Students</span></div>
                        <div class="stat-card"><span class="stat-num">${users.filter(u=>u.role==='Teacher').length}</span><span class="stat-label">Teachers</span></div>
                    </div>
                    <div class="card"><b>Quick Actions</b><br><button class="btn-sec" style="margin-top:10px" onclick="Router.openSheet('cat-sheet')">Manage Categories</button></div>
                    ${pending.length ? `<div class="card" style="border-left:4px solid #ef4444;"><h3>‚ö†Ô∏è Pending Reg (${pending.length})</h3>${pending.map(u => `<div class="row"><b>${u.n}</b><button class="btn-sm btn-main" onclick="approveUser('${u.id}')">Approve</button></div>`).join('')}</div>` : ''}
                    ${reqs.length ? `<div class="card" style="border-left:4px solid #f59e0b;"><h3>üìù Requests (${reqs.length})</h3>${reqs.map(r => `<div style="padding:10px;border-bottom:1px solid #eee;"><small>By ${r.requester} for ${r.targetName}</small><br><b>${r.changes.n}</b><br><div class="row"><button class="btn-sm btn-main" onclick="UiRenderer.procReq('${r.id}',1)">Yes</button><button class="btn-sm btn-danger" onclick="UiRenderer.procReq('${r.id}',0)">No</button></div></div>`).join('')}</div>` : ''}
                    <div class="card"><h3>Database</h3>${users.filter(u=>u.status==='Active').map(u => `<div class="user-row"><div class="user-av">${u.role[0]}</div><div style="flex:1"><b>${u.n}</b><br>${u.role}</div><div class="action-icon" style="background:#f0f9ff" onclick="UiRenderer.editUser('${u.id}')">‚úé</div><div class="action-icon" style="background:#dcfce7" onclick="simulateUser('${u.id}')">üëÅ</div></div>`).join('')}</div>
                `;
                document.getElementById('pane-container').innerHTML = html;
            },
            editUser: (uid) => { const u = DB.cache['users'].find(x => x.id === uid); document.getElementById('eu-id').value=uid; document.getElementById('eu-name').value=u.n; document.getElementById('eu-sm').value=u.sm; document.getElementById('eu-pm').value=u.pm; Router.openSheet('edit-user-sheet'); },
            saveUserEdit: async () => { await DB.update('users', document.getElementById('eu-id').value, { n:document.getElementById('eu-name').value, sm:document.getElementById('eu-sm').value, pm:document.getElementById('eu-pm').value, batch:document.getElementById('eu-batch').value }); alert("Saved"); Router.closeSheet('edit-user-sheet'); UiRenderer.renderAdmin(); },
            deleteUser: async () => { if(confirm("Del?")) { await DB.delete('users', document.getElementById('eu-id').value); Router.closeSheet('edit-user-sheet'); UiRenderer.renderAdmin(); } },
            procReq: async (rid, ok) => { const r = DB.cache['requests'].find(x=>x.id===rid); if(ok) await DB.update('users', r.targetUid, r.changes); await DB.delete('requests', rid); UiRenderer.renderAdmin(); },
            renderCourses: async () => { document.getElementById('content-area').innerHTML = DB.cache['courses'].map(c => `<div class="card" onclick="MarketService.editCourse('${c.id}','${c.name}','${c.price}')"><b>${c.name}</b><br>‚Çπ${c.price}</div>`).join('') + `<button class="btn btn-main" onclick="Router.openSheet('add-course-sheet')">+ Add</button>`; document.getElementById('ac-cat').innerHTML = DB.cache['categories'].map(c=>`<option>${c}</option>`).join(''); },
            toggleRegFields: () => { const r = document.getElementById('r-role').value; document.getElementById('r-stu-div').style.display = r==='Student'?'block':'none'; document.getElementById('r-tch-div').style.display = r==='Teacher'?'block':'none'; }
        };

        // ... (Canvas, Quiz, Video, Market, Router etc.) ...
        const CanvasEngine = { ctx: null, canvas: null, isDrawing: false, currentResultId: null, isSubmission: false, init: (imgSrc, rid, textContent, isSub = false) => { CanvasEngine.currentResultId = rid; CanvasEngine.isSubmission = isSub; const img = document.getElementById('sheet-bg'); const textDiv = document.getElementById('text-answer-display'); CanvasEngine.canvas = document.getElementById('draw-layer'); CanvasEngine.ctx = CanvasEngine.canvas.getContext('2d'); if (imgSrc) { img.style.display = 'block'; textDiv.style.display = 'none'; img.src = imgSrc; img.onload = () => { CanvasEngine.canvas.width = img.width || 600; CanvasEngine.canvas.height = img.height || 800; CanvasEngine.setPen(); }; } else { img.style.display = 'none'; textDiv.style.display = 'block'; textDiv.innerHTML = textContent || "No Content"; CanvasEngine.canvas.width = 600; CanvasEngine.canvas.height = 600; CanvasEngine.setPen(); } ['mousedown','touchstart'].forEach(e => CanvasEngine.canvas.addEventListener(e, CanvasEngine.startDraw)); ['mousemove','touchmove'].forEach(e => CanvasEngine.canvas.addEventListener(e, CanvasEngine.draw)); ['mouseup','touchend'].forEach(e => CanvasEngine.canvas.addEventListener(e, CanvasEngine.stopDraw)); }, setPen: () => { CanvasEngine.ctx.strokeStyle = "red"; CanvasEngine.ctx.lineWidth = 3; CanvasEngine.ctx.lineCap = "round"; }, getPos: (e) => { const rect = CanvasEngine.canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: (clientX - rect.left) * (CanvasEngine.canvas.width / rect.width), y: (clientY - rect.top) * (CanvasEngine.canvas.height / rect.height) }; }, startDraw: (e) => { e.preventDefault(); CanvasEngine.isDrawing = true; const p = CanvasEngine.getPos(e); CanvasEngine.ctx.beginPath(); CanvasEngine.ctx.moveTo(p.x, p.y); }, draw: (e) => { if(!CanvasEngine.isDrawing) return; e.preventDefault(); const p = CanvasEngine.getPos(e); CanvasEngine.ctx.lineTo(p.x, p.y); CanvasEngine.ctx.stroke(); }, stopDraw: () => { CanvasEngine.isDrawing = false; }, clear: () => CanvasEngine.ctx.clearRect(0, 0, CanvasEngine.canvas.width, CanvasEngine.canvas.height), saveAndMark: async () => { const score = document.getElementById('manual-score').value; const feedback = document.getElementById('manual-feedback').value; if(!score) return alert("Enter Marks"); const table = CanvasEngine.isSubmission ? 'submissions' : 'results'; await DB.update(table, CanvasEngine.currentResultId, { score: score, feedback: feedback, corrected: true }); alert("Saved!"); document.getElementById('checker-player').style.display = 'none'; if(CanvasEngine.isSubmission) BatchService.switchTab('assign'); else BatchService.switchTab('rank'); } };
        const AssignmentService = { create: async () => { const title = document.getElementById('as-title').value; if(!title) return alert("Req"); await DB.add('assignments', { batch: BatchService.currentBatch, title: title, desc: document.getElementById('as-desc').value, deadline: document.getElementById('as-deadline').value, subject: document.getElementById('as-subject').value }); Router.closeSheet('add-assign-sheet'); BatchService.switchTab('assign'); }, initSubmit: (aid) => { document.getElementById('sas-id').value = aid; Router.openSheet('submit-assign-sheet'); }, handleFile: (input, type) => { if(input.files.length) { const r = new FileReader(); r.onload = async (e) => { await DB.add('submissions', { aid: document.getElementById('sas-id').value, uid: AuthService.currentUser.m, uName: AuthService.currentUser.n, sheetImg: type==='img'?e.target.result:null, pdfData: type==='pdf'?e.target.result:null, type: type }); alert("Sent"); Router.closeSheet('submit-assign-sheet'); BatchService.switchTab('assign'); }; r.readAsDataURL(input.files[0]); } } };
        const QuizService = { tempQuestions: [], add: async () => { await DB.add('quizzes', { batch: document.getElementById('bs-title').innerText, q: document.getElementById('qz-q').value, opts: [1,2,3,4].map(i=>document.getElementById('qz-o'+i).value), ans: document.getElementById('qz-ans').value, type: 'mcq' }); Router.closeSheet('add-quiz-sheet'); }, initSubjectiveCreator: () => { QuizService.tempQuestions=[]; document.getElementById('se-preview-list').innerHTML=''; Router.openSheet('add-sub-exam-sheet'); }, pushQuestion: () => { QuizService.tempQuestions.push({ q: document.getElementById('se-q').value, mm: parseInt(document.getElementById('se-mm').value), keys: document.getElementById('se-keys').value.split(',') }); document.getElementById('se-q').value=''; document.getElementById('se-preview-list').innerHTML = QuizService.tempQuestions.map(x=>`<div class="q-preview">${x.q}</div>`).join(''); }, publishExam: async () => { const isDaily = document.getElementById('se-daily').value === 'Yes'; const exam = { batch: document.getElementById('bs-title').innerText, title: document.getElementById('se-title').value, questions: QuizService.tempQuestions, mode: document.getElementById('se-mode').value, type: 'exam' }; await DB.add('exams', exam); if(isDaily) { await DB.add('schedule', { batch: exam.batch, type: 'Test', title: exam.title, info: 'Daily Practice', id: exam.id }); } Router.closeSheet('add-sub-exam-sheet'); }, start: (id, type) => { const c = document.getElementById('quiz-container'); document.getElementById('quiz-player').style.display='flex'; c.innerHTML = type==='mcq' ? 'MCQ Started' : 'Exam Started (Anti-Cheat Active)'; }, close: () => document.getElementById('quiz-player').style.display='none' };
        const VideoService = { api: null, startCall: (r, u) => { document.getElementById('video-room').style.display='flex'; VideoService.api = new JitsiMeetExternalAPI('meet.jit.si', { roomName: r, width:'100%', height:'100%', parentNode: document.getElementById('jitsi-container') }); }, endCall: () => { if(VideoService.api) VideoService.api.dispose(); document.getElementById('video-room').style.display='none'; } };
        const MarketService = { addCourse: async () => { await DB.add('courses', { name: document.getElementById('ac-name').value, price: document.getElementById('ac-price').value, cat: document.getElementById('ac-cat').value }); Router.closeSheet('add-course-sheet'); UiRenderer.renderCourses(); }, addCat: async () => { const c = document.getElementById('new-cat-in').value; if(c) { await DB.add('categories', c); UiRenderer.renderAdmin(); Router.closeSheet('cat-sheet'); } }, editCourse: (id, name, price) => { document.getElementById('ec-id').value=id; document.getElementById('ec-name').value=name; document.getElementById('ec-price').value=price; Router.openSheet('edit-course-sheet'); }, saveCourseEdit: async () => { const id=document.getElementById('ec-id').value; await DB.update('courses', id, { name:document.getElementById('ec-name').value, price:document.getElementById('ec-price').value }); Router.closeSheet('edit-course-sheet'); UiRenderer.renderCourses(); }, deleteCourse: async () => { if(confirm("Delete Course?")) { await DB.delete('courses', document.getElementById('ec-id').value); Router.closeSheet('edit-course-sheet'); UiRenderer.renderCourses(); } }, initBuy: () => Router.openSheet('buy-sheet'), confirmOrder: () => { alert("Verified"); Router.closeSheet('buy-sheet'); } };
        
        const Router = { init: (role) => { let menu = role==='Admin'?['Admin','Courses']:['Home','Courses']; document.getElementById('bot-nav').innerHTML = menu.map(m => `<div class="nav-item" onclick="Router.nav('${m}')"><i class="material-icons">${m==='Admin'?'settings':m==='Courses'?'library_books':'home'}</i>${m}</div>`).join(''); Router.nav(menu[0]); }, nav: (page) => { document.getElementById('pane-container').innerHTML = `<h2 style="margin-bottom:15px;">${page}</h2><div id="content-area"></div>`; if(page==='Admin') UiRenderer.renderAdmin(); if(page==='Courses') { /* Market Logic */ } if(page==='Home') UiRenderer.renderHome(); }, openSheet: (id) => document.getElementById(id).style.display='flex', closeSheet: (id) => document.getElementById(id).style.display='none' };
        
        async function approveUser(uid) { await DB.update('users', uid, { status: 'Active' }); UiRenderer.renderAdmin(); }
        async function simulateUser(uid) { 
            const u = (await DB.get('users')).find(x => x.id === uid); 
            AuthService.currentUser = u; 
            document.getElementById('sim-bar').style.display='block'; 
            Router.init(u.role); 
        }
        (async ()=>{ const batches = await DB.get('batches'); const els = document.querySelectorAll('#r-batch, #eu-batch'); els.forEach(e => e.innerHTML = batches.map(b=>`<option>${b.name}</option>`).join('')); })();
    </script>
</body>
</html>
