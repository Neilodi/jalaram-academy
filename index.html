<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jalaram Academy | Enterprise ERP v350</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src='https://meet.jit.si/external_api.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           1. CORE VARIABLES (The Design System)
           ========================================= */
        :root {
            /* Brand Colors */
            --primary: #0f5bb8;
            --primary-dark: #0a3d7c;
            --primary-light: #eff6ff;
            --accent: #3b82f6;
            
            /* UI Colors */
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sub: #475569;
            --border: #e2e8f0;
            
            /* Status Colors */
            --success: #10b981; --success-bg: #dcfce7;
            --danger: #ef4444; --danger-bg: #fee2e2;
            --warning: #f59e0b; --warning-bg: #fef3c7;
            
            /* Dimensions & Shadows */
            --sidebar-w: 280px;
            --header-h: 68px;
            --radius: 14px;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        /* =========================================
           2. GLOBAL RESET
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
        
        /* Scrollbar Polish */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animation Utilities */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; }
        .w-full { width: 100%; }

        /* =========================================
           3. UI COMPONENT LIBRARY
           ========================================= */
        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 20px; border-radius: 10px; border: none; cursor: pointer;
            font-weight: 600; font-size: 14px; transition: all 0.2s; gap: 8px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(15, 91, 184, 0.25); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--text-sub); background: #f8fafc; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 12px; }

        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px;
            font-size: 14px; background: white; transition: all 0.2s; outline: none; font-family: inherit;
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        /* Cards */
        .card {
            background: var(--surface); border-radius: var(--radius); padding: 24px;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border); margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-title { font-size: 18px; font-weight: 700; }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .b-blue { background: var(--primary-light); color: var(--primary); }
        .b-green { background: var(--success-bg); color: #166534; }
        .b-red { background: var(--danger-bg); color: #991b1b; }

        /* =========================================
           4. AUTHENTICATION SCREENS
           ========================================= */
        #auth-layer {
            position: fixed; inset: 0; background: var(--surface); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .auth-card { width: 100%; max-width: 420px; padding: 40px; text-align: center; }
        .auth-logo { font-size: 64px; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        .otp-box { display: flex; gap: 12px; justify-content: center; margin: 24px 0; }
        .otp-input {
            width: 50px; height: 60px; text-align: center; font-size: 24px; font-weight: 700;
            border: 2px solid var(--border); border-radius: 12px; outline: none;
        }
        .otp-input:focus { border-color: var(--primary); transform: translateY(-2px); }

    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="auth-card fade-in">
            <div class="auth-logo">üéì</div>
            <h1 style="margin-bottom: 8px; color: var(--text-main);">Jalaram Academy</h1>
            <p style="color: var(--text-sub); margin-bottom: 32px;">Enterprise ERP v350 | Titan Build</p>

            <div id="login-view">
                <div class="input-group" style="text-align: left;">
                    <label class="form-label">Select Role</label>
                    <select id="login-role" class="form-input">
                        <option value="Student">Student / Parent</option>
                        <option value="Teacher">Faculty / Teacher</option>
                        <option value="Admin">Administrator</option>
                    </select>
                </div>
                <div class="input-group" style="text-align: left;">
                    <label class="form-label">User ID / Mobile</label>
                    <input id="login-id" class="form-input" placeholder="e.g. ADM-001 or 9998887776">
                </div>
                <button class="btn btn-primary w-full" onclick="AuthSystem.login()">
                    <i class="material-icons">lock</i> Secure Login
                </button>
                <button class="btn btn-secondary w-full" style="margin-top: 12px;" onclick="ModalSystem.open('register-modal')">
                    Register New Account
                </button>
            </div>

            <div id="otp-view" class="hidden">
                <div class="badge b-green" style="margin-bottom: 16px; display: inline-block;">
                    <i class="material-icons" style="font-size: 12px; vertical-align: middle;">verified</i> OTP Sent
                </div>
                <p style="font-size: 13px; color: var(--text-sub);">Enter the 4-digit code sent to your device.</p>
                
                <div class="otp-box">
                    <input class="otp-input" maxlength="1" id="d1" onkeyup="Utils.stepFocus(this, 'd2')">
                    <input class="otp-input" maxlength="1" id="d2" onkeyup="Utils.stepFocus(this, 'd3')">
                    <input class="otp-input" maxlength="1" id="d3" onkeyup="Utils.stepFocus(this, 'd4')">
                    <input class="otp-input" maxlength="1" id="d4" onkeyup="AuthSystem.verifyOTP()">
                </div>

                <button class="btn btn-primary w-full" onclick="AuthSystem.verifyOTP()">Verify Identity</button>
                <button class="btn btn-secondary w-full" style="margin-top: 12px;" onclick="location.reload()">Cancel</button>
            </div>
        </div>
        <div style="margin-top: 40px; font-size: 11px; color: var(--text-sub); opacity: 0.6;">
            ‚óè Encrypted Connection | Server: Mumbai-1
        </div>
    </div>

   <script>
        /* ======================================================================================
           MODULE 5: THE CORE DATABASE (Persistence Layer)
           ====================================================================================== */
        class DatabaseService {
            constructor() {
                this.tables = ['users', 'courses', 'batches', 'exams', 'results', 'attendance', 'chats', 'notifications'];
                this.cache = {}; 
                this.init();
            }

            // Initialize DB with Seed Data if Empty
            init() {
                this.tables.forEach(table => {
                    const data = localStorage.getItem(`ja_${table}`);
                    this.cache[table] = data ? JSON.parse(data) : [];
                });

                if (this.cache.users.length === 0) {
                    this.seedUsers();
                }
                if (this.cache.courses.length === 0) {
                    this.seedCourses();
                }
                if (this.cache.batches.length === 0) {
                    this.seedBatches();
                }
            }

            // Save Cache to LocalStorage
            commit(table) {
                if (this.cache[table]) {
                    localStorage.setItem(`ja_${table}`, JSON.stringify(this.cache[table]));
                }
            }

            // CRUD Operations
            insert(table, record) {
                if (!record.id) record.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                record.createdAt = new Date().toISOString();
                this.cache[table].push(record);
                this.commit(table);
                return record;
            }

            update(table, id, updates) {
                const index = this.cache[table].findIndex(r => r.id === id || r.userId === id);
                if (index !== -1) {
                    this.cache[table][index] = { ...this.cache[table][index], ...updates, updatedAt: new Date().toISOString() };
                    this.commit(table);
                    return true;
                }
                return false;
            }

            remove(table, id) {
                const initialLength = this.cache[table].length;
                this.cache[table] = this.cache[table].filter(r => r.id !== id && r.userId !== id);
                this.commit(table);
                return this.cache[table].length < initialLength;
            }

            select(table, filterFn = null) {
                if (!filterFn) return this.cache[table];
                return this.cache[table].filter(filterFn);
            }

            findOne(table, filterFn) {
                return this.cache[table].find(filterFn);
            }

            // Seed Data Generators
            seedUsers() {
                console.log("Seeding Users...");
                const admin = {
                    userId: 'ADM-001', name: 'System Administrator', role: 'Admin',
                    mobile: '9999999999', pin: '1234', status: 'Active',
                    avatar: 'A', batch: null
                };
                this.insert('users', admin);
            }

            seedBatches() {
                ['Class 10-A', 'Class 12-B', 'NEET Droppers', 'JEE Mains'].forEach(b => {
                    this.insert('batches', { name: b, teacherId: null });
                });
            }

            seedCourses() {
                this.insert('courses', {
                    title: 'Physics Masterclass', price: 4999, rating: 4.8, 
                    videoUrl: 'https://www.w3schools.com/html/mov_bbb.mp4',
                    description: 'Complete syllabus coverage for JEE Advanced.'
                });
                this.insert('courses', {
                    title: 'Organic Chemistry', price: 3499, rating: 4.5, 
                    videoUrl: 'https://www.w3schools.com/html/movie.mp4',
                    description: 'Master reactions and mechanisms.'
                });
            }
        }

        // Initialize Global Database Instance
        const DB = new DatabaseService();

        /* ======================================================================================
           MODULE 6: UTILITY HELPER FUNCTIONS
           ====================================================================================== */
        const Utils = {
            // ID Generation
            generateId: (prefix) => `${prefix}-${Math.floor(1000 + Math.random() * 9000)}`,

            // Date Formatting
            formatDate: (isoString) => {
                if (!isoString) return 'N/A';
                const d = new Date(isoString);
                return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
            },

            formatTime: (isoString) => {
                if (!isoString) return '';
                const d = new Date(isoString);
                return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
            },

            // Validation Helpers
            isValidPhone: (phone) => /^[6-9]\d{9}$/.test(phone),
            
            // Input Focus Management
            stepFocus: (current, nextId) => {
                if (current.value.length >= 1) {
                    const next = document.getElementById(nextId);
                    if (next) next.focus();
                }
            },

            // Toast Notifications
            showToast: (message, type = 'info') => {
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.style.cssText = 'position:fixed; top:20px; right:20px; z-index:10000; display:flex; flex-direction:column; gap:10px;';
                    document.body.appendChild(toastContainer);
                }

                const toast = document.createElement('div');
                toast.innerText = message;
                
                let bg = '#1e293b'; // Default
                if(type === 'success') bg = '#10b981';
                if(type === 'error') bg = '#ef4444';
                if(type === 'warning') bg = '#f59e0b';

                toast.style.cssText = `
                    background: ${bg}; color: white; padding: 12px 24px; 
                    border-radius: 8px; font-size: 13px; font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0;
                    transform: translateX(100%); transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
                `;

                toastContainer.appendChild(toast);

                // Animate In
                requestAnimationFrame(() => {
                    toast.style.opacity = '1';
                    toast.style.transform = 'translateX(0)';
                });

                // Remove after 3s
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        };

        /* ======================================================================================
           MODULE 7: AUTHENTICATION SERVICE LOGIC
           ====================================================================================== */
        const AuthenticationService = {
            currentUser: null,
            tempUser: null,
            generatedOtp: null,

            // 1. Initiate Login
            login: () => {
                const role = document.getElementById('login-role').value;
                const id = document.getElementById('login-id').value.trim();

                if (!id) return Utils.showToast("Please enter a User ID or Mobile Number", 'warning');

                // Find user in DB (Checks both UserID and Mobile)
                const user = DB.findOne('users', u => (u.userId === id || u.mobile === id) && u.role === role);

                if (!user) {
                    return Utils.showToast("User not found in our records.", 'error');
                }

                if (user.status === 'Pending') {
                    return Utils.showToast("Account is pending Admin approval.", 'warning');
                }

                if (user.status === 'Suspended') {
                    return Utils.showToast("This account has been suspended.", 'error');
                }

                // Simulate OTP Generation
                this.tempUser = user;
                this.generatedOtp = Math.floor(1000 + Math.random() * 9000);
                
                // Switch Views
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('otp-view').classList.remove('hidden');
                
                // Focus first digit
                setTimeout(() => document.getElementById('d1').focus(), 100);

                // Dev Alert (For simulation)
                alert(`[SIMULATION MODE]\nYour Secure OTP is: ${this.generatedOtp}`);
                console.log(`OTP for ${user.name}: ${this.generatedOtp}`);
            },

            // 2. Verify OTP
            verifyOTP: () => {
                const d1 = document.getElementById('d1').value;
                const d2 = document.getElementById('d2').value;
                const d3 = document.getElementById('d3').value;
                const d4 = document.getElementById('d4').value;
                const inputOtp = `${d1}${d2}${d3}${d4}`;

                if (inputOtp === String(this.generatedOtp) || inputOtp === '1234') { // 1234 Backdoor for testing
                    this.currentUser = this.tempUser;
                    this.completeLogin();
                } else {
                    Utils.showToast("Invalid OTP. Please try again.", 'error');
                    // Clear inputs
                    ['d1','d2','d3','d4'].forEach(id => document.getElementById(id).value = '');
                    document.getElementById('d1').focus();
                }
            },

            // 3. Finalize Session
            completeLogin: () => {
                Utils.showToast(`Welcome back, ${this.currentUser.name}!`, 'success');
                
                // Hide Auth Layer
                const layer = document.getElementById('auth-layer');
                layer.style.opacity = '0';
                setTimeout(() => {
                    layer.classList.add('hidden');
                    // Initialize Router and UI
                    RouterService.init(this.currentUser);
                }, 300);
            },

            // 4. Registration Logic
            registerUser: () => {
                // Collect Data
                const role = document.getElementById('reg-role').value;
                const name = document.getElementById('reg-name').value;
                const pin = document.getElementById('reg-pin').value;
                
                let mobile = '';
                let parentMobile = '';
                let batch = '';
                let subjects = '';

                // Validation
                if (!name || name.length < 3) return Utils.showToast("Please enter a valid full name.", 'error');
                
                if (role === 'Student') {
                    mobile = document.getElementById('reg-stu-mobile').value;
                    parentMobile = document.getElementById('reg-parent-mobile').value;
                    batch = document.getElementById('reg-batch').value;

                    if (!Utils.isValidPhone(mobile)) return Utils.showToast("Invalid Student Mobile Number (10 digits required).", 'error');
                    if (!Utils.isValidPhone(parentMobile)) return Utils.showToast("Invalid Parent Mobile Number.", 'error');
                    
                    // Duplicate Check
                    if (DB.findOne('users', u => u.mobile === mobile)) return Utils.showToast("Student Mobile already registered.", 'error');
                } else {
                    mobile = document.getElementById('reg-teach-mobile').value;
                    subjects = document.getElementById('reg-subjects').value;

                    if (!Utils.isValidPhone(mobile)) return Utils.showToast("Invalid Mobile Number.", 'error');
                    if (DB.findOne('users', u => u.mobile === mobile)) return Utils.showToast("Mobile already registered.", 'error');
                }

                // Generate ID
                const prefix = role === 'Student' ? 'STU' : (role === 'Teacher' ? 'TCH' : 'ADM');
                const newId = Utils.generateId(prefix);

                // Create Object
                const newUser = {
                    userId: newId,
                    name: name,
                    role: role,
                    mobile: mobile,
                    parentMobile: parentMobile,
                    batch: batch,
                    subjects: subjects,
                    pin: pin,
                    status: 'Pending', // Requires Admin Approval
                    avatar: name.charAt(0).toUpperCase()
                };

                // Save to DB
                DB.insert('users', newUser);

                // Notify
                Utils.showToast(`Registration Successful! ID: ${newId}. Wait for Admin approval.`, 'success');
                ModalService.close('register-modal');
            },

            logout: () => {
                if(confirm("Are you sure you want to logout?")) {
                    location.reload();
                }
            }
        };
    </script>
    <script>
        /* ======================================================================================
           MODULE 8: ROUTER & NAVIGATION SERVICE
           ====================================================================================== */
        const RouterService = {
            routes: {
                'dashboard': { title: 'Dashboard', icon: 'dashboard', roles: ['Admin', 'Teacher', 'Student'] },
                'courses':   { title: 'Course Library', icon: 'menu_book', roles: ['Admin', 'Teacher', 'Student'] },
                'batches':   { title: 'My Batches', icon: 'class', roles: ['Admin', 'Teacher'] },
                'users':     { title: 'User Management', icon: 'group', roles: ['Admin'] },
                'exams':     { title: 'Examinations', icon: 'assignment', roles: ['Admin', 'Teacher', 'Student'] },
                'results':   { title: 'Performance Reports', icon: 'bar_chart', roles: ['Admin', 'Teacher', 'Student'] },
                'live':      { title: 'Live Classroom', icon: 'videocam', roles: ['Admin', 'Teacher', 'Student'] },
                'settings':  { title: 'System Settings', icon: 'settings', roles: ['Admin'] }
            },

            currentUser: null,
            currentPage: null,

            // Initialize Router
            init: (user) => {
                this.currentUser = user;
                
                // Setup UI for User
                document.getElementById('header-user-name').innerText = user.name;
                document.getElementById('header-user-role').innerText = user.role;
                
                // Generate Navigation
                this.renderSidebar();
                this.renderMobileNav();

                // Unhide App Shell
                document.getElementById('app-shell').classList.remove('hidden');

                // Load Default Route
                this.navigate('dashboard');
            },

            // Render Desktop Sidebar
            renderSidebar: () => {
                const container = document.getElementById('desktop-nav');
                container.innerHTML = '';

                Object.keys(this.routes).forEach(key => {
                    const route = this.routes[key];
                    if (route.roles.includes(this.currentUser.role)) {
                        const item = document.createElement('div');
                        item.className = 'nav-item';
                        item.id = `nav-${key}`;
                        item.onclick = () => RouterService.navigate(key);
                        item.innerHTML = `<i class="material-icons">${route.icon}</i> ${route.title}`;
                        container.appendChild(item);
                    }
                });
            },

            // Render Mobile Bottom Bar
            renderMobileNav: () => {
                const container = document.getElementById('mobile-nav');
                container.innerHTML = '';
                
                // We pick top 4 items for mobile to fit space
                const priorityKeys = ['dashboard', 'courses', 'exams', 'live']; 
                
                priorityKeys.forEach(key => {
                    const route = this.routes[key];
                    if (route && route.roles.includes(this.currentUser.role)) {
                        const item = document.createElement('div');
                        item.style.cssText = 'display:flex; flex-direction:column; align-items:center; font-size:10px; color:var(--color-text-sub);';
                        item.onclick = () => RouterService.navigate(key);
                        item.innerHTML = `<i class="material-icons" style="font-size:24px; margin-bottom:2px;">${route.icon}</i> ${route.title}`;
                        container.appendChild(item);
                    }
                });
            },

            // Navigation Logic
            navigate: (pageId) => {
                this.currentPage = pageId;
                const route = this.routes[pageId];
                
                // Update Title
                document.getElementById('page-title').innerText = route.title;

                // Update Active State
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const activeNav = document.getElementById(`nav-${pageId}`);
                if(activeNav) activeNav.classList.add('active');

                // Clear Container
                const container = document.getElementById('main-container');
                container.innerHTML = '';
                container.classList.add('fade-in');
                setTimeout(() => container.classList.remove('fade-in'), 500);

                // Dispatch to Page Controller
                switch(pageId) {
                    case 'dashboard': PageControllers.renderDashboard(container); break;
                    case 'users': PageControllers.renderUserManagement(container); break;
                    case 'courses': PageControllers.renderCourses(container); break;
                    case 'batches': PageControllers.renderBatches(container); break;
                    case 'exams': PageControllers.renderExams(container); break;
                    case 'live': PageControllers.renderLiveClass(container); break;
                    default: container.innerHTML = `<div class="card"><h3>Page Under Construction</h3><p>Module: ${pageId}</p></div>`;
                }
            }
        };

        /* ======================================================================================
           MODULE 9: PAGE CONTROLLERS (View Logic)
           ====================================================================================== */
        const PageControllers = {
            
            // 9.1 DASHBOARD CONTROLLER
            renderDashboard: (container) => {
                const user = AuthenticationService.currentUser;
                const stats = PageControllers.getDashboardStats(user);

                // Welcome Banner
                const banner = document.createElement('div');
                banner.className = 'card';
                banner.style.background = 'linear-gradient(135deg, var(--color-primary), var(--color-accent))';
                banner.style.color = 'white';
                banner.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 style="margin-bottom:8px;">üëã Hello, ${user.name}</h2>
                            <p style="opacity:0.9; font-size:14px;">You have ${stats.pendingTasks} pending tasks today.</p>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:32px; font-weight:700;">${stats.attendance}%</div>
                            <div style="font-size:12px; text-transform:uppercase;">Attendance</div>
                        </div>
                    </div>
                `;
                container.appendChild(banner);

                // Admin Specific Widgets
                if (user.role === 'Admin') {
                    const grid = document.createElement('div');
                    grid.className = 'attendance-grid'; // Reusing grid class
                    grid.style.marginBottom = '20px';
                    
                    const pendingUsers = DB.select('users', u => u.status === 'Pending').length;
                    const totalUsers = DB.select('users').length;
                    const totalCourses = DB.select('courses').length;

                    grid.innerHTML = `
                        <div class="card" style="margin:0; text-align:center;">
                            <h3 style="color:var(--color-primary); font-size:32px;">${totalUsers}</h3>
                            <small>Total Users</small>
                        </div>
                        <div class="card" style="margin:0; text-align:center;">
                            <h3 style="color:var(--color-warning); font-size:32px;">${pendingUsers}</h3>
                            <small>Pending Approvals</small>
                        </div>
                        <div class="card" style="margin:0; text-align:center;">
                            <h3 style="color:var(--color-success); font-size:32px;">${totalCourses}</h3>
                            <small>Active Courses</small>
                        </div>
                    `;
                    container.appendChild(grid);
                }

                // Recent Notifications
                const notis = document.createElement('div');
                notis.className = 'card';
                notis.innerHTML = `
                    <div class="card-header"><span class="card-title">üì¢ Notice Board</span></div>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <div style="background:var(--color-primary-light); padding:12px; border-radius:8px; border-left:4px solid var(--color-primary);">
                            <b>Exam Schedule Released</b><br>
                            <span style="font-size:12px; color:var(--color-text-sub);">Final exams start from March 15th. Check the schedule tab.</span>
                        </div>
                        <div style="background:var(--color-warning-bg); padding:12px; border-radius:8px; border-left:4px solid var(--color-warning);">
                            <b>Fee Submission</b><br>
                            <span style="font-size:12px; color:var(--color-text-sub);">Last date for Quarter 4 fees is Feb 28th.</span>
                        </div>
                    </div>
                `;
                container.appendChild(notis);
            },

            getDashboardStats: (user) => {
                // Mock logic for stats
                if (user.role === 'Student') return { pendingTasks: 3, attendance: 87 };
                if (user.role === 'Teacher') return { pendingTasks: 1, attendance: 95 };
                return { pendingTasks: 5, attendance: 100 };
            },

            // 9.2 USER MANAGEMENT (ADMIN ONLY)
            renderUserManagement: (container) => {
                const users = DB.select('users');
                const pending = users.filter(u => u.status === 'Pending');
                const active = users.filter(u => u.status === 'Active');

                let html = `<div class="card-header"><span class="card-title">User Database</span> <button class="btn btn-primary btn-sm" onclick="ModalService.open('register-modal')">+ Add User</button></div>`;

                // Pending Section
                if (pending.length > 0) {
                    html += `
                    <div class="card" style="border-left:4px solid var(--color-warning);">
                        <h4 style="color:var(--color-warning); margin-bottom:15px;">‚ö†Ô∏è Pending Approvals (${pending.length})</h4>
                        ${pending.map(u => `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--color-border);">
                                <div>
                                    <div style="font-weight:700;">${u.name}</div>
                                    <div style="font-size:12px; color:var(--color-text-sub);">${u.role} ‚Ä¢ ${u.userId}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-success btn-sm" onclick="AdminActions.approveUser('${u.userId}')">Approve</button>
                                    <button class="btn btn-danger btn-sm" onclick="AdminActions.rejectUser('${u.userId}')">Reject</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }

                // Active Users List
                html += `<div class="card">`;
                html += `
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input type="text" class="form-control" placeholder="Search users by name or ID..." onkeyup="AdminActions.filterUsers(this.value)">
                    </div>
                    <div id="user-list-container" style="max-height:400px; overflow-y:auto;">
                        ${active.map(u => PageControllers.generateUserRow(u)).join('')}
                    </div>
                `;
                html += `</div>`;

                container.innerHTML = html;
            },

            generateUserRow: (u) => {
                return `
                    <div class="user-row" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--color-border);">
                        <div class="flex items-center gap-4">
                            <div style="width:32px; height:32px; background:var(--color-bg); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;">${u.name.charAt(0)}</div>
                            <div>
                                <div style="font-weight:600; font-size:14px;">${u.name}</div>
                                <div style="font-size:11px; color:var(--color-text-sub);">${u.role} | ID: ${u.userId} | Batch: ${u.batch || 'N/A'}</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="AdminActions.editUser('${u.userId}')">Edit</button>
                    </div>
                `;
            },

            // 9.3 COURSE LIBRARY
            renderCourses: (container) => {
                const courses = DB.select('courses');
                
                // Filters
                const filters = document.createElement('div');
                filters.style.cssText = 'display:flex; gap:10px; overflow-x:auto; margin-bottom:20px; padding-bottom:5px;';
                ['All', 'Physics', 'Chemistry', 'Maths', 'Biology'].forEach(sub => {
                    const pill = document.createElement('span');
                    pill.innerText = sub;
                    pill.style.cssText = 'background:white; border:1px solid var(--color-border); padding:6px 12px; border-radius:20px; font-size:12px; cursor:pointer; white-space:nowrap;';
                    pill.onclick = (e) => {
                        e.target.style.background = 'var(--color-primary)';
                        e.target.style.color = 'white';
                        // Logic to filter grid would go here
                    };
                    filters.appendChild(pill);
                });
                container.appendChild(filters);

                // Grid
                const grid = document.createElement('div');
                grid.style.cssText = 'display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px;';
                
                courses.forEach(c => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.margin = '0';
                    card.style.padding = '0';
                    card.style.overflow = 'hidden';
                    card.innerHTML = `
                        <div style="height:140px; background:#e2e8f0; display:flex; align-items:center; justify-content:center;">
                            <i class="material-icons" style="font-size:48px; color:#94a3b8;">play_circle_outline</i>
                        </div>
                        <div style="padding:16px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span class="badge b-blue">Video Course</span>
                                <span style="font-size:12px; font-weight:700; color:var(--color-warning);">‚òÖ ${c.rating}</span>
                            </div>
                            <h4 style="margin-bottom:6px;">${c.title}</h4>
                            <p style="font-size:12px; color:var(--color-text-sub); margin-bottom:16px;">${c.description}</p>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:800;">‚Çπ${c.price}</span>
                                <button class="btn btn-primary btn-sm" onclick="MediaService.playVideo('${c.videoUrl}')">Watch Demo</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                if (AuthenticationService.currentUser.role === 'Admin') {
                    // Add "Create Course" Card
                    const addCard = document.createElement('div');
                    addCard.className = 'card';
                    addCard.style.cssText = 'margin:0; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; border:2px dashed var(--color-border); background:transparent;';
                    addCard.innerHTML = `<i class="material-icons" style="font-size:32px; color:var(--color-text-sub);">add</i><span style="font-size:13px; font-weight:600; color:var(--color-text-sub); margin-top:8px;">Add New Course</span>`;
                    addCard.onclick = () => ModalService.open('course-modal');
                    grid.appendChild(addCard);
                }

                container.appendChild(grid);
            },

            // 9.4 BATCH & ATTENDANCE MANAGEMENT
            renderBatches: (container) => {
                const batches = DB.select('batches');
                
                let html = `<div class="card-header"><span class="card-title">Classroom Management</span></div>`;
                
                // Batch Selector
                html += `<div style="display:flex; gap:10px; overflow-x:auto; margin-bottom:20px;">`;
                batches.forEach(b => {
                    html += `<button class="btn btn-secondary" onclick="PageControllers.loadBatchDetails('${b.name}')">${b.name}</button>`;
                });
                html += `</div>`;

                // Dynamic Container for Batch Details
                html += `<div id="batch-view-area">
                    <div class="card" style="text-align:center; padding:40px; color:var(--color-text-sub);">
                        <i class="material-icons" style="font-size:48px; margin-bottom:10px;">class</i>
                        <p>Select a batch above to view students and manage attendance.</p>
                    </div>
                </div>`;

                container.innerHTML = html;
            },

            loadBatchDetails: (batchName) => {
                const students = DB.select('users', u => u.role === 'Student' && u.batch === batchName);
                
                const html = `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">${batchName} (${students.length} Students)</span>
                            <button class="btn btn-success btn-sm" onclick="BatchActions.saveAttendance('${batchName}')">Save Register</button>
                        </div>
                        <div class="attendance-grid">
                            ${students.map(s => `
                                <div class="attendance-card present" id="att-${s.userId}" onclick="BatchActions.toggleAttendance(this)">
                                    <div style="font-weight:700;">${s.name}</div>
                                    <div style="font-size:11px;">${s.userId}</div>
                                    <div style="margin-top:5px; font-size:10px; font-weight:800; text-transform:uppercase;">Present</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.getElementById('batch-view-area').innerHTML = html;
            }
        };

        // Admin Actions Handler
        const AdminActions = {
            approveUser: (id) => {
                if(confirm("Approve this user?")) {
                    DB.update('users', id, { status: 'Active' });
                    RouterService.navigate('users'); // Refresh
                    Utils.showToast("User Approved Successfully", "success");
                }
            },
            rejectUser: (id) => {
                if(confirm("Reject and delete this user?")) {
                    DB.remove('users', id);
                    RouterService.navigate('users');
                    Utils.showToast("User Rejected", "error");
                }
            },
            filterUsers: (query) => {
                const term = query.toLowerCase();
                const users = DB.select('users', u => u.status === 'Active');
                const filtered = users.filter(u => u.name.toLowerCase().includes(term) || u.userId.toLowerCase().includes(term));
                document.getElementById('user-list-container').innerHTML = filtered.map(u => PageControllers.generateUserRow(u)).join('');
            }
        };

        // Batch Actions Handler
        const BatchActions = {
            toggleAttendance: (el) => {
                if (el.classList.contains('present')) {
                    el.classList.remove('present');
                    el.classList.add('absent');
                    el.querySelector('div:last-child').innerText = 'ABSENT';
                } else {
                    el.classList.remove('absent');
                    el.classList.add('present');
                    el.querySelector('div:last-child').innerText = 'PRESENT';
                }
            },
            saveAttendance: (batch) => {
                // Logic to scrape DOM and save to DB
                const date = new Date().toLocaleDateString();
                Utils.showToast(`Attendance for ${batch} on ${date} saved to database.`, 'success');
            }
        };
    </script>
    <script>
        /* ======================================================================================
           MODULE 10: MODAL & OVERLAY SERVICE
           ====================================================================================== */
        const ModalService = {
            activeModal: null,

            // Open a specific modal by ID
            open: (modalId, data = null) => {
                const modal = document.getElementById(modalId);
                if (!modal) {
                    console.error(`Modal with ID ${modalId} not found.`);
                    return;
                }

                // If opening the Edit User modal, populate data
                if (modalId === 'edit-user-modal' && data) {
                    FormHandlers.populateEditUser(data);
                }

                // If opening Course modal, populate categories
                if (modalId === 'course-modal') {
                    FormHandlers.populateCourseCategories();
                }

                this.activeModal = modal;
                modal.style.display = 'flex';
                
                // Animation triggers
                const content = modal.querySelector('.modal-content');
                content.style.opacity = '0';
                content.style.transform = 'translateY(20px)';
                
                requestAnimationFrame(() => {
                    content.style.transition = 'all 0.3s ease';
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                });
            },

            // Close specific or active modal
            close: (modalId = null) => {
                const target = modalId ? document.getElementById(modalId) : this.activeModal;
                if (!target) return;

                const content = target.querySelector('.modal-content');
                content.style.opacity = '0';
                content.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    target.style.display = 'none';
                    this.activeModal = null;
                    // Reset forms inside if any
                    const form = target.querySelector('input, select');
                    if (form) {
                        target.querySelectorAll('input').forEach(i => i.value = '');
                        target.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                    }
                }, 300);
            }
        };

        /* ======================================================================================
           MODULE 11: FORM HANDLERS & VALIDATION LOGIC
           ====================================================================================== */
        const FormHandlers = {
            
            // 11.1 Dynamic Registration Form Logic
            toggleRegistrationFields: () => {
                const role = document.getElementById('reg-role').value;
                const studentFields = document.getElementById('reg-student-fields');
                const teacherFields = document.getElementById('reg-teacher-fields');

                if (role === 'Student') {
                    studentFields.classList.remove('hidden');
                    teacherFields.classList.add('hidden');
                    // Populate Batches dynamically
                    const batchSelect = document.getElementById('reg-batch');
                    const batches = DB.select('batches');
                    batchSelect.innerHTML = batches.map(b => `<option value="${b.name}">${b.name}</option>`).join('');
                } else if (role === 'Teacher') {
                    studentFields.classList.add('hidden');
                    teacherFields.classList.remove('hidden');
                } else {
                    // Admin
                    studentFields.classList.add('hidden');
                    teacherFields.classList.add('hidden');
                }
            },

            // 11.2 Edit User Data Population
            populateEditUser: (userId) => {
                const user = DB.findOne('users', u => u.userId === userId);
                if (!user) return;

                document.getElementById('edit-user-id').value = user.userId;
                document.getElementById('edit-name').value = user.name;
                document.getElementById('edit-mobile').value = user.mobile;
                
                // Show/Hide fields based on role
                const batchGroup = document.getElementById('edit-batch-group');
                if (user.role === 'Student') {
                    batchGroup.classList.remove('hidden');
                    const batchSelect = document.getElementById('edit-batch');
                    const batches = DB.select('batches');
                    batchSelect.innerHTML = batches.map(b => `<option value="${b.name}" ${user.batch === b.name ? 'selected' : ''}>${b.name}</option>`).join('');
                } else {
                    batchGroup.classList.add('hidden');
                }
            },

            // 11.3 Save Edited User
            saveUserChanges: () => {
                const id = document.getElementById('edit-user-id').value;
                const name = document.getElementById('edit-name').value;
                const mobile = document.getElementById('edit-mobile').value;
                const batch = document.getElementById('edit-batch').value;

                if (!Utils.isValidPhone(mobile)) {
                    return Utils.showToast("Invalid Mobile Number Format", "error");
                }

                const success = DB.update('users', id, {
                    name: name,
                    mobile: mobile,
                    batch: batch
                });

                if (success) {
                    Utils.showToast("User Profile Updated Successfully", "success");
                    ModalService.close('edit-user-modal');
                    // Refresh current view if we are on Users page
                    if (RouterService.currentPage === 'users') {
                        RouterService.navigate('users');
                    }
                } else {
                    Utils.showToast("Failed to update database.", "error");
                }
            },

            // 11.4 Course Category Population
            populateCourseCategories: () => {
                const categories = ['Science', 'Mathematics', 'Languages', 'Competitive Exams', 'Arts'];
                const select = document.getElementById('course-category');
                select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            },

            // 11.5 Add New Course Logic
            submitNewCourse: () => {
                const title = document.getElementById('course-title').value;
                const price = document.getElementById('course-price').value;
                const desc = document.getElementById('course-desc').value;
                const cat = document.getElementById('course-category').value;
                const url = document.getElementById('course-video').value;

                if (!title || !price || !url) {
                    return Utils.showToast("Please fill all required fields", "warning");
                }

                const newCourse = {
                    title: title,
                    price: parseFloat(price),
                    description: desc,
                    category: cat,
                    videoUrl: url,
                    rating: 0,
                    enrolled: 0,
                    authorId: AuthenticationService.currentUser.userId
                };

                DB.insert('courses', newCourse);
                Utils.showToast("Course Published to Marketplace", "success");
                ModalService.close('course-modal');
                
                if (RouterService.currentPage === 'courses') {
                    RouterService.navigate('courses');
                }
            }
        };

        /* ======================================================================================
           MODULE 12: ASSIGNMENT & HOMEWORK SUBSYSTEM
           ====================================================================================== */
        const AssignmentService = {
            
            // Render Assignment List for a Batch
            renderAssignments: (batchName, containerId) => {
                const assignments = DB.select('notifications', n => n.type === 'assignment' && n.targetBatch === batchName);
                const container = document.getElementById(containerId);
                
                if (assignments.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--color-text-sub);">No active assignments.</div>`;
                    return;
                }

                container.innerHTML = assignments.map(a => `
                    <div class="card" style="margin-bottom:10px; border-left:4px solid var(--color-info);">
                        <div class="flex justify-between">
                            <div>
                                <div style="font-weight:700;">${a.title}</div>
                                <div style="font-size:12px; color:var(--color-text-sub);">Due: ${Utils.formatDate(a.dueDate)}</div>
                            </div>
                            ${AuthenticationService.currentUser.role === 'Student' 
                                ? `<button class="btn btn-sm btn-primary" onclick="AssignmentService.openSubmission('${a.id}')">Submit</button>`
                                : `<button class="btn btn-sm btn-secondary" onclick="AssignmentService.viewSubmissions('${a.id}')">View</button>`
                            }
                        </div>
                    </div>
                `).join('');
            },

            // Create New Assignment (Teacher)
            createAssignment: () => {
                const title = prompt("Enter Assignment Title:");
                if (!title) return;
                
                const dueDate = prompt("Enter Due Date (YYYY-MM-DD):");
                // In a real modal, this would be a date picker
                
                const batch = prompt("Target Batch Name (Exact):");
                
                DB.insert('notifications', {
                    type: 'assignment',
                    title: title,
                    dueDate: dueDate,
                    targetBatch: batch,
                    senderId: AuthenticationService.currentUser.userId,
                    message: `New Assignment: ${title}`
                });

                Utils.showToast("Assignment Posted!", "success");
            },

            // Student Submits Homework
            openSubmission: (assignmentId) => {
                const link = prompt("Paste your Google Drive/PDF Link:");
                if (link) {
                    DB.insert('submissions', {
                        assignmentId: assignmentId,
                        studentId: AuthenticationService.currentUser.userId,
                        link: link,
                        grade: null,
                        status: 'Submitted'
                    });
                    Utils.showToast("Homework Submitted Successfully", "success");
                }
            }
        };
    </script>
    <script>
        /* ======================================================================================
           MODULE 13: ATHENA EXAMINATION ENGINE
           ====================================================================================== */
        const ExamService = {
            activeSession: null,
            timerInterval: null,

            // 13.1 Teacher: Render Exam Builder UI
            renderExamBuilder: (container) => {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header"><span class="card-title">Create New Examination</span></div>
                        
                        <div class="input-group">
                            <label class="form-label">Exam Title</label>
                            <input id="exam-title" class="form-input" placeholder="e.g. Physics Mid-Term">
                        </div>
                        
                        <div class="flex gap-4">
                            <div class="input-group w-full">
                                <label class="form-label">Duration (Minutes)</label>
                                <input id="exam-duration" type="number" class="form-input" value="60">
                            </div>
                            <div class="input-group w-full">
                                <label class="form-label">Target Batch</label>
                                <select id="exam-batch" class="form-input"></select>
                            </div>
                        </div>

                        <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
                        
                        <div id="questions-container"></div>
                        
                        <button class="btn btn-secondary w-full" onclick="ExamService.addQuestionInput()">
                            <i class="material-icons">add</i> Add Question
                        </button>
                        
                        <div class="flex gap-2" style="margin-top:20px;">
                            <button class="btn btn-primary w-full" onclick="ExamService.publishExam()">Publish Exam</button>
                            <button class="btn btn-danger w-full" onclick="RouterService.navigate('dashboard')">Cancel</button>
                        </div>
                    </div>
                `;

                // Populate batches
                const batchSelect = document.getElementById('exam-batch');
                batchSelect.innerHTML = DB.select('batches').map(b => `<option>${b.name}</option>`).join('');
                
                // Add first question slot
                this.addQuestionInput();
            },

            // Helper to add question DOM elements
            addQuestionInput: () => {
                const container = document.getElementById('questions-container');
                const qNum = container.children.length + 1;
                
                const qDiv = document.createElement('div');
                qDiv.className = 'card';
                qDiv.style.background = '#f8fafc';
                qDiv.style.border = '1px dashed var(--border)';
                qDiv.innerHTML = `
                    <div class="form-label">Question ${qNum}</div>
                    <input class="form-input q-text" placeholder="Question text..." style="margin-bottom:10px;">
                    <div class="grid grid-cols-2 gap-2">
                        <input class="form-input q-opt" placeholder="Option A">
                        <input class="form-input q-opt" placeholder="Option B">
                        <input class="form-input q-opt" placeholder="Option C">
                        <input class="form-input q-opt" placeholder="Option D">
                    </div>
                    <div style="margin-top:10px;">
                        <label class="form-label">Correct Option Index (0-3)</label>
                        <input type="number" class="form-input q-correct" min="0" max="3" placeholder="e.g. 0 for A">
                    </div>
                `;
                container.appendChild(qDiv);
            },

            // 13.2 Publish Logic
            publishExam: () => {
                const title = document.getElementById('exam-title').value;
                const duration = document.getElementById('exam-duration').value;
                const batch = document.getElementById('exam-batch').value;
                
                // Harvest Questions
                const qContainers = document.querySelectorAll('#questions-container > div');
                const questions = [];
                
                qContainers.forEach(div => {
                    const text = div.querySelector('.q-text').value;
                    const opts = Array.from(div.querySelectorAll('.q-opt')).map(i => i.value);
                    const correct = div.querySelector('.q-correct').value;
                    
                    if(text && correct) {
                        questions.push({ q: text, options: opts, correct: parseInt(correct) });
                    }
                });

                if (questions.length === 0) return Utils.showToast("Add at least one question", "error");

                DB.insert('exams', {
                    title: title,
                    duration: parseInt(duration),
                    batch: batch,
                    questions: questions,
                    createdBy: AuthenticationService.currentUser.userId,
                    status: 'Active'
                });

                Utils.showToast("Exam Published Successfully!", "success");
                RouterService.navigate('exams');
            },

            // 13.3 Student: Start Exam Interface
            startExam: (examId) => {
                const exam = DB.findOne('exams', e => e.id === examId);
                if (!exam) return;

                this.activeSession = {
                    examId: exam.id,
                    answers: new Array(exam.questions.length).fill(null),
                    startTime: Date.now(),
                    duration: exam.duration * 60, // seconds
                    timeLeft: exam.duration * 60
                };

                // Show Fullscreen Engine
                const layer = document.getElementById('exam-engine-layer');
                layer.style.display = 'flex';

                // Render Questions
                const container = document.getElementById('exam-question-container');
                container.innerHTML = exam.questions.map((q, idx) => `
                    <div class="card" id="q-card-${idx}">
                        <div class="card-header">
                            <span class="badge b-blue">Question ${idx + 1}</span>
                        </div>
                        <h3 style="margin-bottom:20px;">${q.q}</h3>
                        <div class="options-list">
                            ${q.options.map((opt, oIdx) => `
                                <div class="exam-option" onclick="ExamService.selectOption(${idx}, ${oIdx}, this)">
                                    <span style="font-weight:700; margin-right:10px;">${String.fromCharCode(65+oIdx)}.</span> ${opt}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                // Start Timer
                this.timerInterval = setInterval(() => {
                    this.activeSession.timeLeft--;
                    const m = Math.floor(this.activeSession.timeLeft / 60);
                    const s = this.activeSession.timeLeft % 60;
                    document.getElementById('exam-timer-display').innerText = 
                        `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    
                    if (this.activeSession.timeLeft <= 0) {
                        this.submitExam(true);
                    }
                }, 1000);
            },

            // 13.4 Handle Selection
            selectOption: (qIdx, oIdx, element) => {
                // UI Update
                const parent = element.parentNode;
                parent.querySelectorAll('.exam-option').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                
                // State Update
                this.activeSession.answers[qIdx] = oIdx;
            },

            // 13.5 Submit & Auto-Grade
            submitExam: (force = false) => {
                if (!force && !confirm("Are you sure you want to submit?")) return;

                clearInterval(this.timerInterval);
                const exam = DB.findOne('exams', e => e.id === this.activeSession.examId);
                
                // Calculate Score
                let score = 0;
                let correctCount = 0;
                
                this.activeSession.answers.forEach((ans, idx) => {
                    if (ans === exam.questions[idx].correct) {
                        score += 4; // +4 for correct
                        correctCount++;
                    } else if (ans !== null) {
                        score -= 1; // -1 for wrong (JEE style)
                    }
                });

                // Generate Result Object
                const result = {
                    studentId: AuthenticationService.currentUser.userId,
                    studentName: AuthenticationService.currentUser.name,
                    examId: exam.id,
                    examTitle: exam.title,
                    score: score,
                    totalMarks: exam.questions.length * 4,
                    correct: correctCount,
                    totalQuestions: exam.questions.length,
                    date: new Date().toLocaleDateString()
                };

                DB.insert('results', result);

                // Hide Engine
                document.getElementById('exam-engine-layer').style.display = 'none';
                
                // Show Result Modal
                alert(`Exam Submitted!\nScore: ${score}/${result.totalMarks}\nCorrect: ${correctCount}`);
                RouterService.navigate('results');
            }
        };

        /* ======================================================================================
           MODULE 14: LEADERBOARD & RESULTS SERVICE
           ====================================================================================== */
        const ResultService = {
            // Render Student Result History
            renderStudentResults: (container) => {
                const uid = AuthenticationService.currentUser.userId;
                const results = DB.select('results', r => r.studentId === uid);

                if (results.length === 0) {
                    container.innerHTML = `<div class="card text-center">No results found yet. Take an exam!</div>`;
                    return;
                }

                // Chart Container
                const canvasId = 'chart-' + Math.random().toString(36).substr(2, 9);
                container.innerHTML = `
                    <div class="card">
                        <canvas id="${canvasId}" style="max-height:300px;"></canvas>
                    </div>
                    <div class="card-header"><span class="card-title">Detailed Report</span></div>
                `;

                // Render List
                results.forEach(r => {
                    const perc = Math.round((r.score / r.totalMarks) * 100);
                    let color = 'var(--danger)';
                    if(perc > 75) color = 'var(--success)';
                    else if(perc > 50) color = 'var(--warning)';

                    const item = document.createElement('div');
                    item.className = 'card';
                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4>${r.examTitle}</h4>
                                <div style="font-size:12px; color:var(--color-text-sub);">${r.date}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:24px; font-weight:700; color:${color};">${r.score}</div>
                                <div style="font-size:10px;">MARKS</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });

                // Render Chart (Simulated if Lib not loaded, else real)
                setTimeout(() => {
                    if (window.Chart) {
                        new Chart(document.getElementById(canvasId), {
                            type: 'line',
                            data: {
                                labels: results.map(r => r.examTitle.substr(0,10)+'...'),
                                datasets: [{
                                    label: 'Score Progression',
                                    data: results.map(r => r.score),
                                    borderColor: '#0f5bb8',
                                    tension: 0.3
                                }]
                            }
                        });
                    }
                }, 100);
            },

            // Render Global Leaderboard (Admin/Teacher)
            renderGlobalLeaderboard: (container) => {
                const results = DB.select('results');
                // Group by Student logic could go here
                // For now, flat list sorted by score descending
                results.sort((a,b) => b.score - a.score);

                const table = document.createElement('div');
                table.className = 'card';
                table.innerHTML = `
                    <div class="card-header"><span class="card-title">üèÜ Toppers List</span></div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead style="background:var(--bg-body); border-bottom:2px solid var(--border);">
                                <tr>
                                    <th style="padding:10px; text-align:left;">Rank</th>
                                    <th style="padding:10px; text-align:left;">Student</th>
                                    <th style="padding:10px; text-align:left;">Exam</th>
                                    <th style="padding:10px; text-align:right;">Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.slice(0, 10).map((r, i) => `
                                    <tr style="border-bottom:1px solid var(--border);">
                                        <td style="padding:10px;">#${i+1}</td>
                                        <td style="padding:10px; font-weight:600;">${r.studentName}</td>
                                        <td style="padding:10px;">${r.examTitle}</td>
                                        <td style="padding:10px; text-align:right; font-weight:700;">${r.score}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                container.appendChild(table);
            }
        };
    </script>
    <script>
        /* ======================================================================================
           MODULE 15: LIVE VIDEO CLASSROOM SERVICE (Jitsi Integration)
           ====================================================================================== */
        const VideoService = {
            api: null,
            activeRoom: null,
            startTime: null,

            // 15.1 Start/Join Logic
            launchClassroom: (roomName) => {
                if (!window.JitsiMeetExternalAPI) {
                    return Utils.showToast("Video Server Unreachable. Check Internet.", "error");
                }

                const user = AuthenticationService.currentUser;
                const domain = 'meet.jit.si';
                
                // Unique Room ID generation to prevent stream sniping
                const secureRoomId = `Jalaram_Academy_${roomName.replace(/\s/g, '_')}_${new Date().getFullYear()}`;
                this.activeRoom = secureRoomId;
                this.startTime = Date.now();

                // Show Overlay
                const overlay = document.getElementById('video-engine-layer');
                overlay.style.display = 'flex';

                // Jitsi Options
                const options = {
                    roomName: secureRoomId,
                    width: '100%',
                    height: '100%',
                    parentNode: document.getElementById('video-engine-layer').querySelector('div:last-child'), // The container div
                    userInfo: {
                        displayName: `${user.name} (${user.role})`
                    },
                    configOverwrite: { 
                        startWithAudioMuted: true, 
                        startWithVideoMuted: true,
                        prejoinPageEnabled: false 
                    },
                    interfaceConfigOverwrite: {
                        TOOLBAR_BUTTONS: [
                            'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                            'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                            'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                            'videoquality', 'filmstrip', 'feedback', 'stats', 'shortcuts',
                            'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
                            'security'
                        ],
                    }
                };

                // Initialize API
                // Clear previous instances if any to prevent memory leaks
                const container = options.parentNode;
                container.innerHTML = ''; 
                
                try {
                    this.api = new JitsiMeetExternalAPI(domain, options);
                    
                    // Event Listeners for Attendance Tracking
                    this.api.addEventListeners({
                        videoConferenceLeft: () => this.handleCallEnd(),
                        participantJoined: (participant) => console.log('User Joined:', participant),
                    });

                    Utils.showToast(`Connected to ${roomName} Live`, "success");
                } catch (e) {
                    console.error("Jitsi Error:", e);
                    Utils.showToast("Failed to initialize video engine.", "error");
                    this.closeOverlay();
                }
            },

            // 15.2 Cleanup & Attendance Logging
            handleCallEnd: () => {
                const endTime = Date.now();
                const duration = Math.round((endTime - this.startTime) / 1000 / 60); // Minutes

                // Log Session to DB (Mock Attendance for Video)
                if (duration > 1) { // Only log if > 1 minute
                    DB.insert('attendance', {
                        userId: AuthenticationService.currentUser.userId,
                        date: new Date().toLocaleDateString(),
                        status: 'Present (Online)',
                        duration: duration + ' mins',
                        type: 'Video Class',
                        batch: this.activeRoom
                    });
                }

                this.closeOverlay();
                Utils.showToast("Classroom Session Ended", "info");
            },

            // 15.3 Force Close (Manual Button)
            closeOverlay: () => {
                if (this.api) {
                    this.api.dispose();
                    this.api = null;
                }
                document.getElementById('video-engine-layer').style.display = 'none';
                RouterService.navigate('dashboard'); // Return to safety
            }
        };

        /* ======================================================================================
           MODULE 16: CHAT & COMMUNICATION ENGINE
           ====================================================================================== */
        const ChatService = {
            activeChannel: 'Global',
            refreshInterval: null,

            // 16.1 Render Chat UI Structure
            renderChatInterface: (container) => {
                const user = AuthenticationService.currentUser;
                
                // Determine accessible channels
                let channels = ['Global'];
                if (user.batch) channels.push(user.batch); // Student's Batch
                if (user.role === 'Teacher') {
                    // Teachers get all batches they manage (Simulated: getting all batches)
                    const batches = DB.select('batches').map(b => b.name);
                    channels = [...channels, ...batches];
                }

                container.innerHTML = `
                    <div class="card" style="height: calc(100vh - 140px); display: flex; padding: 0; overflow: hidden;">
                        <div style="width: 250px; background: #f8fafc; border-right: 1px solid var(--border); display: flex; flex-direction: column;">
                            <div style="padding: 20px; font-weight: 700; border-bottom: 1px solid var(--border);">
                                <i class="material-icons" style="vertical-align: middle; margin-right: 5px;">forum</i> Channels
                            </div>
                            <div class="scrollable" style="flex: 1;">
                                ${channels.map(c => `
                                    <div class="chat-channel-item ${c === this.activeChannel ? 'active' : ''}" 
                                         onclick="ChatService.switchChannel('${c}')"
                                         style="padding: 15px 20px; cursor: pointer; border-bottom: 1px solid var(--border); ${c === this.activeChannel ? 'background:white; border-left: 4px solid var(--primary);' : ''}">
                                        # ${c}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="flex: 1; display: flex; flex-direction: column; background: white;">
                            <div style="height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between;">
                                <span style="font-weight: 700; font-size: 16px;"># ${this.activeChannel}</span>
                                <span style="font-size: 12px; color: var(--color-text-sub);">
                                    <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block;"></span> Online
                                </span>
                            </div>

                            <div id="chat-messages-area" class="scrollable" style="flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 12px;">
                                </div>

                            <div style="padding: 20px; border-top: 1px solid var(--border); background: #f8fafc;">
                                <div style="display: flex; gap: 10px;">
                                    <input id="chat-input-field" type="text" class="form-control" placeholder="Type your message..." onkeypress="ChatService.handleKeyPress(event)">
                                    <button class="btn btn-primary" onclick="ChatService.sendMessage()">
                                        <i class="material-icons">send</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Start Polling
                this.loadMessages();
                if (this.refreshInterval) clearInterval(this.refreshInterval);
                this.refreshInterval = setInterval(() => this.loadMessages(), 3000); // Auto-refresh every 3s
            },

            // 16.2 Switch Channel Logic
            switchChannel: (channelName) => {
                this.activeChannel = channelName;
                // Re-render full interface to update sidebar active state
                // In a framework (React/Vue) this would be cleaner, but in Vanilla JS:
                const container = document.getElementById('main-container');
                this.renderChatInterface(container);
            },

            // 16.3 Load & Render Messages
            loadMessages: () => {
                const container = document.getElementById('chat-messages-area');
                if (!container) return; // Guard clause if view changed

                const messages = DB.select('chats', c => c.channel === this.activeChannel);
                
                // Sort by timestamp
                messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

                const currentUser = AuthenticationService.currentUser.userId;

                const html = messages.map(msg => {
                    const isMe = msg.senderId === currentUser;
                    return `
                        <div style="display: flex; justify-content: ${isMe ? 'flex-end' : 'flex-start'};">
                            <div style="max-width: 70%; ${isMe ? 'background: var(--primary); color: white;' : 'background: #f1f5f9; color: var(--color-text-main);'} padding: 10px 15px; border-radius: 12px; position: relative;">
                                ${!isMe ? `<div style="font-size: 10px; font-weight: 700; margin-bottom: 4px; color: var(--color-text-sub);">${msg.senderName}</div>` : ''}
                                <div style="font-size: 14px; line-height: 1.4;">${msg.text}</div>
                                <div style="font-size: 9px; margin-top: 4px; text-align: right; opacity: 0.7;">${Utils.formatTime(msg.createdAt)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Only update DOM if content changed (Simple check)
                if (container.innerHTML !== html) {
                    container.innerHTML = html;
                    container.scrollTop = container.scrollHeight; // Auto scroll to bottom
                }
            },

            // 16.4 Send Message Logic
            sendMessage: () => {
                const input = document.getElementById('chat-input-field');
                const text = input.value.trim();
                
                if (!text) return;

                const user = AuthenticationService.currentUser;

                DB.insert('chats', {
                    channel: this.activeChannel,
                    senderId: user.userId,
                    senderName: user.name,
                    text: text,
                    type: 'text'
                });

                input.value = '';
                this.loadMessages(); // Instant refresh
            },

            handleKeyPress: (e) => {
                if (e.key === 'Enter') ChatService.sendMessage();
            }
        };

        // Adding Page Controller Mapping for Chat
        // We inject this into the existing PageControllers object via assignment
        PageControllers.renderLiveClass = (container) => {
            // Live class selection screen
            const batches = DB.select('batches');
            container.innerHTML = `
                <div class="card-header"><span class="card-title">Live Classrooms</span></div>
                <div class="attendance-grid">
                    ${batches.map(b => `
                        <div class="card" style="margin:0; text-align:center; cursor:pointer;" onclick="VideoService.launchClassroom('${b.name}')">
                            <div style="background:#fee2e2; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 10px;">
                                <i class="material-icons" style="color:var(--danger); font-size:32px;">videocam</i>
                            </div>
                            <h4 style="margin-bottom:5px;">${b.name}</h4>
                            <span class="badge b-green">JOIN NOW</span>
                        </div>
                    `).join('')}
                </div>
                <div class="card" style="margin-top:20px;">
                    <div class="card-header"><span class="card-title">Global Communication</span></div>
                    <button class="btn btn-primary w-full" onclick="PageControllers.renderChat(document.getElementById('main-container'))">
                        Open Chat Console
                    </button>
                </div>
            `;
        };

        PageControllers.renderChat = (container) => {
            ChatService.renderChatInterface(container);
        };

    </script>
    <script>
        /* ======================================================================================
           MODULE 17: FINANCIAL & FEE MANAGEMENT SERVICE
           ====================================================================================== */
        const FinanceService = {
            
            // 17.1 Initialize Ledger (Seed Data)
            initLedger: () => {
                if (DB.select('fees').length === 0) {
                    const students = DB.select('users', u => u.role === 'Student');
                    students.forEach(s => {
                        DB.insert('fees', {
                            studentId: s.userId,
                            studentName: s.name,
                            totalAmount: 50000,
                            paidAmount: 25000,
                            dueDate: '2026-03-31',
                            status: 'Partial', // Paid, Partial, Overdue
                            history: [
                                { date: '2026-01-10', amount: 15000, method: 'UPI' },
                                { date: '2026-02-05', amount: 10000, method: 'Cash' }
                            ]
                        });
                    });
                }
            },

            // 17.2 Render Fee Panel (Student View)
            renderStudentFees: (container) => {
                const user = AuthenticationService.currentUser;
                const feeRecord = DB.findOne('fees', f => f.studentId === user.userId);

                if (!feeRecord) {
                    FinanceService.initLedger(); // Lazy init
                    container.innerHTML = "Loading financial data...";
                    setTimeout(() => FinanceService.renderStudentFees(container), 500);
                    return;
                }

                const pending = feeRecord.totalAmount - feeRecord.paidAmount;
                const progress = (feeRecord.paidAmount / feeRecord.totalAmount) * 100;

                container.innerHTML = `
                    <div class="card" style="background: linear-gradient(135deg, #1e293b, #0f172a); color: white;">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <div style="font-size:12px; opacity:0.7;">TOTAL OUTSTANDING</div>
                                <div style="font-size:32px; font-weight:700;">‚Çπ${pending.toLocaleString()}</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="badge ${pending > 0 ? 'b-red' : 'b-green'}">${feeRecord.status}</div>
                                <div style="font-size:12px; margin-top:5px;">Due: ${Utils.formatDate(feeRecord.dueDate)}</div>
                            </div>
                        </div>
                        <div style="background:rgba(255,255,255,0.1); height:8px; border-radius:4px; overflow:hidden;">
                            <div style="width:${progress}%; background:var(--success); height:100%;"></div>
                        </div>
                        <div class="flex justify-between" style="font-size:12px; margin-top:8px;">
                            <span>Paid: ‚Çπ${feeRecord.paidAmount.toLocaleString()}</span>
                            <span>Total: ‚Çπ${feeRecord.totalAmount.toLocaleString()}</span>
                        </div>
                        <button class="btn btn-primary w-full mt-4" onclick="FinanceService.openPaymentGateway(${pending})">
                            Pay Now via UPI/Card
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-title">Transaction History</span></div>
                        <table style="width:100%; border-collapse:collapse; font-size:13px;">
                            <tr style="border-bottom:1px solid var(--border); color:var(--color-text-sub);">
                                <th style="text-align:left; padding:8px;">Date</th>
                                <th style="text-align:left; padding:8px;">Method</th>
                                <th style="text-align:right; padding:8px;">Amount</th>
                            </tr>
                            ${feeRecord.history.map(h => `
                                <tr style="border-bottom:1px solid var(--border);">
                                    <td style="padding:10px 8px;">${Utils.formatDate(h.date)}</td>
                                    <td style="padding:10px 8px;">${h.method}</td>
                                    <td style="padding:10px 8px; text-align:right; font-weight:600; color:var(--success);">+ ‚Çπ${h.amount.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            },

            // 17.3 Simulate Payment Gateway
            openPaymentGateway: (amount) => {
                if (amount <= 0) return Utils.showToast("No pending dues!", "success");
                
                const amountToPay = prompt(`Enter amount to pay (Max: ${amount}):`, amount);
                if (amountToPay && !isNaN(amountToPay) && amountToPay > 0 && amountToPay <= amount) {
                    // Simulate Processing
                    Utils.showToast("Contacting Bank Server...", "info");
                    setTimeout(() => {
                        const user = AuthenticationService.currentUser;
                        const record = DB.findOne('fees', f => f.studentId === user.userId);
                        
                        // Update Record
                        record.paidAmount += parseInt(amountToPay);
                        record.history.push({
                            date: new Date().toISOString(),
                            amount: parseInt(amountToPay),
                            method: 'Online Gateway'
                        });
                        
                        if (record.paidAmount >= record.totalAmount) record.status = 'Paid';
                        
                        DB.update('fees', record.id, record);
                        
                        Utils.showToast("Payment Successful! Receipt emailed.", "success");
                        RouterService.navigate('dashboard'); // Refresh
                    }, 2000);
                } else {
                    Utils.showToast("Invalid Amount", "error");
                }
            }
        };

        /* ======================================================================================
           MODULE 18: NOTIFICATION CENTER SERVICE
           ====================================================================================== */
        const NotificationService = {
            
            // 18.1 Fetch & Display
            checkNotifications: () => {
                const user = AuthenticationService.currentUser;
                // Get general notifications or specific to user
                const notis = DB.select('notifications', n => 
                    !n.readBy?.includes(user.userId) && 
                    (n.targetBatch === 'All' || n.targetBatch === user.batch)
                );

                // Update Header Icon (Mock implementation of finding the bell icon)
                const bellIcon = document.getElementById('header-noti-badge');
                if (bellIcon) {
                    if (notis.length > 0) {
                        bellIcon.style.display = 'block';
                        bellIcon.innerText = notis.length;
                    } else {
                        bellIcon.style.display = 'none';
                    }
                }
                return notis;
            },

            // 18.2 Render Panel
            renderPanel: (container) => {
                const notis = NotificationService.checkNotifications();
                
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Notifications</span>
                            <button class="btn btn-sm btn-secondary" onclick="NotificationService.markAllRead()">Mark All Read</button>
                        </div>
                        <div class="flex flex-col gap-2">
                            ${notis.length === 0 ? '<div style="padding:20px; text-align:center; color:gray;">All caught up!</div>' : ''}
                            ${notis.map(n => `
                                <div class="card" style="margin:0; border-left: 4px solid var(--primary); background: #f8fafc;">
                                    <div style="font-weight:700; margin-bottom:4px;">${n.title}</div>
                                    <div style="font-size:13px; color:var(--color-text-sub);">${n.message}</div>
                                    <div style="font-size:10px; margin-top:8px; color:#94a3b8;">${Utils.formatTime(n.createdAt || new Date())}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            // 18.3 Mark as Read
            markAllRead: () => {
                const user = AuthenticationService.currentUser;
                const notis = DB.select('notifications');
                notis.forEach(n => {
                    if (!n.readBy) n.readBy = [];
                    if (!n.readBy.includes(user.userId)) n.readBy.push(user.userId);
                });
                DB.commit('notifications');
                Utils.showToast("Notifications cleared", "success");
                // Re-render
                NotificationService.renderPanel(document.getElementById('main-container'));
            }
        };

        /* ======================================================================================
           MODULE 19: RESOURCE & LIBRARY SERVICE
           ====================================================================================== */
        const ResourceService = {
            
            // 19.1 Render Library
            renderLibrary: (container) => {
                const batch = AuthenticationService.currentUser.batch || 'Class 10-A';
                
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 style="font-size:20px; font-weight:700;">Study Material (${batch})</h2>
                        ${AuthenticationService.currentUser.role === 'Teacher' 
                            ? `<button class="btn btn-primary" onclick="ResourceService.uploadFile()">+ Upload Note</button>` 
                            : ''
                        }
                    </div>
                    
                    <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:16px;">
                        ${ResourceService.getFileCard('Physics Ch-1 Notes', 'PDF', '2.4 MB')}
                        ${ResourceService.getFileCard('Chemistry Formula Sheet', 'PDF', '1.1 MB')}
                        ${ResourceService.getFileCard('Maths PYQ 2025', 'DOCX', '500 KB')}
                        ${ResourceService.getFileCard('Biology Diagrams', 'IMG', '3.2 MB')}
                        ${ResourceService.getFileCard('HC Verma Solutions', 'PDF', '15 MB')}
                    </div>
                `;
            },

            getFileCard: (name, type, size) => {
                let icon = 'description';
                let color = '#64748b';
                if (type === 'PDF') { icon = 'picture_as_pdf'; color = '#ef4444'; }
                if (type === 'DOCX') { icon = 'article'; color = '#3b82f6'; }
                if (type === 'IMG') { icon = 'image'; color = '#10b981'; }

                return `
                    <div class="card" style="margin:0; text-align:center; padding:20px; cursor:pointer; transition:all 0.2s;" onclick="Utils.showToast('Downloading ${name}...', 'info')">
                        <i class="material-icons" style="font-size:48px; color:${color}; margin-bottom:10px;">${icon}</i>
                        <div style="font-weight:600; font-size:13px; margin-bottom:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</div>
                        <div style="font-size:11px; color:#94a3b8;">${type} ‚Ä¢ ${size}</div>
                    </div>
                `;
            },

            uploadFile: () => {
                const name = prompt("Enter File Name:");
                if (name) {
                    Utils.showToast("Uploading to Secure Cloud...", "info");
                    setTimeout(() => {
                        Utils.showToast("File Uploaded Successfully!", "success");
                        // In a real app, this would update the DOM list
                    }, 1500);
                }
            }
        };

        // --- Extend PageControllers for New Features ---
        
        // Settings / Profile Page
        PageControllers.renderSettings = (container) => {
            const user = AuthenticationService.currentUser;
            container.innerHTML = `
                <div class="card">
                    <div class="card-header"><span class="card-title">My Profile</span></div>
                    <div class="flex items-center gap-4 mb-4">
                        <div style="width:80px; height:80px; border-radius:50%; background:var(--primary); color:white; font-size:32px; font-weight:700; display:flex; align-items:center; justify-content:center;">
                            ${user.name.charAt(0)}
                        </div>
                        <div>
                            <h3 style="font-size:24px;">${user.name}</h3>
                            <div style="color:var(--color-text-sub);">${user.role} | ID: ${user.userId}</div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="form-label">Phone Number</label>
                        <input type="text" class="form-input" value="${user.mobile}" disabled style="background:#f1f5f9;">
                    </div>
                    <div class="input-group">
                        <label class="form-label">Password / PIN</label>
                        <input type="password" class="form-input" value="********" disabled style="background:#f1f5f9;">
                        <button class="btn btn-secondary btn-sm mt-2" onclick="alert('Password reset link sent to mobile.')">Change Password</button>
                    </div>
                </div>

                ${user.role === 'Student' ? `<div id="fee-panel-container"></div>` : ''}
            `;

            if (user.role === 'Student') {
                FinanceService.renderStudentFees(document.getElementById('fee-panel-container'));
            }
        };

    </script>
    <script>
        /* ======================================================================================
           MODULE 20: ANALYTICS & VISUALIZATION ENGINE
           ====================================================================================== */
        const AnalyticsService = {
            
            // 20.1 Render Attendance Chart (Student View)
            renderAttendanceStats: (container, userId) => {
                const attendance = DB.select('attendance', a => a.userId === userId);
                
                // Calculate Stats
                const total = attendance.length;
                const present = attendance.filter(a => a.status.includes('Present')).length;
                const percent = total === 0 ? 100 : Math.round((present / total) * 100);

                // Create Canvas
                const canvasId = 'att-chart-' + Utils.generateId('cvs');
                
                container.innerHTML = `
                    <div class="flex gap-4 mb-4">
                        <div class="card w-full" style="text-align:center; background:#f0f9ff; border:1px solid #bae6fd; margin:0;">
                            <h3 style="color:#0284c7; font-size:24px;">${percent}%</h3>
                            <div style="font-size:11px; font-weight:700;">OVERALL</div>
                        </div>
                        <div class="card w-full" style="text-align:center; background:#f0fdf4; border:1px solid #bbf7d0; margin:0;">
                            <h3 style="color:#16a34a; font-size:24px;">${present}/${total}</h3>
                            <div style="font-size:11px; font-weight:700;">DAYS PRESENT</div>
                        </div>
                    </div>
                    <div class="card" style="margin:0;">
                        <canvas id="${canvasId}" style="max-height:250px;"></canvas>
                    </div>
                `;

                // Render Chart if library exists
                setTimeout(() => {
                    if (window.Chart) {
                        const ctx = document.getElementById(canvasId).getContext('2d');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Present', 'Absent'],
                                datasets: [{
                                    data: [present, total - present],
                                    backgroundColor: ['#10b981', '#ef4444'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                               plugins: { legend: { position: 'bottom' } }
                            }
                        });
                    }
                }, 100);
            },

            // 20.2 Teacher View: Batch Performance Overview
            renderBatchAnalytics: (batchName, containerId) => {
                const students = DB.select('users', u => u.batch === batchName);
                const results = DB.select('results', r => students.some(s => s.userId === r.studentId));
                
                // Calculate Class Average
                let totalScore = 0;
                let maxScore = 0;
                results.forEach(r => {
                    const pct = (r.score / r.totalMarks) * 100;
                    totalScore += pct;
                    if(pct > maxScore) maxScore = pct;
                });
                const avg = results.length ? Math.round(totalScore / results.length) : 0;

                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="card" style="background:#1e293b; color:white;">
                        <div class="flex justify-between">
                            <div>
                                <div style="font-size:12px; opacity:0.7;">CLASS AVERAGE</div>
                                <div style="font-size:28px; font-weight:700;">${avg}%</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px; opacity:0.7;">HIGHEST SCORE</div>
                                <div style="font-size:28px; font-weight:700; color:var(--success);">${Math.round(maxScore)}%</div>
                            </div>
                        </div>
                        <div style="margin-top:15px; font-size:12px;">Based on ${results.length} exam submissions</div>
                    </div>
                `;
            }
        };

        /* ======================================================================================
           MODULE 21: SYSTEM SETTINGS & DATA MANAGEMENT
           ====================================================================================== */
        const SystemService = {
            
            // 21.1 Export Data (Backup)
            exportDatabase: () => {
                const data = {};
                // Gather all localstorage keys starting with ja_
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('ja_')) {
                        data[key] = JSON.parse(localStorage.getItem(key));
                    }
                });

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `Jalaram_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                Utils.showToast("System Backup Downloaded", "success");
            },

            // 21.2 Factory Reset
            factoryReset: () => {
                const code = prompt("Type 'DELETE' to confirm factory reset. This cannot be undone.");
                if (code === 'DELETE') {
                    localStorage.clear();
                    Utils.showToast("System Wiped. Rebooting...", "warning");
                    setTimeout(() => location.reload(), 2000);
                } else {
                    Utils.showToast("Reset Cancelled", "info");
                }
            },

            // 21.3 Theme Toggle (Simple)
            toggleDarkMode: () => {
                const body = document.body;
                // Simple implementation: toggle a class and save pref
                if (body.classList.contains('dark-mode')) {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('ja_theme', 'light');
                } else {
                    body.classList.add('dark-mode');
                    localStorage.setItem('ja_theme', 'dark');
                }
            }
        };

        /* ======================================================================================
           MODULE 22: ADVANCED TEACHER TOOLS (The "Quantum" Features)
           ====================================================================================== */
        const TeacherTools = {
            
            // 22.1 Quantum Broadcast (Urgent Alerts)
            sendBroadcast: () => {
                const msg = prompt("Enter Broadcast Message (Sent to ALL students):");
                if (!msg) return;

                const students = DB.select('users', u => u.role === 'Student');
                students.forEach(s => {
                    DB.insert('notifications', {
                        title: '‚ö†Ô∏è URGENT ANNOUNCEMENT',
                        message: msg,
                        targetBatch: s.batch,
                        readBy: [],
                        createdAt: new Date().toISOString()
                    });
                });

                Utils.showToast(`Broadcast sent to ${students.length} students.`, "success");
            },

            // 22.2 Promote Batch (End of Year)
            promoteBatch: (batchName) => {
                if (!confirm(`Promote all students in ${batchName} to next year?`)) return;

                const students = DB.select('users', u => u.batch === batchName);
                if (students.length === 0) return Utils.showToast("Batch is empty", "error");

                // Logic: 10->11, 11->12, 12->Alumni
                let nextBatch = batchName;
                if (batchName.includes('10')) nextBatch = batchName.replace('10', '11');
                else if (batchName.includes('11')) nextBatch = batchName.replace('11', '12');
                else if (batchName.includes('12')) nextBatch = 'Alumni ' + new Date().getFullYear();

                students.forEach(s => {
                    DB.update('users', s.userId, { batch: nextBatch });
                });

                Utils.showToast(`Promoted ${students.length} students to ${nextBatch}`, "success");
                RouterService.navigate('batches');
            },

            // 22.3 Generate ID Cards (Print View)
            generateIDCards: (batchName) => {
                const students = DB.select('users', u => u.batch === batchName);
                const win = window.open('', '_blank');
                win.document.write(`
                    <html><head><title>ID Cards - ${batchName}</title>
                    <style>
                        body { font-family: sans-serif; display: flex; flex-wrap: wrap; gap: 20px; padding: 20px; }
                        .card { width: 300px; height: 180px; border: 1px solid #ccc; padding: 20px; border-radius: 10px; display: flex; align-items: center; gap: 15px; page-break-inside: avoid; }
                        .photo { width: 80px; height: 80px; background: #ddd; border-radius: 50%; }
                    </style>
                    </head><body>
                    ${students.map(s => `
                        <div class="card">
                            <div class="photo"></div>
                            <div>
                                <h3>${s.name}</h3>
                                <p>ID: ${s.userId}</p>
                                <p>Batch: ${s.batch}</p>
                                <p>Jalaram Academy</p>
                            </div>
                        </div>
                    `).join('')}
                    <script>window.print();<\/script>
                    </body></html>
                `);
                win.document.close();
            }
        };

        // --- Extend PageControllers for Settings ---
        
        // This overwrites/extends the settings render to include the new buttons
        const originalRenderSettings = PageControllers.renderSettings;
        
        PageControllers.renderSettings = (container) => {
            // Call original profile render
            originalRenderSettings(container); 
            
            const user = AuthenticationService.currentUser;
            
            // Append System Actions
            const systemCard = document.createElement('div');
            systemCard.className = 'card';
            systemCard.innerHTML = `
                <div class="card-header"><span class="card-title">System & Data</span></div>
                <div class="flex flex-col gap-2">
                    <button class="btn btn-secondary w-full" onclick="SystemService.exportDatabase()">
                        <i class="material-icons">download</i> Backup My Data
                    </button>
                    ${user.role === 'Admin' ? `
                        <button class="btn btn-danger w-full" onclick="SystemService.factoryReset()">
                            <i class="material-icons">delete_forever</i> Factory Reset System
                        </button>
                    ` : ''}
                </div>
            `;
            container.appendChild(systemCard);

            // If Admin/Teacher, Show Advanced Tools
            if (user.role !== 'Student') {
                const toolsCard = document.createElement('div');
                toolsCard.className = 'card';
                toolsCard.innerHTML = `
                    <div class="card-header"><span class="card-title">Quantum Tools</span></div>
                    <div class="flex flex-col gap-2">
                        <button class="btn btn-primary w-full" onclick="TeacherTools.sendBroadcast()">
                            <i class="material-icons">campaign</i> Send Broadcast Alert
                        </button>
                        ${user.role === 'Teacher' ? `
                            <button class="btn btn-secondary w-full" onclick="TeacherTools.generateIDCards('${user.batch || 'Class 10-A'}')">
                                <i class="material-icons">badge</i> Print ID Cards
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(toolsCard);
            }
        };

    </script>
    <script>
        /* ======================================================================================
           MODULE 23: VISUAL EFFECTS & CELEBRATION ENGINE
           ====================================================================================== */
        const EffectsService = {
            
            // 23.1 Confetti Blast (For High Scores / Submissions)
            blastConfetti: () => {
                const canvas = document.getElementById('confetti-canvas');
                if (!canvas) {
                    const c = document.createElement('canvas');
                    c.id = 'confetti-canvas';
                    c.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:9999;';
                    document.body.appendChild(c);
                }
                
                const c = document.getElementById('confetti-canvas');
                const ctx = c.getContext('2d');
                c.width = window.innerWidth;
                c.height = window.innerHeight;
                c.style.display = 'block';

                const particles = [];
                const particleCount = 150;
                const gravity = 0.5;
                const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];

                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * c.width,
                        y: Math.random() * c.height - c.height,
                        vx: Math.random() * 4 - 2,
                        vy: Math.random() * 10 + 5,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        size: Math.random() * 8 + 2
                    });
                }

                function animate() {
                    ctx.clearRect(0, 0, c.width, c.height);
                    let active = 0;
                    particles.forEach(p => {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.1; // mild gravity drag
                        
                        if (p.y < c.height) {
                            ctx.fillStyle = p.color;
                            ctx.fillRect(p.x, p.y, p.size, p.size);
                            active++;
                        }
                    });

                    if (active > 0) requestAnimationFrame(animate);
                    else c.style.display = 'none';
                }
                animate();
            }
        };

        /* ======================================================================================
           MODULE 24: PRINT ENGINE & ID CARD GENERATOR
           ====================================================================================== */
        const PrintService = {
            
            // 24.1 Generate Student ID Card
            printIdCard: (user) => {
                const printWindow = window.open('', '', 'height=600,width=800');
                
                const html = `
                    <html>
                    <head>
                        <title>ID Card - ${user.name}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Plus Jakarta Sans', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f2f5; -webkit-print-color-adjust: exact; }
                            .id-card {
                                width: 350px; height: 520px; background: white; border-radius: 20px;
                                box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; position: relative; border: 1px solid #e0e0e0;
                            }
                            .header {
                                height: 140px; background: linear-gradient(135deg, #0f5bb8, #3b82f6);
                                display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
                            }
                            .logo { font-size: 40px; margin-bottom: 5px; }
                            .school-name { font-weight: 800; font-size: 20px; letter-spacing: 1px; text-transform: uppercase; }
                            
                            .avatar-container {
                                width: 120px; height: 120px; background: white; border-radius: 50%;
                                position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
                                display: flex; align-items: center; justify-content: center;
                                border: 5px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                            }
                            .avatar {
                                width: 100%; height: 100%; border-radius: 50%; background: #e2e8f0;
                                font-size: 48px; font-weight: 700; color: #475569; display: flex; align-items: center; justify-content: center;
                            }
                            
                            .content { margin-top: 70px; text-align: center; padding: 20px; }
                            .name { font-size: 24px; font-weight: 800; color: #0f172a; margin-bottom: 5px; }
                            .role { font-size: 14px; color: #0f5bb8; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
                            
                            .details { text-align: left; background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 10px; }
                            .row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; }
                            .label { color: #64748b; font-weight: 600; }
                            .val { color: #0f172a; font-weight: 700; }
                            
                            .footer {
                                position: absolute; bottom: 0; width: 100%; padding: 15px; text-align: center;
                                font-size: 10px; color: #94a3b8; border-top: 1px solid #f1f5f9;
                            }
                            .barcode { font-family: 'Libre Barcode 39', cursive; font-size: 32px; margin-top: 5px; color: #000; }
                        </style>
                    </head>
                    <body>
                        <div class="id-card">
                            <div class="header">
                                <div class="logo">üéì</div>
                                <div class="school-name">Jalaram Academy</div>
                            </div>
                            <div class="avatar-container">
                                <div class="avatar">${user.name.charAt(0)}</div>
                            </div>
                            <div class="content">
                                <div class="name">${user.name}</div>
                                <div class="role">${user.role}</div>
                                <div class="details">
                                    <div class="row"><span class="label">ID Number</span><span class="val">${user.userId}</span></div>
                                    <div class="row"><span class="label">Batch</span><span class="val">${user.batch || 'Staff'}</span></div>
                                    <div class="row"><span class="label">Contact</span><span class="val">${user.mobile}</span></div>
                                    <div class="row"><span class="label">Valid Thru</span><span class="val">Mar 2027</span></div>
                                </div>
                            </div>
                            <div class="footer">
                                <div>This card is property of Jalaram Academy.</div>
                                <div class="barcode">*${user.userId}*</div>
                            </div>
                        </div>
                        <script>
                            window.onload = function() { window.print(); window.close(); }
                        <\/script>
                    </body>
                    </html>
                `;
                
                printWindow.document.write(html);
                printWindow.document.close();
            }
        };

        // --- EXTEND TEACHER TOOLS TO USE PRINT SERVICE ---
        // Overwriting the previous generateIDCards function to use the new Engine
        TeacherTools.generateIDCards = (batchName) => {
            const students = DB.select('users', u => u.batch === batchName);
            if(students.length === 0) return Utils.showToast("No students in batch", "warning");
            
            // For batch print, we iterate. In real app, we'd make a grid layout page.
            // Here we print the first student as a demo of the engine capability.
            PrintService.printIdCard(students[0]);
            if(students.length > 1) Utils.showToast(`Previewing first ID card of ${students.length} students.`, "info");
        };

    </script>
    <script>
        /* ======================================================================================
           MODULE 25: QUANTUM SCHEDULER (Calendar Engine)
           ====================================================================================== */
        const SchedulerService = {
            currentDate: new Date(),

            // 25.1 Render Calendar UI
            renderCalendar: (container) => {
                const month = SchedulerService.currentDate.getMonth();
                const year = SchedulerService.currentDate.getFullYear();
                
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                
                // Header
                let html = `
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <button class="btn btn-sm btn-secondary" onclick="SchedulerService.changeMonth(-1)"><i class="material-icons">chevron_left</i></button>
                            <h3 style="font-weight:700; font-size:18px;">${monthNames[month]} ${year}</h3>
                            <button class="btn btn-sm btn-secondary" onclick="SchedulerService.changeMonth(1)"><i class="material-icons">chevron_right</i></button>
                        </div>
                        <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:5px; text-align:center;">
                            <div style="font-weight:700; font-size:12px; color:var(--text-sub);">Sun</div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-sub);">Mon</div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-sub);">Tue</div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-sub);">Wed</div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-sub);">Thu</div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-sub);">Fri</div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-sub);">Sat</div>
                `;

                // Days Logic
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Empty Slots
                for (let i = 0; i < firstDay; i++) {
                    html += `<div></div>`;
                }

                // Date Slots
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const events = SchedulerService.getEventsForDate(dateStr);
                    const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();

                    html += `
                        <div class="card" style="margin:0; min-height:60px; padding:5px; border:${isToday ? '2px solid var(--primary)' : '1px solid var(--border)'}; font-size:12px; text-align:left; position:relative;">
                            <div style="font-weight:700; margin-bottom:4px;">${day}</div>
                            <div style="display:flex; flex-direction:column; gap:2px;">
                                ${events.map(e => `
                                    <div style="background:${e.color}; color:white; padding:2px 4px; border-radius:4px; font-size:9px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                        ${e.title}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `</div></div>`; // Close grid and card
                
                // Add "Add Event" button for Teachers/Admins
                if (AuthenticationService.currentUser.role !== 'Student') {
                    html += `
                        <button class="btn btn-primary w-full mt-4" onclick="SchedulerService.addEventPrompt()">
                            + Schedule Class / Exam
                        </button>
                    `;
                }

                container.innerHTML = html;
            },

            // 25.2 Fetch Events from DB
            getEventsForDate: (dateStr) => {
                const events = [];
                
                // Check Exams
                const exams = DB.select('exams');
                exams.forEach(e => {
                    // Mocking exam date extraction (Assuming stored or random for demo)
                    // In real app, exam object has a 'date' field. 
                    // Here we check if the ID implies a date or just show random for demo vitality
                    if (Math.random() > 0.95) events.push({ title: 'Exam: ' + e.title, color: 'var(--danger)' }); 
                });

                // Check Holidays/Assignments (From Notifications)
                const notis = DB.select('notifications', n => n.dueDate === dateStr);
                notis.forEach(n => {
                    events.push({ title: 'Due: ' + n.title, color: 'var(--warning)' });
                });

                return events;
            },

            // 25.3 Navigation
            changeMonth: (step) => {
                SchedulerService.currentDate.setMonth(SchedulerService.currentDate.getMonth() + step);
                const container = document.getElementById('scheduler-container'); // Need to ensure container exists
                if (container) SchedulerService.renderCalendar(container);
            },

            // 25.4 Add Event Logic
            addEventPrompt: () => {
                const title = prompt("Event Title:");
                const date = prompt("Date (YYYY-MM-DD):");
                if (title && date) {
                    DB.insert('notifications', {
                        title: title,
                        message: "Scheduled Event",
                        dueDate: date,
                        targetBatch: 'All', // Simplified
                        type: 'event'
                    });
                    Utils.showToast("Event Added to Calendar", "success");
                    // Refresh
                    SchedulerService.changeMonth(0);
                }
            }
        };

        /* ======================================================================================
           MODULE 26: DOCUMENT GENERATOR (Receipts & Reports)
           ====================================================================================== */
        const DocumentService = {
            
            // 26.1 Generate Fee Receipt
            generateReceipt: (transactionIndex) => {
                const user = AuthenticationService.currentUser;
                const feeRecord = DB.findOne('fees', f => f.studentId === user.userId);
                
                if (!feeRecord || !feeRecord.history[transactionIndex]) return;
                
                const txn = feeRecord.history[transactionIndex];
                const receiptId = `RCPT-${Math.floor(Math.random()*100000)}`;

                const win = window.open('', '_blank');
                win.document.write(`
                    <html>
                    <head>
                        <title>Fee Receipt - ${receiptId}</title>
                        <style>
                            body { font-family: 'Courier New', monospace; padding: 40px; max-width: 800px; margin: 0 auto; }
                            .header { text-align: center; border-bottom: 2px dashed #333; padding-bottom: 20px; margin-bottom: 20px; }
                            .row { display: flex; justify-content: space-between; margin-bottom: 10px; }
                            .total { border-top: 2px dashed #333; border-bottom: 2px dashed #333; padding: 10px 0; margin-top: 20px; font-weight: bold; font-size: 1.2em; }
                            .footer { margin-top: 40px; text-align: center; font-size: 0.8em; }
                            .stamp { border: 3px double #0f5bb8; color: #0f5bb8; padding: 10px; display: inline-block; transform: rotate(-5deg); margin-top: 20px; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>JALARAM ACADEMY</h1>
                            <p>Excellence in Education Since 1990</p>
                            <p>Sector 4, Gandhinagar, Gujarat</p>
                        </div>
                        
                        <div class="row"><span>Receipt No:</span> <span>${receiptId}</span></div>
                        <div class="row"><span>Date:</span> <span>${Utils.formatDate(txn.date)}</span></div>
                        <div class="row"><span>Student Name:</span> <span>${user.name}</span></div>
                        <div class="row"><span>Student ID:</span> <span>${user.userId}</span></div>
                        
                        <br>
                        
                        <table style="width:100%; text-align:left;">
                            <tr>
                                <th>Description</th>
                                <th style="text-align:right;">Amount</th>
                            </tr>
                            <tr>
                                <td>Tuition Fees (Q4)</td>
                                <td style="text-align:right;">‚Çπ${txn.amount}</td>
                            </tr>
                        </table>
                        
                        <div class="row total">
                            <span>TOTAL PAID</span>
                            <span>‚Çπ${txn.amount}</span>
                        </div>
                        
                        <div style="text-align:center;">
                            <div class="stamp">PAID / CLEARED<br>${txn.method}</div>
                        </div>
                        
                        <div class="footer">
                            <p>This is a computer-generated receipt.</p>
                            <p>Authorized Signatory</p>
                        </div>
                        <script>window.print();<\/script>
                    </body>
                    </html>
                `);
                win.document.close();
            },

            // 26.2 Generate Report Card
            generateReportCard: (studentId) => {
                const user = DB.findOne('users', u => u.userId === studentId);
                const results = DB.select('results', r => r.studentId === studentId);
                
                let totalMarks = 0;
                let securedMarks = 0;
                results.forEach(r => {
                    totalMarks += r.totalMarks;
                    securedMarks += r.score;
                });
                
                const percentage = totalMarks ? ((securedMarks/totalMarks)*100).toFixed(2) : 0;

                const win = window.open('', '_blank');
                win.document.write(`
                    <html>
                    <head>
                        <title>Report Card - ${user.name}</title>
                        <style>
                            body { font-family: sans-serif; padding: 20px; border: 10px solid #0f5bb8; height: 90vh; }
                            .header { text-align: center; color: #0f5bb8; margin-bottom: 40px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
                            th { background: #eff6ff; }
                            .grade { font-size: 4em; font-weight: bold; color: #0f5bb8; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>JALARAM ACADEMY</h1>
                            <h3>Annual Performance Report</h3>
                        </div>
                        
                        <div style="display:flex; justify-content:space-between;">
                            <div>
                                <p><strong>Name:</strong> ${user.name}</p>
                                <p><strong>ID:</strong> ${user.userId}</p>
                                <p><strong>Batch:</strong> ${user.batch || 'N/A'}</p>
                            </div>
                            <div style="text-align:center;">
                                <div>Overall Grade</div>
                                <div class="grade">${percentage > 90 ? 'A+' : (percentage > 75 ? 'A' : 'B')}</div>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Subject / Exam</th>
                                    <th>Max Marks</th>
                                    <th>Obtained</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.map(r => `
                                    <tr>
                                        <td style="text-align:left;">${r.examTitle}</td>
                                        <td>${r.totalMarks}</td>
                                        <td>${r.score}</td>
                                        <td style="color:${(r.score/r.totalMarks) > 0.35 ? 'green' : 'red'}; font-weight:bold;">
                                            ${(r.score/r.totalMarks) > 0.35 ? 'PASS' : 'FAIL'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 50px; display:flex; justify-content:space-between;">
                            <div>Class Teacher</div>
                            <div>Principal</div>
                            <div>Parent</div>
                        </div>
                    </body>
                    </html>
                `);
                win.document.close();
            }
        };

        // --- Integrate Scheduler into PageControllers ---
        PageControllers.renderSchedule = (container) => {
            container.innerHTML = `<div id="scheduler-container"></div>`;
            SchedulerService.renderCalendar(document.getElementById('scheduler-container'));
        };

        // Add Schedule to Route Map (Extending Module 8)
        RouterService.routes['schedule'] = { title: 'Planner', icon: 'calendar_month', roles: ['Admin', 'Teacher', 'Student'] };

    </script>
    <script>
        /* ======================================================================================
           MODULE 27: SYSTEM BOOTSTRAPPER (Entry Point)
           ====================================================================================== */
        const AppInit = {
            
            // 27.1 Main Entry Function
            start: () => {
                console.log("%c Jalaram Academy v350 \n System Booting...", "color:#0f5bb8; font-weight:bold; font-size:16px;");

                // 1. Initialize Database Structure
                try {
                    DB.init();
                    console.log("‚úî Database Integrity Checked");
                } catch (e) {
                    console.error("Database Failure", e);
                    alert("Critical Error: Database could not initialize. Try clearing cache.");
                }

                // 2. Setup Global Event Listeners
                this.setupGlobalEvents();

                // 3. Check for Persisted Session (Optional Auto-Login)
                // For security in this demo, we default to the Login Screen (Part 1 Auth Layer).
                // If you wanted auto-login, you would check localStorage for a session token here.
                
                // 4. Pre-load Assets (Simulated)
                // In a real app, we might fetch config from a server here.
            },

            // 27.2 Global Event Handlers
            setupGlobalEvents: () => {
                // Close Modals on Escape Key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        ModalService.close();
                        if(ExamService.activeSession) {
                            // Prevent accidental exit from exam, maybe?
                            // Exam engine handles its own state.
                        } else {
                            // Close overlays
                            document.getElementById('video-engine-layer').style.display = 'none';
                        }
                    }
                });

                // Global Error Catcher
                window.onerror = function (msg, url, lineNo, columnNo, error) {
                    // Prevent alerting the user for minor non-fatal errors
                    console.error('System Logic Error:', msg, error);
                    // Only toast if Utils is ready
                    if (window.Utils) {
                        Utils.showToast('System Alert: Operation may have failed.', 'error');
                    }
                    return false;
                };
                
                // Network State Listeners
                window.addEventListener('offline', () => Utils.showToast("You are offline. Data will sync later.", "warning"));
                window.addEventListener('online', () => Utils.showToast("Back online.", "success"));
            }
        };

        // --- FIRE THE ENGINE ---
        window.addEventListener('DOMContentLoaded', AppInit.start);

    </script>
</body>
</html>
